-- Universal ESP with Mission Hunter GUI
-- Logic: Players = Native Health Bar (AlwaysOn) | NPCs = Custom Green Bar
-- Keybind: F4 to Toggle Menu

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

-- Configuration (Linked to GUI)
local Config = {
    Enabled = true,
    ShowNames = true,
    ShowNPCBars = true,
    MaxDistance = 1500,
    TextSize = 14,
    BarWidth = 100,
    BarHeight = 6,
    YOffset = 60
}

-- State
local ESP_Cache = {}
local LiveFolder = workspace:FindFirstChild("Live")

--------------------------------------------------------------------------------
-- 1. GUI CONSTRUCTION (Mission Hunter Style)
--------------------------------------------------------------------------------

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MissionHunterESP"
ScreenGui.ResetOnSpawn = false

-- Attempt to put in CoreGui (secure) or PlayerGui
if gethui then
    ScreenGui.Parent = gethui()
elseif game:GetService("RunService"):IsStudio() then
    ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
else
    pcall(function() ScreenGui.Parent = CoreGui end)
    if not ScreenGui.Parent then ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui") end
end

-- Main Window
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 420, 0, 340)
MainFrame.Position = UDim2.new(0.5, -210, 0.5, -170)
MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
MainFrame.BorderSizePixel = 1
MainFrame.BorderColor3 = Color3.fromRGB(40, 40, 40)
MainFrame.Visible = true
MainFrame.Parent = ScreenGui

-- Header (Draggable)
local Header = Instance.new("Frame")
Header.Name = "Header"
Header.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
Header.BorderSizePixel = 0
Header.Size = UDim2.new(1, 0, 0, 30)
Header.Parent = MainFrame

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Text = "Mission Hunter ESP"
TitleLabel.Font = Enum.Font.Code
TitleLabel.TextSize = 14
TitleLabel.TextColor3 = Color3.fromRGB(0, 120, 255)
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.BackgroundTransparency = 1
TitleLabel.Position = UDim2.new(0, 10, 0, 0)
TitleLabel.Size = UDim2.new(1, -20, 1, 0)
TitleLabel.Parent = Header

-- Drag Logic
local dragging, dragInput, dragStart, startPos
Header.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then dragging = false end
        end)
    end
end)
Header.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end
end)
UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- Content Area
local ContentArea = Instance.new("Frame")
ContentArea.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
ContentArea.BorderSizePixel = 0
ContentArea.Position = UDim2.new(0, 10, 0, 40)
ContentArea.Size = UDim2.new(1, -20, 1, -50)
ContentArea.Parent = MainFrame

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Parent = ContentArea
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0, 8)

local Pad = Instance.new("Frame")
Pad.Size = UDim2.new(1,0,0,5)
Pad.BackgroundTransparency = 1
Pad.LayoutOrder = 0
Pad.Parent = ContentArea

-- Helper Functions for GUI Elements
local function CreateToggle(text, configKey)
    local container = Instance.new("Frame")
    container.BackgroundTransparency = 1
    container.Size = UDim2.new(1, 0, 0, 24)
    container.LayoutOrder = 1
    container.Parent = ContentArea
    
    local btn = Instance.new("TextButton")
    btn.Text = ""
    btn.BackgroundColor3 = Config[configKey] and Color3.fromRGB(0, 120, 255) or Color3.fromRGB(40, 40, 40)
    btn.BorderSizePixel = 0
    btn.Position = UDim2.new(0, 5, 0, 4)
    btn.Size = UDim2.new(0, 16, 0, 16)
    btn.Parent = container
    
    local lbl = Instance.new("TextLabel")
    lbl.Text = text
    lbl.Font = Enum.Font.SourceSans
    lbl.TextSize = 16
    lbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.BackgroundTransparency = 1
    lbl.Position = UDim2.new(0, 30, 0, 0)
    lbl.Size = UDim2.new(1, -30, 1, 0)
    lbl.Parent = container
    
    btn.MouseButton1Click:Connect(function()
        Config[configKey] = not Config[configKey]
        btn.BackgroundColor3 = Config[configKey] and Color3.fromRGB(0, 120, 255) or Color3.fromRGB(40, 40, 40)
    end)
end

local function CreateSlider(text, configKey, min, max)
    local container = Instance.new("Frame")
    container.BackgroundTransparency = 1
    container.Size = UDim2.new(1, 0, 0, 50)
    container.LayoutOrder = 2
    container.Parent = ContentArea
    
    local lbl = Instance.new("TextLabel")
    lbl.Text = text
    lbl.Font = Enum.Font.SourceSans
    lbl.TextSize = 16
    lbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.BackgroundTransparency = 1
    lbl.Position = UDim2.new(0, 5, 0, 0)
    lbl.Size = UDim2.new(1, -10, 0, 20)
    lbl.Parent = container
    
    local sliderBg = Instance.new("Frame")
    sliderBg.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    sliderBg.BorderColor3 = Color3.fromRGB(50, 50, 50)
    sliderBg.BorderSizePixel = 1
    sliderBg.Position = UDim2.new(0, 5, 0, 25)
    sliderBg.Size = UDim2.new(1, -10, 0, 20)
    sliderBg.Parent = container
    
    local sliderFill = Instance.new("Frame")
    sliderFill.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
    sliderFill.BorderSizePixel = 0
    sliderFill.Size = UDim2.new((Config[configKey] - min) / (max - min), 0, 1, 0)
    sliderFill.Parent = sliderBg
    
    local valueLbl = Instance.new("TextLabel")
    valueLbl.Text = tostring(Config[configKey])
    valueLbl.Font = Enum.Font.Code
    valueLbl.TextSize = 14
    valueLbl.TextColor3 = Color3.fromRGB(255, 255, 255)
    valueLbl.BackgroundTransparency = 1
    valueLbl.Size = UDim2.new(1, 0, 1, 0)
    valueLbl.ZIndex = 2
    valueLbl.Parent = sliderBg
    
    local draggingSlider = false
    local function Update(input)
        local pos = input.Position.X
        local boxPos = sliderBg.AbsolutePosition.X
        local boxSize = sliderBg.AbsoluteSize.X
        local relative = math.clamp((pos - boxPos) / boxSize, 0, 1)
        local newVal = math.floor(min + (max - min) * relative)
        Config[configKey] = newVal
        sliderFill.Size = UDim2.new(relative, 0, 1, 0)
        valueLbl.Text = tostring(newVal)
    end
    
    sliderBg.InputBegan:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 then draggingSlider = true; Update(input) end end)
    UserInputService.InputEnded:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 then draggingSlider = false end end)
    UserInputService.InputChanged:Connect(function(input) if draggingSlider and input.UserInputType == Enum.UserInputType.MouseMovement then Update(input) end end)
end

-- Create GUI Items
CreateToggle("Master Enabled", "Enabled")
CreateToggle("Show Names (All)", "ShowNames")
CreateToggle("Show NPC Bars", "ShowNPCBars")
CreateSlider("Max Distance", "MaxDistance", 100, 5000)

--------------------------------------------------------------------------------
-- 2. ESP SYSTEM
--------------------------------------------------------------------------------

local function CreateDrawing(type, props)
    local obj = Drawing.new(type)
    for k, v in pairs(props) do obj[k] = v end
    return obj
end

local function RemoveESP(model)
    if ESP_Cache[model] then
        for _, drawing in pairs(ESP_Cache[model].Drawings) do
            drawing:Remove()
        end
        ESP_Cache[model] = nil
    end
end

RunService.RenderStepped:Connect(function()
    if not Config.Enabled then 
        for model, _ in pairs(ESP_Cache) do RemoveESP(model) end
        return 
    end

    if not LiveFolder then LiveFolder = workspace:FindFirstChild("Live") return end

    -- Mark current items for potential cleanup
    for _, entry in pairs(ESP_Cache) do entry.Seen = false end

    -- Scan Live Folder
    for _, folder in ipairs(LiveFolder:GetChildren()) do
        local model = folder:IsA("Model") and folder or folder:FindFirstChildWhichIsA("Model")
        
        -- IGNORE LOCAL PLAYER FOR DRAWINGS
        if model then
            
            local head = model:FindFirstChild("Head")
            local humanoid = model:FindFirstChild("Humanoid")

            -- === PLAYER LOGIC (AlwaysOn Health Bar) ===
            local player = Players:GetPlayerFromCharacter(model)
            
            -- CRITICAL: CHECK IF HUMAN EXIST AND SET DISPLAY TYPE
            if player and humanoid then
                pcall(function()
                     humanoid.HealthDisplayType = Enum.HumanoidHealthDisplayType.AlwaysOn
                end)
            end

            -- === DRAWING LOGIC (Name + NPC Bars) ===
            -- Skip Local Player for Drawing entirely
            if model ~= LocalPlayer.Character and head and humanoid then
                
                if not ESP_Cache[model] then
                    ESP_Cache[model] = {
                        Seen = true,
                        Drawings = {
                            Name = CreateDrawing("Text", {Center = true, Outline = true, Color = Color3.new(1,1,1), Size = Config.TextSize}),
                            -- NPC Bar Elements
                            BarBg = CreateDrawing("Square", {Filled = true, Color = Color3.new(0.1,0.1,0.1), Transparency = 0.8}),
                            BarFill = CreateDrawing("Square", {Filled = true, Transparency = 1}),
                        }
                    }
                end

                local entry = ESP_Cache[model]
                entry.Seen = true
                local d = entry.Drawings

                local vector, onScreen = Camera:WorldToViewportPoint(head.Position)
                local distance = (Camera.CFrame.Position - head.Position).Magnitude

                if onScreen and distance <= Config.MaxDistance then
                    local isNPC = not player -- If not a player, it's an NPC
                    
                    local screenPos = Vector2.new(vector.X, vector.Y)
                    local startY = screenPos.Y - Config.YOffset - (1000/distance)

                    -- 1. NAME (Players + NPCs)
                    if Config.ShowNames then
                        d.Name.Visible = true
                        local cleanName = model.Name
                        if isNPC then cleanName = cleanName:gsub("^NPC_", "") end
                        d.Name.Text = cleanName
                        d.Name.Position = screenPos - Vector2.new(0, Config.YOffset + 15)
                    else
                        d.Name.Visible = false
                    end

                    -- 2. HEALTH BAR (NPCs ONLY)
                    -- Players use Native, so we hide these drawings for them
                    if isNPC and Config.ShowNPCBars then
                        local barPos = Vector2.new(screenPos.X - (Config.BarWidth / 2), startY)
                        local hp = humanoid.Health
                        local max = humanoid.MaxHealth
                        local pct = math.clamp(hp / max, 0, 1)

                        d.BarBg.Visible = true
                        d.BarBg.Size = Vector2.new(Config.BarWidth, Config.BarHeight)
                        d.BarBg.Position = barPos

                        d.BarFill.Visible = true
                        d.BarFill.Size = Vector2.new(Config.BarWidth * pct, Config.BarHeight)
                        d.BarFill.Position = barPos
                        d.BarFill.Color = Color3.new(0.2, 0.9, 0.2) -- Green for NPCs
                    else
                        d.BarBg.Visible = false
                        d.BarFill.Visible = false
                    end
                else
                    for _, v in pairs(d) do v.Visible = false end
                end
            end
        end
    end

    -- Cleanup
    for model, entry in pairs(ESP_Cache) do
        if not entry.Seen or not model.Parent then
            RemoveESP(model)
        end
    end
end)

UserInputService.InputBegan:Connect(function(input, processed)
    if not processed and input.KeyCode == Enum.KeyCode.F4 then
        MainFrame.Visible = not MainFrame.Visible
    end
end)

print("Mission Hunter ESP Loaded.")