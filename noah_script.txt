-- Universal ESP with Mission Hunter GUI + AutoParry (Animation Fetch) + No Stun + Anti-Anchor
-- Logic: Players = Native Health Bar + Custom Red/Yellow Bars with Values + Walkspeed Multiplier
-- NPCs = Custom Green Bar (Toggleable) - Names hidden
-- No Stun: Prevents walkspeed from dropping below base speed
-- Animation Fetch: Get animation IDs from nearest target
-- Anti-Anchor: Prevents being anchored by moves
-- Keybind: F4 to Toggle Menu

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer
local VirtualInputManager = game:GetService("VirtualInputManager")
local StarterGui = game:GetService("StarterGui")
local SoundService = game:GetService("SoundService")

-- Configuration (Default Settings)
local Config = {
    Enabled = true,
    ShowNames = true,
    ShowBars = true,
    ShowNPCs = true,
    ShowValues = true,
    ShowWalkspeed = true,
    WalkspeedMultiplier = 1.0,
    MaxDistance = 1500,
    TextSize = 14,
    BarWidth = 150,
    BarHeight = 6,
    YOffset = 60,
    
    -- AutoParry Settings
    AutoParryEnabled = false,
    ParryAnimations = {},
    ParryDelay = 0.1,
    ParryKey = "F",
    
    -- Animation Fetch Settings
    FetchAnimationsEnabled = false,
    FetchFromTarget = true,
    FetchedAnimations = {},
    AutoAddFetched = false,
    
    -- No Stun Settings
    NoStunEnabled = false,
    MinWalkspeed = 16,
    
    -- Anti-Anchor Settings
    AntiAnchorEnabled = false
}

-- State
local ESP_Cache = {}
local LiveFolder = workspace:FindFirstChild("Live")
local Configs = {}
local CurrentConfig = "Default"
local BaseWalkspeed = 16
local WalkspeedUpdateConnection = nil
local NoStunConnection = nil
local AntiAnchorConnection = nil

-- AutoParry State
local ParryConnection = nil
local CurrentAnimations = {}
local DetectedAttacks = {}

-- Animation Fetch State
local CurrentTarget = nil
local FetchConnection = nil
local FetchedAnimationList = {}

-- Config file path
local ConfigFolder = "MissionHunterESP"
local ConfigFile = "configs.json"

-- Function to get the WalkSpeed attribute from humanoid
local function GetBaseWalkspeedFromAttribute(humanoid)
    local attrSpeed = humanoid:GetAttribute("WalkSpeed")
    if attrSpeed then
        return attrSpeed
    end
    return humanoid.WalkSpeed
end

-- Function to consistently apply walkspeed multiplier
local function ApplyWalkspeedMultiplier()
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return end
    
    if Config.ShowWalkspeed then
        local baseSpeed = GetBaseWalkspeedFromAttribute(humanoid)
        local targetSpeed = baseSpeed * Config.WalkspeedMultiplier
        
        if math.abs(humanoid.WalkSpeed - targetSpeed) > 0.1 then
            humanoid.WalkSpeed = targetSpeed
        end
    end
end

-- Start monitoring walkspeed changes
local function StartWalkspeedMonitoring()
    if WalkspeedUpdateConnection then
        WalkspeedUpdateConnection:Disconnect()
        WalkspeedUpdateConnection = nil
    end
    
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return end
    
    BaseWalkspeed = GetBaseWalkspeedFromAttribute(humanoid)
    
    local attributeConnection = humanoid:GetAttributeChangedSignal("WalkSpeed"):Connect(function()
        task.wait(0.1)
        BaseWalkspeed = GetBaseWalkspeedFromAttribute(humanoid)
        if Config.ShowWalkspeed then
            ApplyWalkspeedMultiplier()
        end
    end)
    
    WalkspeedUpdateConnection = RunService.RenderStepped:Connect(function()
        if not Config.Enabled then return end
        
        local currentChar = LocalPlayer.Character
        if not currentChar then return end
        
        local currentHumanoid = currentChar:FindFirstChild("Humanoid")
        if not currentHumanoid then return end
        
        local currentBase = GetBaseWalkspeedFromAttribute(currentHumanoid)
        
        if math.abs(currentBase - BaseWalkspeed) > 0.1 then
            BaseWalkspeed = currentBase
        end
        
        -- Apply walkspeed multiplier if enabled
        if Config.ShowWalkspeed then
            local targetSpeed = BaseWalkspeed * Config.WalkspeedMultiplier
            if math.abs(currentHumanoid.WalkSpeed - targetSpeed) > 0.1 then
                currentHumanoid.WalkSpeed = targetSpeed
            end
        end
        
        -- Apply No Stun if enabled
        if Config.NoStunEnabled then
            local minSpeed = Config.MinWalkspeed
            if Config.ShowWalkspeed then
                minSpeed = BaseWalkspeed * Config.WalkspeedMultiplier
            end
            
            if currentHumanoid.WalkSpeed < minSpeed - 0.1 then
                currentHumanoid.WalkSpeed = minSpeed
            end
        end
        
        -- Apply Anti-Anchor if enabled
        if Config.AntiAnchorEnabled and currentChar then
            if currentChar.Anchored then
                currentChar.Anchored = false
                print("‚öì Anti-Anchor: Freed from anchor")
            end
            
            -- Check all parts in character
            for _, part in ipairs(currentChar:GetDescendants()) do
                if part:IsA("BasePart") and part.Anchored then
                    part.Anchored = false
                    print("‚öì Anti-Anchor: Freed part " .. part.Name)
                end
            end
        end
    end)
    
    character.AncestryChanged:Connect(function()
        if not character.Parent then
            if attributeConnection then
                attributeConnection:Disconnect()
            end
        end
    end)
end

-- Handle character respawns
local function OnCharacterAdded(character)
    local humanoid = character:WaitForChild("Humanoid")
    
    task.wait(0.1)
    
    BaseWalkspeed = GetBaseWalkspeedFromAttribute(humanoid)
    
    if Config.ShowWalkspeed then
        humanoid.WalkSpeed = BaseWalkspeed * Config.WalkspeedMultiplier
    end
    
    StartWalkspeedMonitoring()
    
    humanoid.AncestryChanged:Connect(function()
        task.wait(0.1)
        if not humanoid.Parent then
            task.wait(0.5)
            OnCharacterAdded(character)
        end
    end)
end

-- Connect character events
LocalPlayer.CharacterAdded:Connect(OnCharacterAdded)

if LocalPlayer.Character then
    OnCharacterAdded(LocalPlayer.Character)
end

-- Function to find nearest target
local function GetNearestTarget()
    local character = LocalPlayer.Character
    if not character then return nil end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso") or character:FindFirstChild("UpperTorso")
    if not rootPart then return nil end
    
    local nearestDist = math.huge
    local nearestPlayer = nil
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local targetChar = player.Character
            if targetChar and targetChar:FindFirstChild("Humanoid") and targetChar.Humanoid.Health > 0 then
                local targetRoot = targetChar:FindFirstChild("HumanoidRootPart") or targetChar:FindFirstChild("Torso") or targetChar:FindFirstChild("UpperTorso")
                if targetRoot then
                    local dist = (rootPart.Position - targetRoot.Position).Magnitude
                    if dist < nearestDist then
                        nearestDist = dist
                        nearestPlayer = player
                    end
                end
            end
        end
    end
    
    return nearestPlayer
end

-- Function to fetch animations from target
local function FetchAnimationsFromTarget(target)
    if not target then return end
    
    local targetChar = target.Character
    if not targetChar then return end
    
    local humanoid = targetChar:FindFirstChild("Humanoid")
    if not humanoid then return end
    
    local animator = humanoid:FindFirstChildOfClass("Animator")
    if not animator then return end
    
    local fetched = {}
    local newAnimations = 0
    
    -- Get currently playing animations
    for _, track in pairs(animator:GetPlayingAnimationTracks()) do
        local animId = track.Animation.AnimationId
        if animId and animId ~= "" then
            -- Check if already in list
            local alreadyExists = false
            for _, savedId in ipairs(Config.ParryAnimations) do
                if savedId == animId then
                    alreadyExists = true
                    break
                end
            end
            
            if not alreadyExists then
                table.insert(fetched, animId)
                newAnimations = newAnimations + 1
                
                -- Auto add if enabled
                if Config.AutoAddFetched then
                    table.insert(Config.ParryAnimations, animId)
                end
            end
        end
    end
    
    -- Update fetched list
    FetchedAnimationList = fetched
    
    if newAnimations > 0 then
        SendNotification(
            "üì• Animations Fetched",
            "Found " .. newAnimations .. " new animations from " .. target.Name,
            3
        )
        
        -- Save if auto-add is enabled
        if Config.AutoAddFetched then
            SaveConfigs()
            print("‚úÖ Auto-added " .. newAnimations .. " animations from " .. target.Name)
        end
    end
    
    return fetched
end

-- Start animation fetching
local function StartAnimationFetching()
    if FetchConnection then
        FetchConnection:Disconnect()
        FetchConnection = nil
    end
    
    if not Config.FetchAnimationsEnabled then return end
    
    print("üîÑ Animation Fetching Started")
    
    FetchConnection = RunService.Heartbeat:Connect(function()
        if not Config.FetchAnimationsEnabled then return end
        
        if Config.FetchFromTarget then
            local target = GetNearestTarget()
            if target and target ~= CurrentTarget then
                CurrentTarget = target
                FetchAnimationsFromTarget(target)
            end
        end
    end)
end

-- Function to save configs to file
local function SaveConfigs()
    local success, err = pcall(function()
        local data = {
            CurrentConfig = CurrentConfig,
            Configs = Configs
        }
        writefile(ConfigFolder .. "/" .. ConfigFile, HttpService:JSONEncode(data))
    end)
    if not success then
        warn("Failed to save configs: " .. tostring(err))
    end
end

-- Function to load configs from file
local function LoadConfigs()
    local success, err = pcall(function()
        if isfile(ConfigFolder .. "/" .. ConfigFile) then
            local data = HttpService:JSONDecode(readfile(ConfigFolder .. "/" .. ConfigFile))
            CurrentConfig = data.CurrentConfig or "Default"
            Configs = data.Configs or {}
            
            if Configs[CurrentConfig] then
                for k, v in pairs(Configs[CurrentConfig]) do
                    Config[k] = v
                end
            end
        else
            Configs["Default"] = {
                Enabled = true,
                ShowNames = true,
                ShowBars = true,
                ShowNPCs = true,
                ShowValues = true,
                ShowWalkspeed = true,
                WalkspeedMultiplier = 1.0,
                MaxDistance = 1500,
                TextSize = 14,
                BarWidth = 150,
                BarHeight = 6,
                YOffset = 60,
                AutoParryEnabled = false,
                ParryAnimations = {},
                ParryDelay = 0.1,
                ParryKey = "F",
                FetchAnimationsEnabled = false,
                FetchFromTarget = true,
                FetchedAnimations = {},
                AutoAddFetched = false,
                NoStunEnabled = false,
                MinWalkspeed = 16,
                AntiAnchorEnabled = false
            }
            CurrentConfig = "Default"
            SaveConfigs()
        end
    end)
    if not success then
        warn("Failed to load configs: " .. tostring(err))
    end
end

-- Load configs at startup and apply multiplier
LoadConfigs()
ApplyWalkspeedMultiplier()
StartAnimationFetching()

--------------------------------------------------------------------------------
-- 1. GUI CONSTRUCTION
--------------------------------------------------------------------------------

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MissionHunterESP"
ScreenGui.ResetOnSpawn = false

if gethui then
    ScreenGui.Parent = gethui()
elseif game:GetService("RunService"):IsStudio() then
    ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
else
    pcall(function() ScreenGui.Parent = CoreGui end)
    if not ScreenGui.Parent then ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui") end
end

-- Main Container
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 500, 0, 700) -- Made larger for new features
MainFrame.Position = UDim2.new(0, 20, 0, 25)
MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
MainFrame.BorderSizePixel = 1
MainFrame.BorderColor3 = Color3.fromRGB(40, 40, 40)
MainFrame.Visible = true
MainFrame.Parent = ScreenGui

-- Header
local Header = Instance.new("Frame")
Header.Name = "Header"
Header.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
Header.BorderSizePixel = 0
Header.Size = UDim2.new(1, 0, 0, 30)
Header.Parent = MainFrame

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Text = "Mission Hunter ESP + AutoParry + No Stun + Animation Fetch"
TitleLabel.Font = Enum.Font.Code
TitleLabel.TextSize = 14
TitleLabel.TextColor3 = Color3.fromRGB(0, 120, 255)
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.BackgroundTransparency = 1
TitleLabel.Position = UDim2.new(0, 10, 0, 0)
TitleLabel.Size = UDim2.new(1, -20, 1, 0)
TitleLabel.Parent = Header

-- Drag Logic
local dragging, dragInput, dragStart, startPos
Header.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then dragging = false end
        end)
    end
end)
Header.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end
end)
UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- Tab Buttons
local TabButtons = Instance.new("Frame")
TabButtons.Name = "TabButtons"
TabButtons.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
TabButtons.BorderSizePixel = 0
TabButtons.Position = UDim2.new(0, 0, 0, 30)
TabButtons.Size = UDim2.new(1, 0, 0, 25)
TabButtons.Parent = MainFrame

local MainTabBtn = Instance.new("TextButton")
MainTabBtn.Text = "Main"
MainTabBtn.Font = Enum.Font.SourceSans
MainTabBtn.TextSize = 16
MainTabBtn.TextColor3 = Color3.fromRGB(0, 120, 255)
MainTabBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainTabBtn.BorderSizePixel = 0
MainTabBtn.Position = UDim2.new(0, 0, 0, 0)
MainTabBtn.Size = UDim2.new(0, 80, 1, 0)
MainTabBtn.Parent = TabButtons

local AutoParryTabBtn = Instance.new("TextButton")
AutoParryTabBtn.Text = "Parry"
AutoParryTabBtn.Font = Enum.Font.SourceSans
AutoParryTabBtn.TextSize = 16
AutoParryTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
AutoParryTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
AutoParryTabBtn.BorderSizePixel = 0
AutoParryTabBtn.Position = UDim2.new(0, 80, 0, 0)
AutoParryTabBtn.Size = UDim2.new(0, 80, 1, 0)
AutoParryTabBtn.Parent = TabButtons

local FetchTabBtn = Instance.new("TextButton")
FetchTabBtn.Text = "Fetch"
FetchTabBtn.Font = Enum.Font.SourceSans
FetchTabBtn.TextSize = 16
FetchTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
FetchTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
FetchTabBtn.BorderSizePixel = 0
FetchTabBtn.Position = UDim2.new(0, 160, 0, 0)
FetchTabBtn.Size = UDim2.new(0, 80, 1, 0)
FetchTabBtn.Parent = TabButtons

local NoStunTabBtn = Instance.new("TextButton")
NoStunTabBtn.Text = "No Stun"
NoStunTabBtn.Font = Enum.Font.SourceSans
NoStunTabBtn.TextSize = 16
NoStunTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
NoStunTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
NoStunTabBtn.BorderSizePixel = 0
NoStunTabBtn.Position = UDim2.new(0, 240, 0, 0)
NoStunTabBtn.Size = UDim2.new(0, 80, 1, 0)
NoStunTabBtn.Parent = TabButtons

local ConfigTabBtn = Instance.new("TextButton")
ConfigTabBtn.Text = "Config"
ConfigTabBtn.Font = Enum.Font.SourceSans
ConfigTabBtn.TextSize = 16
ConfigTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
ConfigTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
ConfigTabBtn.BorderSizePixel = 0
ConfigTabBtn.Position = UDim2.new(0, 320, 0, 0)
ConfigTabBtn.Size = UDim2.new(0, 80, 1, 0)
ConfigTabBtn.Parent = TabButtons

-- Content Area
local ContentArea = Instance.new("ScrollingFrame")
ContentArea.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
ContentArea.BorderSizePixel = 0
ContentArea.Position = UDim2.new(0, 10, 0, 65)
ContentArea.Size = UDim2.new(1, -20, 1, -75)
ContentArea.CanvasSize = UDim2.new(0, 0, 0, 0)
ContentArea.ScrollBarThickness = 8
ContentArea.ScrollBarImageColor3 = Color3.fromRGB(0, 120, 255)
ContentArea.AutomaticCanvasSize = Enum.AutomaticSize.Y
ContentArea.Parent = MainFrame

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Parent = ContentArea
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0, 8)

-- Helper functions
local function ClearContent()
    for _, child in pairs(ContentArea:GetChildren()) do
        if child:IsA("Frame") or child:IsA("TextLabel") or child:IsA("TextBox") or child:IsA("TextButton") or child:IsA("ScrollingFrame") then
            child:Destroy()
        end
    end
end

local function SendNotification(title, text, duration, icon)
    StarterGui:SetCore("SendNotification", {
        Title = title,
        Text = text,
        Duration = duration or 5,
        Icon = icon or "rbxasset://textures/ui/GameSettings/GFX/icon_alert.png"
    })
end

local function CreateToggle(text, configKey, container)
    local container = container or ContentArea
    
    local toggleFrame = Instance.new("Frame")
    toggleFrame.BackgroundTransparency = 1
    toggleFrame.Size = UDim2.new(1, 0, 0, 24)
    toggleFrame.LayoutOrder = 1
    toggleFrame.Parent = container
    
    local btn = Instance.new("TextButton")
    btn.Text = ""
    btn.BackgroundColor3 = Config[configKey] and Color3.fromRGB(0, 120, 255) or Color3.fromRGB(40, 40, 40)
    btn.BorderSizePixel = 0
    btn.Position = UDim2.new(0, 5, 0, 4)
    btn.Size = UDim2.new(0, 16, 0, 16)
    btn.Parent = toggleFrame
    
    local lbl = Instance.new("TextLabel")
    lbl.Text = text
    lbl.Font = Enum.Font.SourceSans
    lbl.TextSize = 16
    lbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.BackgroundTransparency = 1
    lbl.Position = UDim2.new(0, 30, 0, 0)
    lbl.Size = UDim2.new(1, -30, 1, 0)
    lbl.Parent = toggleFrame
    
    btn.MouseButton1Click:Connect(function()
        Config[configKey] = not Config[configKey]
        btn.BackgroundColor3 = Config[configKey] and Color3.fromRGB(0, 120, 255) or Color3.fromRGB(40, 40, 40)
        
        -- Special handling for toggles
        if configKey == "AutoParryEnabled" then
            if Config.AutoParryEnabled then
                StartAutoParry()
            else
                StopAutoParry()
            end
        elseif configKey == "FetchAnimationsEnabled" then
            if Config.FetchAnimationsEnabled then
                StartAnimationFetching()
            else
                if FetchConnection then
                    FetchConnection:Disconnect()
                    FetchConnection = nil
                end
            end
        elseif configKey == "ShowWalkspeed" then
            if Config.ShowWalkspeed then
                ApplyWalkspeedMultiplier()
                StartWalkspeedMonitoring()
            else
                local character = LocalPlayer.Character
                if character then
                    local humanoid = character:FindFirstChild("Humanoid")
                    if humanoid then
                        humanoid.WalkSpeed = GetBaseWalkspeedFromAttribute(humanoid)
                    end
                end
            end
        end
        
        SaveConfigs()
    end)
end

local function CreateSlider(text, configKey, min, max, container, isFloat, callback)
    local container = container or ContentArea
    
    local sliderFrame = Instance.new("Frame")
    sliderFrame.BackgroundTransparency = 1
    sliderFrame.Size = UDim2.new(1, 0, 0, 50)
    sliderFrame.LayoutOrder = 2
    sliderFrame.Parent = container
    
    local lbl = Instance.new("TextLabel")
    lbl.Text = text
    lbl.Font = Enum.Font.SourceSans
    lbl.TextSize = 16
    lbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.BackgroundTransparency = 1
    lbl.Position = UDim2.new(0, 5, 0, 0)
    lbl.Size = UDim2.new(1, -10, 0, 20)
    lbl.Parent = sliderFrame
    
    local sliderBg = Instance.new("Frame")
    sliderBg.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    sliderBg.BorderColor3 = Color3.fromRGB(50, 50, 50)
    sliderBg.BorderSizePixel = 1
    sliderBg.Position = UDim2.new(0, 5, 0, 25)
    sliderBg.Size = UDim2.new(1, -10, 0, 20)
    sliderBg.Parent = sliderFrame
    
    local sliderFill = Instance.new("Frame")
    sliderFill.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
    sliderFill.BorderSizePixel = 0
    sliderFill.Size = UDim2.new((Config[configKey] - min) / (max - min), 0, 1, 0)
    sliderFill.Parent = sliderBg
    
    local valueLbl = Instance.new("TextLabel")
    valueLbl.Text = isFloat and string.format("%.2f", Config[configKey]) or tostring(Config[configKey])
    valueLbl.Font = Enum.Font.Code
    valueLbl.TextSize = 14
    valueLbl.TextColor3 = Color3.fromRGB(255, 255, 255)
    valueLbl.BackgroundTransparency = 1
    valueLbl.Size = UDim2.new(1, 0, 1, 0)
    valueLbl.ZIndex = 2
    valueLbl.Parent = sliderBg
    
    local draggingSlider = false
    local function Update(input)
        local pos = input.Position.X
        local boxPos = sliderBg.AbsolutePosition.X
        local boxSize = sliderBg.AbsoluteSize.X
        local relative = math.clamp((pos - boxPos) / boxSize, 0, 1)
        local newVal = min + (max - min) * relative
        
        if not isFloat then
            newVal = math.floor(newVal)
        end
        
        Config[configKey] = newVal
        sliderFill.Size = UDim2.new(relative, 0, 1, 0)
        valueLbl.Text = isFloat and string.format("%.2f", newVal) or tostring(math.floor(newVal))
        
        if callback then
            callback(newVal)
        end
        
        SaveConfigs()
    end
    
    sliderBg.InputBegan:Connect(function(input) 
        if input.UserInputType == Enum.UserInputType.MouseButton1 then 
            draggingSlider = true 
            Update(input) 
        end 
    end)
    
    UserInputService.InputEnded:Connect(function(input) 
        if input.UserInputType == Enum.UserInputType.MouseButton1 then 
            draggingSlider = false 
        end 
    end)
    
    UserInputService.InputChanged:Connect(function(input) 
        if draggingSlider and input.UserInputType == Enum.UserInputType.MouseMovement then 
            Update(input) 
        end 
    end)
end

-- Build Main Tab
local function BuildMainTab()
    ClearContent()
    
    local pad = Instance.new("Frame")
    pad.Size = UDim2.new(1,0,0,5)
    pad.BackgroundTransparency = 1
    pad.LayoutOrder = 0
    pad.Parent = ContentArea
    
    CreateToggle("Master Enabled", "Enabled")
    CreateToggle("Show Player Names", "ShowNames")
    CreateToggle("Show NPCs (No Names)", "ShowNPCs")
    CreateToggle("Show Bars", "ShowBars")
    CreateToggle("Show Values", "ShowValues")
    CreateToggle("Enable Walkspeed Multiplier", "ShowWalkspeed")
    
    CreateSlider("Walkspeed Multiplier", "WalkspeedMultiplier", 0.5, 5, nil, true, function(newVal)
        if Config.ShowWalkspeed then
            ApplyWalkspeedMultiplier()
        end
    end)
    
    CreateSlider("Max Distance", "MaxDistance", 100, 5000)
    
    -- Current target display
    local targetFrame = Instance.new("Frame")
    targetFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    targetFrame.BorderSizePixel = 0
    targetFrame.Size = UDim2.new(1, 0, 0, 40)
    targetFrame.LayoutOrder = 10
    targetFrame.Parent = ContentArea
    
    local targetLbl = Instance.new("TextLabel")
    targetLbl.Text = "Current Target: "
    targetLbl.Font = Enum.Font.SourceSans
    targetLbl.TextSize = 16
    targetLbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    targetLbl.TextXAlignment = Enum.TextXAlignment.Left
    targetLbl.BackgroundTransparency = 1
    targetLbl.Position = UDim2.new(0, 5, 0, 10)
    targetLbl.Size = UDim2.new(1, -10, 0, 20)
    targetLbl.Parent = targetFrame
    
    -- Update target display
    RunService.Heartbeat:Connect(function()
        if CurrentTarget then
            targetLbl.Text = "Current Target: " .. CurrentTarget.Name
        else
            targetLbl.Text = "Current Target: None"
        end
    end)
    
    ContentArea.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y + 20)
end

-- AutoParry Functions
local function StopAutoParry()
    if ParryConnection then
        ParryConnection:Disconnect()
        ParryConnection = nil
    end
    CurrentAnimations = {}
    DetectedAttacks = {}
    print("üõë AutoParry Stopped")
end

local function PlayAnimationAndParry(animationId)
    if not Config.AutoParryEnabled then return end
    
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return end
    
    local animator = humanoid:FindFirstChildOfClass("Animator")
    if not animator then
        animator = Instance.new("Animator")
        animator.Parent = humanoid
    end
    
    local animation = Instance.new("Animation")
    animation.AnimationId = animationId
    
    local animTrack = animator:LoadAnimation(animation)
    animTrack:Play()
    
    table.insert(CurrentAnimations, animTrack)
    
    task.wait(Config.ParryDelay)
    
    local keyCode = Enum.KeyCode[Config.ParryKey:upper()]
    if keyCode then
        VirtualInputManager:SendKeyEvent(true, keyCode, false, game)
        task.wait(0.05)
        VirtualInputManager:SendKeyEvent(false, keyCode, false, game)
        print("‚öîÔ∏è Parried animation: " .. animationId)
    end
    
    task.wait(2)
    for i, track in ipairs(CurrentAnimations) do
        if track == animTrack then
            table.remove(CurrentAnimations, i)
            break
        end
    end
end

local function StartAutoParry()
    StopAutoParry()
    
    if not Config.AutoParryEnabled then return end
    if #Config.ParryAnimations == 0 then
        warn("‚ö†Ô∏è No animations added to AutoParry")
        return
    end
    
    print("üîÑ AutoParry Started - Monitoring " .. #Config.ParryAnimations .. " animations")
    
    ParryConnection = RunService.Heartbeat:Connect(function()
        if not Config.AutoParryEnabled then return end
        
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                local character = player.Character
                if character then
                    local humanoid = character:FindFirstChild("Humanoid")
                    if humanoid then
                        local animator = humanoid:FindFirstChildOfClass("Animator")
                        if animator then
                            for _, track in pairs(animator:GetPlayingAnimationTracks()) do
                                local animId = track.Animation.AnimationId
                                
                                for _, savedAnim in ipairs(Config.ParryAnimations) do
                                    if animId == savedAnim and not DetectedAttacks[animId .. player.Name] then
                                        DetectedAttacks[animId .. player.Name] = true
                                        print("‚ö†Ô∏è Attack detected from " .. player.Name .. ": " .. animId)
                                        
                                        PlayAnimationAndParry(savedAnim)
                                        
                                        task.wait(2)
                                        DetectedAttacks[animId .. player.Name] = nil
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end)
end

-- Build AutoParry Tab
local function BuildAutoParryTab()
    ClearContent()
    
    local pad = Instance.new("Frame")
    pad.Size = UDim2.new(1,0,0,5)
    pad.BackgroundTransparency = 1
    pad.LayoutOrder = 0
    pad.Parent = ContentArea
    
    CreateToggle("Enable AutoParry", "AutoParryEnabled")
    
    -- Animation List
    local listFrame = Instance.new("Frame")
    listFrame.BackgroundTransparency = 1
    listFrame.Size = UDim2.new(1, 0, 0, 200)
    listFrame.LayoutOrder = 1
    listFrame.Parent = ContentArea
    
    local listLbl = Instance.new("TextLabel")
    listLbl.Text = "Parry Animations (" .. #Config.ParryAnimations .. ")"
    listLbl.Font = Enum.Font.SourceSans
    listLbl.TextSize = 16
    listLbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    listLbl.TextXAlignment = Enum.TextXAlignment.Left
    listLbl.BackgroundTransparency = 1
    listLbl.Position = UDim2.new(0, 5, 0, 0)
    listLbl.Size = UDim2.new(1, -10, 0, 20)
    listLbl.Parent = listFrame
    
    -- Manual animation input
    local animInput = Instance.new("TextBox")
    animInput.Text = ""
    animInput.PlaceholderText = "Enter Animation ID and press Enter"
    animInput.Font = Enum.Font.SourceSans
    animInput.TextSize = 16
    animInput.TextColor3 = Color3.fromRGB(255, 255, 255)
    animInput.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    animInput.BorderSizePixel = 0
    animInput.Position = UDim2.new(0, 5, 0, 25)
    animInput.Size = UDim2.new(1, -10, 0, 30)
    animInput.Parent = listFrame
    
    animInput.FocusLost:Connect(function(enterPressed)
        if enterPressed and animInput.Text ~= "" then
            table.insert(Config.ParryAnimations, animInput.Text)
            animInput.Text = ""
            SaveConfigs()
            BuildAutoParryTab()
        end
    end)
    
    -- Animation list scrolling frame
    local animList = Instance.new("ScrollingFrame")
    animList.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    animList.BorderSizePixel = 0
    animList.Position = UDim2.new(0, 5, 0, 60)
    animList.Size = UDim2.new(1, -10, 0, 130)
    animList.CanvasSize = UDim2.new(0, 0, 0, 0)
    animList.ScrollBarThickness = 6
    animList.AutomaticCanvasSize = Enum.AutomaticSize.Y
    animList.Parent = listFrame
    
    local animListLayout = Instance.new("UIListLayout")
    animListLayout.Parent = animList
    animListLayout.Padding = UDim.new(0, 2)
    
    for i, animId in ipairs(Config.ParryAnimations) do
        local animItem = Instance.new("Frame")
        animItem.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        animItem.Size = UDim2.new(1, 0, 0, 25)
        animItem.Parent = animList
        
        local animLabel = Instance.new("TextLabel")
        animLabel.Text = i .. ". " .. animId
        animLabel.Font = Enum.Font.SourceSans
        animLabel.TextSize = 12
        animLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
        animLabel.TextXAlignment = Enum.TextXAlignment.Left
        animLabel.BackgroundTransparency = 1
        animLabel.Position = UDim2.new(0, 5, 0, 0)
        animLabel.Size = UDim2.new(1, -35, 1, 0)
        animLabel.Parent = animItem
        
        local removeBtn = Instance.new("TextButton")
        removeBtn.Text = "X"
        removeBtn.Font = Enum.Font.SourceSansBold
        removeBtn.TextSize = 16
        removeBtn.TextColor3 = Color3.fromRGB(255, 100, 100)
        removeBtn.BackgroundColor3 = Color3.fromRGB(60, 0, 0)
        removeBtn.BorderSizePixel = 0
        removeBtn.Position = UDim2.new(1, -25, 0, 2)
        removeBtn.Size = UDim2.new(0, 20, 0, 20)
        removeBtn.Parent = animItem
        
        removeBtn.MouseButton1Click:Connect(function()
            table.remove(Config.ParryAnimations, i)
            SaveConfigs()
            BuildAutoParryTab()
        end)
    end
    
    CreateSlider("Parry Delay (seconds)", "ParryDelay", 0, 1, nil, true)
    
    -- Key Selection
    local keyFrame = Instance.new("Frame")
    keyFrame.BackgroundTransparency = 1
    keyFrame.Size = UDim2.new(1, 0, 0, 50)
    keyFrame.LayoutOrder = 3
    keyFrame.Parent = ContentArea
    
    local keyLbl = Instance.new("TextLabel")
    keyLbl.Text = "Parry Key"
    keyLbl.Font = Enum.Font.SourceSans
    keyLbl.TextSize = 16
    keyLbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    keyLbl.TextXAlignment = Enum.TextXAlignment.Left
    keyLbl.BackgroundTransparency = 1
    keyLbl.Position = UDim2.new(0, 5, 0, 0)
    keyLbl.Size = UDim2.new(1, -10, 0, 20)
    keyLbl.Parent = keyFrame
    
    local keyBox = Instance.new("TextBox")
    keyBox.Text = Config.ParryKey
    keyBox.PlaceholderText = "F"
    keyBox.Font = Enum.Font.SourceSans
    keyBox.TextSize = 16
    keyBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    keyBox.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    keyBox.BorderSizePixel = 0
    keyBox.Position = UDim2.new(0, 5, 0, 25)
    keyBox.Size = UDim2.new(1, -10, 0, 20)
    keyBox.Parent = keyFrame
    
    keyBox.FocusLost:Connect(function()
        Config.ParryKey = keyBox.Text:upper()
        SaveConfigs()
    end)
    
    -- Test Button
    local testBtn = Instance.new("TextButton")
    testBtn.Text = "Test Parry (First Animation)"
    testBtn.Font = Enum.Font.SourceSans
    testBtn.TextSize = 18
    testBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    testBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
    testBtn.BorderSizePixel = 0
    testBtn.Size = UDim2.new(1, -10, 0, 40)
    testBtn.Position = UDim2.new(0, 5, 0, 0)
    testBtn.LayoutOrder = 4
    testBtn.Parent = ContentArea
    
    testBtn.MouseButton1Click:Connect(function()
        if #Config.ParryAnimations == 0 then
            SendNotification("Error", "Please add animations first", 3)
            return
        end
        PlayAnimationAndParry(Config.ParryAnimations[1])
    end)
    
    ContentArea.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y + 20)
end

-- Build Fetch Animations Tab
local function BuildFetchTab()
    ClearContent()
    
    local pad = Instance.new("Frame")
    pad.Size = UDim2.new(1,0,0,5)
    pad.BackgroundTransparency = 1
    pad.LayoutOrder = 0
    pad.Parent = ContentArea
    
    CreateToggle("Enable Animation Fetch", "FetchAnimationsEnabled")
    CreateToggle("Fetch from Nearest Target", "FetchFromTarget")
    CreateToggle("Auto-Add Fetched to Parry List", "AutoAddFetched")
    
    -- Manual fetch button
    local fetchBtn = Instance.new("TextButton")
    fetchBtn.Text = "üîÑ Fetch Now"
    fetchBtn.Font = Enum.Font.SourceSans
    fetchBtn.TextSize = 18
    fetchBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    fetchBtn.BackgroundColor3 = Color3.fromRGB(255, 170, 0)
    fetchBtn.BorderSizePixel = 0
    fetchBtn.Size = UDim2.new(1, -10, 0, 40)
    fetchBtn.LayoutOrder = 3
    fetchBtn.Parent = ContentArea
    
    fetchBtn.MouseButton1Click:Connect(function()
        local target = GetNearestTarget()
        if target then
            local fetched = FetchAnimationsFromTarget(target)
            if fetched and #fetched > 0 then
                SendNotification(
                    "‚úÖ Fetched Animations",
                    "Found " .. #fetched .. " animations from " .. target.Name,
                    3
                )
            else
                SendNotification(
                    "‚ÑπÔ∏è No New Animations",
                    "No new animations found from " .. target.Name,
                    3
                )
            end
        else
            SendNotification("Error", "No target found", 3)
        end
    end)
    
    -- Fetched animations display
    local fetchedFrame = Instance.new("Frame")
    fetchedFrame.BackgroundTransparency = 1
    fetchedFrame.Size = UDim2.new(1, 0, 0, 150)
    fetchedFrame.LayoutOrder = 4
    fetchedFrame.Parent = ContentArea
    
    local fetchedLbl = Instance.new("TextLabel")
    fetchedLbl.Text = "Recently Fetched Animations"
    fetchedLbl.Font = Enum.Font.SourceSans
    fetchedLbl.TextSize = 16
    fetchedLbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    fetchedLbl.TextXAlignment = Enum.TextXAlignment.Left
    fetchedLbl.BackgroundTransparency = 1
    fetchedLbl.Position = UDim2.new(0, 5, 0, 0)
    fetchedLbl.Size = UDim2.new(1, -10, 0, 20)
    fetchedLbl.Parent = fetchedFrame
    
    local fetchedList = Instance.new("ScrollingFrame")
    fetchedList.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    fetchedList.BorderSizePixel = 0
    fetchedList.Position = UDim2.new(0, 5, 0, 25)
    fetchedList.Size = UDim2.new(1, -10, 0, 115)
    fetchedList.CanvasSize = UDim2.new(0, 0, 0, 0)
    fetchedList.ScrollBarThickness = 6
    fetchedList.AutomaticCanvasSize = Enum.AutomaticSize.Y
    fetchedList.Parent = fetchedFrame
    
    local fetchedListLayout = Instance.new("UIListLayout")
    fetchedListLayout.Parent = fetchedList
    fetchedListLayout.Padding = UDim.new(0, 2)
    
    -- Update fetched list display
    local function UpdateFetchedDisplay()
        for _, child in pairs(fetchedList:GetChildren()) do
            if child:IsA("Frame") then
                child:Destroy()
            end
        end
        
        for i, animId in ipairs(FetchedAnimationList) do
            local animItem = Instance.new("Frame")
            animItem.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
            animItem.Size = UDim2.new(1, 0, 0, 25)
            animItem.Parent = fetchedList
            
            local animLabel = Instance.new("TextLabel")
            animLabel.Text = i .. ". " .. animId
            animLabel.Font = Enum.Font.SourceSans
            animLabel.TextSize = 12
            animLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
            animLabel.TextXAlignment = Enum.TextXAlignment.Left
            animLabel.BackgroundTransparency = 1
            animLabel.Position = UDim2.new(0, 5, 0, 0)
            animLabel.Size = UDim2.new(1, -5, 1, 0)
            animLabel.Parent = animItem
        end
    end
    
    -- Update every second
    task.spawn(function()
        while task.wait(1) do
            UpdateFetchedDisplay()
        end
    end)
    
    ContentArea.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y + 20)
end

-- Build No Stun Tab
local function BuildNoStunTab()
    ClearContent()
    
    local pad = Instance.new("Frame")
    pad.Size = UDim2.new(1,0,0,5)
    pad.BackgroundTransparency = 1
    pad.LayoutOrder = 0
    pad.Parent = ContentArea
    
    CreateToggle("Enable No Stun", "NoStunEnabled")
    CreateToggle("Enable Anti-Anchor", "AntiAnchorEnabled")
    
    -- Info text
    local infoFrame = Instance.new("Frame")
    infoFrame.BackgroundTransparency = 1
    infoFrame.Size = UDim2.new(1, 0, 0, 100)
    infoFrame.LayoutOrder = 2
    infoFrame.Parent = ContentArea
    
    local infoLbl1 = Instance.new("TextLabel")
    infoLbl1.Text = "‚ö° No Stun: Prevents walkspeed from dropping"
    infoLbl1.Font = Enum.Font.SourceSans
    infoLbl1.TextSize = 16
    infoLbl1.TextColor3 = Color3.fromRGB(200, 200, 200)
    infoLbl1.TextXAlignment = Enum.TextXAlignment.Left
    infoLbl1.BackgroundTransparency = 1
    infoLbl1.Position = UDim2.new(0, 5, 0, 0)
    infoLbl1.Size = UDim2.new(1, -10, 0, 20)
    infoLbl1.Parent = infoFrame
    
    local infoLbl2 = Instance.new("TextLabel")
    infoLbl2.Text = "‚öì Anti-Anchor: Prevents being anchored by moves"
    infoLbl2.Font = Enum.Font.SourceSans
    infoLbl2.TextSize = 16
    infoLbl2.TextColor3 = Color3.fromRGB(200, 200, 200)
    infoLbl2.TextXAlignment = Enum.TextXAlignment.Left
    infoLbl2.BackgroundTransparency = 1
    infoLbl2.Position = UDim2.new(0, 5, 0, 25)
    infoLbl2.Size = UDim2.new(1, -10, 0, 20)
    infoLbl2.Parent = infoFrame
    
    local infoLbl3 = Instance.new("TextLabel")
    infoLbl3.Text = "Both work with Walkspeed Multiplier!"
    infoLbl3.Font = Enum.Font.SourceSans
    infoLbl3.TextSize = 16
    infoLbl3.TextColor3 = Color3.fromRGB(0, 200, 0)
    infoLbl3.TextXAlignment = Enum.TextXAlignment.Left
    infoLbl3.BackgroundTransparency = 1
    infoLbl3.Position = UDim2.new(0, 5, 0, 50)
    infoLbl3.Size = UDim2.new(1, -10, 0, 20)
    infoLbl3.Parent = infoFrame
    
    CreateSlider("Minimum Walkspeed", "MinWalkspeed", 1, 100, nil, true)
    
    -- Status display
    local statusFrame = Instance.new("Frame")
    statusFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    statusFrame.BorderSizePixel = 0
    statusFrame.Size = UDim2.new(1, 0, 0, 60)
    statusFrame.LayoutOrder = 4
    statusFrame.Parent = ContentArea
    
    local statusLbl = Instance.new("TextLabel")
    statusLbl.Text = "Current Status:"
    statusLbl.Font = Enum.Font.SourceSans
    statusLbl.TextSize = 16
    statusLbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    statusLbl.TextXAlignment = Enum.TextXAlignment.Left
    statusLbl.BackgroundTransparency = 1
    statusLbl.Position = UDim2.new(0, 5, 0, 5)
    statusLbl.Size = UDim2.new(1, -10, 0, 20)
    statusLbl.Parent = statusFrame
    
    local currentSpeedLbl = Instance.new("TextLabel")
    currentSpeedLbl.Text = "Current Speed: --"
    currentSpeedLbl.Font = Enum.Font.SourceSans
    currentSpeedLbl.TextSize = 14
    currentSpeedLbl.TextColor3 = Color3.fromRGB(150, 150, 150)
    currentSpeedLbl.TextXAlignment = Enum.TextXAlignment.Left
    currentSpeedLbl.BackgroundTransparency = 1
    currentSpeedLbl.Position = UDim2.new(0, 5, 0, 30)
    currentSpeedLbl.Size = UDim2.new(1, -10, 0, 20)
    currentSpeedLbl.Parent = statusFrame
    
    -- Update speed display
    local function UpdateSpeedDisplay()
        local character = LocalPlayer.Character
        if character then
            local humanoid = character:FindFirstChild("Humanoid")
            if humanoid then
                local minSpeed = Config.MinWalkspeed
                if Config.ShowWalkspeed then
                    minSpeed = BaseWalkspeed * Config.WalkspeedMultiplier
                end
                currentSpeedLbl.Text = string.format("Current: %.1f | Min: %.1f | Anchored: %s", 
                    humanoid.WalkSpeed, 
                    minSpeed,
                    tostring(character.Anchored))
            end
        end
    end
    
    RunService.Heartbeat:Connect(UpdateSpeedDisplay)
    
    ContentArea.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y + 20)
end

-- Build Config Tab (simplified)
local function BuildConfigTab()
    ClearContent()
    
    local selectFrame = Instance.new("Frame")
    selectFrame.BackgroundTransparency = 1
    selectFrame.Size = UDim2.new(1, 0, 0, 50)
    selectFrame.LayoutOrder = 1
    selectFrame.Parent = ContentArea
    
    local selectLbl = Instance.new("TextLabel")
    selectLbl.Text = "Current Config: " .. CurrentConfig
    selectLbl.Font = Enum.Font.SourceSans
    selectLbl.TextSize = 16
    selectLbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    selectLbl.TextXAlignment = Enum.TextXAlignment.Left
    selectLbl.BackgroundTransparency = 1
    selectLbl.Position = UDim2.new(0, 5, 0, 0)
    selectLbl.Size = UDim2.new(1, -10, 0, 20)
    selectLbl.Parent = selectFrame
    
    local btnFrame = Instance.new("Frame")
    btnFrame.BackgroundTransparency = 1
    btnFrame.Size = UDim2.new(1, 0, 0, 40)
    btnFrame.LayoutOrder = 2
    btnFrame.Parent = ContentArea
    
    local saveBtn = Instance.new("TextButton")
    saveBtn.Text = "Save Config"
    saveBtn.Font = Enum.Font.SourceSans
    saveBtn.TextSize = 16
    saveBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    saveBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
    saveBtn.BorderSizePixel = 0
    saveBtn.Position = UDim2.new(0, 5, 0, 0)
    saveBtn.Size = UDim2.new(0.5, -10, 0, 30)
    saveBtn.Parent = btnFrame
    
    local loadBtn = Instance.new("TextButton")
    loadBtn.Text = "Load Default"
    loadBtn.Font = Enum.Font.SourceSans
    loadBtn.TextSize = 16
    loadBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    loadBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
    loadBtn.BorderSizePixel = 0
    loadBtn.Position = UDim2.new(0.5, 5, 0, 0)
    loadBtn.Size = UDim2.new(0.5, -10, 0, 30)
    loadBtn.Parent = btnFrame
    
    saveBtn.MouseButton1Click:Connect(function()
        local configCopy = {}
        for k, v in pairs(Config) do
            configCopy[k] = v
        end
        Configs[CurrentConfig] = configCopy
        SaveConfigs()
        saveBtn.Text = "Saved!"
        saveBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
        task.wait(1)
        saveBtn.Text = "Save Config"
        saveBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
    end)
    
    loadBtn.MouseButton1Click:Connect(function()
        if Configs["Default"] then
            for k, v in pairs(Configs["Default"]) do
                Config[k] = v
            end
            
            if Config.ShowWalkspeed then
                ApplyWalkspeedMultiplier()
                StartWalkspeedMonitoring()
            end
            
            if Config.AutoParryEnabled then
                StartAutoParry()
            else
                StopAutoParry()
            end
            
            if Config.FetchAnimationsEnabled then
                StartAnimationFetching()
            end
            
            SaveConfigs()
            
            loadBtn.Text = "Loaded!"
            loadBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
            task.wait(1)
            loadBtn.Text = "Load Default"
            loadBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
        end
    end)
    
    ContentArea.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y + 20)
end

-- Tab switching
MainTabBtn.MouseButton1Click:Connect(function()
    MainTabBtn.TextColor3 = Color3.fromRGB(0, 120, 255)
    MainTabBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    AutoParryTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    AutoParryTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    FetchTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    FetchTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    NoStunTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    NoStunTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    ConfigTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    ConfigTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    BuildMainTab()
end)

AutoParryTabBtn.MouseButton1Click:Connect(function()
    AutoParryTabBtn.TextColor3 = Color3.fromRGB(0, 120, 255)
    AutoParryTabBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    MainTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    MainTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    FetchTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    FetchTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    NoStunTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    NoStunTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    ConfigTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    ConfigTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    BuildAutoParryTab()
end)

FetchTabBtn.MouseButton1Click:Connect(function()
    FetchTabBtn.TextColor3 = Color3.fromRGB(0, 120, 255)
    FetchTabBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    MainTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    MainTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    AutoParryTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    AutoParryTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    NoStunTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    NoStunTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    ConfigTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    ConfigTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    BuildFetchTab()
end)

NoStunTabBtn.MouseButton1Click:Connect(function()
    NoStunTabBtn.TextColor3 = Color3.fromRGB(0, 120, 255)
    NoStunTabBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    MainTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    MainTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    AutoParryTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    AutoParryTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    FetchTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    FetchTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    ConfigTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    ConfigTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    BuildNoStunTab()
end)

ConfigTabBtn.MouseButton1Click:Connect(function()
    ConfigTabBtn.TextColor3 = Color3.fromRGB(0, 120, 255)
    ConfigTabBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    MainTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    MainTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    AutoParryTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    AutoParryTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    FetchTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    FetchTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    NoStunTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    NoStunTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    BuildConfigTab()
end)

BuildMainTab()

-- Rest of ESP and Moderator Detector code remains the same...
-- (The ESP system and Moderator Detector from previous versions are still here)
