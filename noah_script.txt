-- Universal ESP with Mission Hunter GUI + AutoParry (Animation Fetch) + Custom Keybinds
-- Logic: Players = Native Health Bar + Custom Red/Yellow Bars with Values + Walkspeed Multiplier
-- NPCs = Custom Green Bar (Toggleable) - Names hidden
-- Animation Fetch: Get animation IDs from nearest target
-- Custom Keybinds: Assign keys to toggle any feature
-- Default Menu Key: F4

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer
local VirtualInputManager = game:GetService("VirtualInputManager")
local StarterGui = game:GetService("StarterGui")
local SoundService = game:GetService("SoundService")

-- Configuration (Default Settings)
local Config = {
    Enabled = true,
    ShowNames = true,
    ShowBars = true,
    ShowNPCs = true,
    ShowValues = true,
    ShowWalkspeed = true,
    WalkspeedMultiplier = 1.0,
    MaxDistance = 1500,
    TextSize = 14,
    BarWidth = 150,
    BarHeight = 6,
    YOffset = 60,
    
    -- AutoParry Settings
    AutoParryEnabled = false,
    ParryAnimations = {},
    ParryDelay = 0.1,
    ParryKey = "F",
    
    -- Animation Fetch Settings
    FetchAnimationsEnabled = false,
    FetchFromTarget = true,
    FetchedAnimations = {},
    AutoAddFetched = false,
    
    -- Keybind Settings
    MenuKey = "F4",
    Keybinds = {
        Enabled = "F5",
        ShowNames = "F6",
        ShowNPCs = "F7",
        ShowBars = "F8",
        ShowValues = "F9",
        ShowWalkspeed = "F10",
        AutoParryEnabled = "F11",
        FetchAnimationsEnabled = "Delete"
    }
}

-- State
local ESP_Cache = {}
local LiveFolder = workspace:FindFirstChild("Live")
local Configs = {}
local CurrentConfig = "Default"
local BaseWalkspeed = 16
local WalkspeedUpdateConnection = nil

-- AutoParry State
local ParryConnection = nil
local CurrentAnimations = {}
local DetectedAttacks = {}

-- Animation Fetch State
local CurrentTarget = nil
local FetchConnection = nil
local FetchedAnimationList = {}

-- Keybind State
local KeybindMode = false
local AwaitingKeybind = nil
local AwaitingKeybindLabel = nil

-- Config file path
local ConfigFolder = "MissionHunterESP"
local ConfigFile = "configs.json"

-- Function to get the WalkSpeed attribute from humanoid
local function GetBaseWalkspeedFromAttribute(humanoid)
    local attrSpeed = humanoid:GetAttribute("WalkSpeed")
    if attrSpeed then
        return attrSpeed
    end
    return humanoid.WalkSpeed
end

-- Function to consistently apply walkspeed multiplier
local function ApplyWalkspeedMultiplier()
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return end
    
    if Config.ShowWalkspeed then
        local baseSpeed = GetBaseWalkspeedFromAttribute(humanoid)
        local targetSpeed = baseSpeed * Config.WalkspeedMultiplier
        
        if math.abs(humanoid.WalkSpeed - targetSpeed) > 0.1 then
            humanoid.WalkSpeed = targetSpeed
        end
    end
end

-- Start monitoring walkspeed changes
local function StartWalkspeedMonitoring()
    if WalkspeedUpdateConnection then
        WalkspeedUpdateConnection:Disconnect()
        WalkspeedUpdateConnection = nil
    end
    
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return end
    
    BaseWalkspeed = GetBaseWalkspeedFromAttribute(humanoid)
    
    local attributeConnection = humanoid:GetAttributeChangedSignal("WalkSpeed"):Connect(function()
        task.wait(0.1)
        BaseWalkspeed = GetBaseWalkspeedFromAttribute(humanoid)
        if Config.ShowWalkspeed then
            ApplyWalkspeedMultiplier()
        end
    end)
    
    WalkspeedUpdateConnection = RunService.RenderStepped:Connect(function()
        if not Config.Enabled then return end
        
        local currentChar = LocalPlayer.Character
        if not currentChar then return end
        
        local currentHumanoid = currentChar:FindFirstChild("Humanoid")
        if not currentHumanoid then return end
        
        local currentBase = GetBaseWalkspeedFromAttribute(currentHumanoid)
        
        if math.abs(currentBase - BaseWalkspeed) > 0.1 then
            BaseWalkspeed = currentBase
        end
        
        -- Apply walkspeed multiplier if enabled
        if Config.ShowWalkspeed then
            local targetSpeed = BaseWalkspeed * Config.WalkspeedMultiplier
            if math.abs(currentHumanoid.WalkSpeed - targetSpeed) > 0.1 then
                currentHumanoid.WalkSpeed = targetSpeed
            end
        end
    end)
    
    character.AncestryChanged:Connect(function()
        if not character.Parent then
            if attributeConnection then
                attributeConnection:Disconnect()
            end
        end
    end)
end

-- Handle character respawns
local function OnCharacterAdded(character)
    local humanoid = character:WaitForChild("Humanoid")
    
    task.wait(0.1)
    
    BaseWalkspeed = GetBaseWalkspeedFromAttribute(humanoid)
    
    if Config.ShowWalkspeed then
        humanoid.WalkSpeed = BaseWalkspeed * Config.WalkspeedMultiplier
    end
    
    StartWalkspeedMonitoring()
    
    humanoid.AncestryChanged:Connect(function()
        task.wait(0.1)
        if not humanoid.Parent then
            task.wait(0.5)
            OnCharacterAdded(character)
        end
    end)
end

-- Connect character events
LocalPlayer.CharacterAdded:Connect(OnCharacterAdded)

if LocalPlayer.Character then
    OnCharacterAdded(LocalPlayer.Character)
end

-- Function to find nearest target
local function GetNearestTarget()
    local character = LocalPlayer.Character
    if not character then return nil end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso") or character:FindFirstChild("UpperTorso")
    if not rootPart then return nil end
    
    local nearestDist = math.huge
    local nearestPlayer = nil
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local targetChar = player.Character
            if targetChar and targetChar:FindFirstChild("Humanoid") and targetChar.Humanoid.Health > 0 then
                local targetRoot = targetChar:FindFirstChild("HumanoidRootPart") or targetChar:FindFirstChild("Torso") or targetChar:FindFirstChild("UpperTorso")
                if targetRoot then
                    local dist = (rootPart.Position - targetRoot.Position).Magnitude
                    if dist < nearestDist then
                        nearestDist = dist
                        nearestPlayer = player
                    end
                end
            end
        end
    end
    
    return nearestPlayer
end

-- Function to fetch animations from target
local function FetchAnimationsFromTarget(target)
    if not target then return end
    
    local targetChar = target.Character
    if not targetChar then return end
    
    local humanoid = targetChar:FindFirstChild("Humanoid")
    if not humanoid then return end
    
    local animator = humanoid:FindFirstChildOfClass("Animator")
    if not animator then return end
    
    local fetched = {}
    local newAnimations = 0
    
    -- Get currently playing animations
    for _, track in pairs(animator:GetPlayingAnimationTracks()) do
        local animId = track.Animation.AnimationId
        if animId and animId ~= "" then
            -- Check if already in list
            local alreadyExists = false
            for _, savedId in ipairs(Config.ParryAnimations) do
                if savedId == animId then
                    alreadyExists = true
                    break
                end
            end
            
            if not alreadyExists then
                table.insert(fetched, animId)
                newAnimations = newAnimations + 1
                
                -- Auto add if enabled
                if Config.AutoAddFetched then
                    table.insert(Config.ParryAnimations, animId)
                end
            end
        end
    end
    
    -- Update fetched list
    FetchedAnimationList = fetched
    
    if newAnimations > 0 then
        SendNotification(
            "üì• Animations Fetched",
            "Found " .. newAnimations .. " new animations from " .. target.Name,
            3
        )
        
        -- Save if auto-add is enabled
        if Config.AutoAddFetched then
            SaveConfigs()
            print("‚úÖ Auto-added " .. newAnimations .. " animations from " .. target.Name)
        end
    end
    
    return fetched
end

-- Start animation fetching
local function StartAnimationFetching()
    if FetchConnection then
        FetchConnection:Disconnect()
        FetchConnection = nil
    end
    
    if not Config.FetchAnimationsEnabled then return end
    
    print("üîÑ Animation Fetching Started")
    
    FetchConnection = RunService.Heartbeat:Connect(function()
        if not Config.FetchAnimationsEnabled then return end
        
        if Config.FetchFromTarget then
            local target = GetNearestTarget()
            if target and target ~= CurrentTarget then
                CurrentTarget = target
                FetchAnimationsFromTarget(target)
            end
        end
    end)
end

-- Function to save configs to file
local function SaveConfigs()
    local success, err = pcall(function()
        local data = {
            CurrentConfig = CurrentConfig,
            Configs = Configs
        }
        writefile(ConfigFolder .. "/" .. ConfigFile, HttpService:JSONEncode(data))
    end)
    if not success then
        warn("Failed to save configs: " .. tostring(err))
    end
end

-- Function to load configs from file
local function LoadConfigs()
    local success, err = pcall(function()
        if isfile(ConfigFolder .. "/" .. ConfigFile) then
            local data = HttpService:JSONDecode(readfile(ConfigFolder .. "/" .. ConfigFile))
            CurrentConfig = data.CurrentConfig or "Default"
            Configs = data.Configs or {}
            
            if Configs[CurrentConfig] then
                for k, v in pairs(Configs[CurrentConfig]) do
                    Config[k] = v
                end
            end
        else
            Configs["Default"] = {
                Enabled = true,
                ShowNames = true,
                ShowBars = true,
                ShowNPCs = true,
                ShowValues = true,
                ShowWalkspeed = true,
                WalkspeedMultiplier = 1.0,
                MaxDistance = 1500,
                TextSize = 14,
                BarWidth = 150,
                BarHeight = 6,
                YOffset = 60,
                AutoParryEnabled = false,
                ParryAnimations = {},
                ParryDelay = 0.1,
                ParryKey = "F",
                FetchAnimationsEnabled = false,
                FetchFromTarget = true,
                FetchedAnimations = {},
                AutoAddFetched = false,
                MenuKey = "F4",
                Keybinds = {
                    Enabled = "F5",
                    ShowNames = "F6",
                    ShowNPCs = "F7",
                    ShowBars = "F8",
                    ShowValues = "F9",
                    ShowWalkspeed = "F10",
                    AutoParryEnabled = "F11",
                    FetchAnimationsEnabled = "Delete"
                }
            }
            CurrentConfig = "Default"
            SaveConfigs()
        end
    end)
    if not success then
        warn("Failed to load configs: " .. tostring(err))
    end
end

-- Load configs at startup and apply multiplier
LoadConfigs()
ApplyWalkspeedMultiplier()
StartAnimationFetching()

-- HandleKeybind is defined later (after all referenced functions exist)

--------------------------------------------------------------------------------
-- 1. GUI CONSTRUCTION
--------------------------------------------------------------------------------

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MissionHunterESP"
ScreenGui.ResetOnSpawn = false

if gethui then
    ScreenGui.Parent = gethui()
elseif game:GetService("RunService"):IsStudio() then
    ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
else
    pcall(function() ScreenGui.Parent = CoreGui end)
    if not ScreenGui.Parent then ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui") end
end

-- Main Container
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 550, 0, 600)
MainFrame.Position = UDim2.new(0, 20, 0, 25)
MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
MainFrame.BorderSizePixel = 1
MainFrame.BorderColor3 = Color3.fromRGB(40, 40, 40)
MainFrame.Visible = true
MainFrame.Parent = ScreenGui

-- Header
local Header = Instance.new("Frame")
Header.Name = "Header"
Header.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
Header.BorderSizePixel = 0
Header.Size = UDim2.new(1, 0, 0, 30)
Header.Parent = MainFrame

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Text = "Mission Hunter ESP + AutoParry + Keybinds"
TitleLabel.Font = Enum.Font.Code
TitleLabel.TextSize = 14
TitleLabel.TextColor3 = Color3.fromRGB(0, 120, 255)
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.BackgroundTransparency = 1
TitleLabel.Position = UDim2.new(0, 10, 0, 0)
TitleLabel.Size = UDim2.new(1, -20, 1, 0)
TitleLabel.Parent = Header

-- Drag Logic
local dragging, dragInput, dragStart, startPos
Header.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then dragging = false end
        end)
    end
end)
Header.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end
end)
UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- Tab Buttons
local TabButtons = Instance.new("Frame")
TabButtons.Name = "TabButtons"
TabButtons.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
TabButtons.BorderSizePixel = 0
TabButtons.Position = UDim2.new(0, 0, 0, 30)
TabButtons.Size = UDim2.new(1, 0, 0, 25)
TabButtons.Parent = MainFrame

local MainTabBtn = Instance.new("TextButton")
MainTabBtn.Text = "Main"
MainTabBtn.Font = Enum.Font.SourceSans
MainTabBtn.TextSize = 16
MainTabBtn.TextColor3 = Color3.fromRGB(0, 120, 255)
MainTabBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainTabBtn.BorderSizePixel = 0
MainTabBtn.Position = UDim2.new(0, 0, 0, 0)
MainTabBtn.Size = UDim2.new(0, 110, 1, 0)
MainTabBtn.Parent = TabButtons

local AutoParryTabBtn = Instance.new("TextButton")
AutoParryTabBtn.Text = "Parry"
AutoParryTabBtn.Font = Enum.Font.SourceSans
AutoParryTabBtn.TextSize = 16
AutoParryTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
AutoParryTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
AutoParryTabBtn.BorderSizePixel = 0
AutoParryTabBtn.Position = UDim2.new(0, 110, 0, 0)
AutoParryTabBtn.Size = UDim2.new(0, 110, 1, 0)
AutoParryTabBtn.Parent = TabButtons

local FetchTabBtn = Instance.new("TextButton")
FetchTabBtn.Text = "Fetch"
FetchTabBtn.Font = Enum.Font.SourceSans
FetchTabBtn.TextSize = 16
FetchTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
FetchTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
FetchTabBtn.BorderSizePixel = 0
FetchTabBtn.Position = UDim2.new(0, 220, 0, 0)
FetchTabBtn.Size = UDim2.new(0, 110, 1, 0)
FetchTabBtn.Parent = TabButtons

local KeybindsTabBtn = Instance.new("TextButton")
KeybindsTabBtn.Text = "Keybinds"
KeybindsTabBtn.Font = Enum.Font.SourceSans
KeybindsTabBtn.TextSize = 16
KeybindsTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
KeybindsTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
KeybindsTabBtn.BorderSizePixel = 0
KeybindsTabBtn.Position = UDim2.new(0, 330, 0, 0)
KeybindsTabBtn.Size = UDim2.new(0, 110, 1, 0)
KeybindsTabBtn.Parent = TabButtons

local ConfigTabBtn = Instance.new("TextButton")
ConfigTabBtn.Text = "Config"
ConfigTabBtn.Font = Enum.Font.SourceSans
ConfigTabBtn.TextSize = 16
ConfigTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
ConfigTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
ConfigTabBtn.BorderSizePixel = 0
ConfigTabBtn.Position = UDim2.new(0, 440, 0, 0)
ConfigTabBtn.Size = UDim2.new(0, 110, 1, 0)
ConfigTabBtn.Parent = TabButtons

-- Content Area
local ContentArea = Instance.new("ScrollingFrame")
ContentArea.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
ContentArea.BorderSizePixel = 0
ContentArea.Position = UDim2.new(0, 10, 0, 65)
ContentArea.Size = UDim2.new(1, -20, 1, -75)
ContentArea.CanvasSize = UDim2.new(0, 0, 0, 0)
ContentArea.ScrollBarThickness = 8
ContentArea.ScrollBarImageColor3 = Color3.fromRGB(0, 120, 255)
ContentArea.AutomaticCanvasSize = Enum.AutomaticSize.Y
ContentArea.Parent = MainFrame

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Parent = ContentArea
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0, 8)

-- Helper functions
local function ClearContent()
    for _, child in pairs(ContentArea:GetChildren()) do
        if child:IsA("Frame") or child:IsA("TextLabel") or child:IsA("TextBox") or child:IsA("TextButton") or child:IsA("ScrollingFrame") then
            child:Destroy()
        end
    end
end

local function SendNotification(title, text, duration, icon)
    StarterGui:SetCore("SendNotification", {
        Title = title,
        Text = text,
        Duration = duration or 5,
        Icon = icon or "rbxasset://textures/ui/GameSettings/GFX/icon_alert.png"
    })
end

-- Enhanced toggle with keybind display
local function CreateToggleWithKeybind(text, configKey, container)
    local container = container or ContentArea
    
    local toggleFrame = Instance.new("Frame")
    toggleFrame.BackgroundTransparency = 1
    toggleFrame.Size = UDim2.new(1, 0, 0, 24)
    toggleFrame.LayoutOrder = 1
    toggleFrame.Parent = container
    
    -- Toggle button
    local btn = Instance.new("TextButton")
    btn.Text = ""
    btn.BackgroundColor3 = Config[configKey] and Color3.fromRGB(0, 120, 255) or Color3.fromRGB(40, 40, 40)
    btn.BorderSizePixel = 0
    btn.Position = UDim2.new(0, 5, 0, 4)
    btn.Size = UDim2.new(0, 16, 0, 16)
    btn.Parent = toggleFrame
    
    -- Label
    local lbl = Instance.new("TextLabel")
    lbl.Text = text
    lbl.Font = Enum.Font.SourceSans
    lbl.TextSize = 16
    lbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.BackgroundTransparency = 1
    lbl.Position = UDim2.new(0, 30, 0, 0)
    lbl.Size = UDim2.new(0.6, -30, 1, 0)
    lbl.Parent = toggleFrame
    
    -- Keybind display and setter
    local keyFrame = Instance.new("Frame")
    keyFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    keyFrame.BorderSizePixel = 0
    keyFrame.Position = UDim2.new(0.6, 0, 0, 2)
    keyFrame.Size = UDim2.new(0.4, -10, 0, 20)
    keyFrame.Parent = toggleFrame
    
    local keyLbl = Instance.new("TextLabel")
    keyLbl.Text = "Key: " .. (Config.Keybinds[configKey] or "None")
    keyLbl.Font = Enum.Font.SourceSans
    keyLbl.TextSize = 14
    keyLbl.TextColor3 = Color3.fromRGB(255, 255, 0)
    keyLbl.BackgroundTransparency = 1
    keyLbl.Size = UDim2.new(0.7, -5, 1, 0)
    keyLbl.Position = UDim2.new(0, 5, 0, 0)
    keyLbl.TextXAlignment = Enum.TextXAlignment.Left
    keyLbl.Parent = keyFrame
    
    local setKeyBtn = Instance.new("TextButton")
    setKeyBtn.Text = "Set"
    setKeyBtn.Font = Enum.Font.SourceSans
    setKeyBtn.TextSize = 14
    setKeyBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    setKeyBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
    setKeyBtn.BorderSizePixel = 0
    setKeyBtn.Position = UDim2.new(0.7, 0, 0, 0)
    setKeyBtn.Size = UDim2.new(0.3, -5, 1, 0)
    setKeyBtn.Parent = keyFrame
    
    -- Toggle functionality
    btn.MouseButton1Click:Connect(function()
        Config[configKey] = not Config[configKey]
        btn.BackgroundColor3 = Config[configKey] and Color3.fromRGB(0, 120, 255) or Color3.fromRGB(40, 40, 40)
        
        -- Handle special cases
        if configKey == "AutoParryEnabled" then
            if Config.AutoParryEnabled then
                StartAutoParry()
            else
                StopAutoParry()
            end
        elseif configKey == "FetchAnimationsEnabled" then
            if Config.FetchAnimationsEnabled then
                StartAnimationFetching()
            else
                if FetchConnection then
                    FetchConnection:Disconnect()
                    FetchConnection = nil
                end
            end
        elseif configKey == "ShowWalkspeed" then
            if Config.ShowWalkspeed then
                ApplyWalkspeedMultiplier()
                StartWalkspeedMonitoring()
            else
                local character = LocalPlayer.Character
                if character then
                    local humanoid = character:FindFirstChild("Humanoid")
                    if humanoid then
                        humanoid.WalkSpeed = GetBaseWalkspeedFromAttribute(humanoid)
                    end
                end
            end
        end
        
        SaveConfigs()
    end)
    
    -- Keybind setter functionality
    setKeyBtn.MouseButton1Click:Connect(function()
        KeybindMode = true
        AwaitingKeybind = configKey
        AwaitingKeybindLabel = keyLbl
        setKeyBtn.Text = "..."
        setKeyBtn.BackgroundColor3 = Color3.fromRGB(255, 170, 0)
        task.wait(0.1)
        setKeyBtn.Text = "Set"
        setKeyBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
    end)
end

-- Regular toggle without keybind
local function CreateToggle(text, configKey, container)
    local container = container or ContentArea
    
    local toggleFrame = Instance.new("Frame")
    toggleFrame.BackgroundTransparency = 1
    toggleFrame.Size = UDim2.new(1, 0, 0, 24)
    toggleFrame.LayoutOrder = 1
    toggleFrame.Parent = container
    
    local btn = Instance.new("TextButton")
    btn.Text = ""
    btn.BackgroundColor3 = Config[configKey] and Color3.fromRGB(0, 120, 255) or Color3.fromRGB(40, 40, 40)
    btn.BorderSizePixel = 0
    btn.Position = UDim2.new(0, 5, 0, 4)
    btn.Size = UDim2.new(0, 16, 0, 16)
    btn.Parent = toggleFrame
    
    local lbl = Instance.new("TextLabel")
    lbl.Text = text
    lbl.Font = Enum.Font.SourceSans
    lbl.TextSize = 16
    lbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.BackgroundTransparency = 1
    lbl.Position = UDim2.new(0, 30, 0, 0)
    lbl.Size = UDim2.new(1, -30, 1, 0)
    lbl.Parent = toggleFrame
    
    btn.MouseButton1Click:Connect(function()
        Config[configKey] = not Config[configKey]
        btn.BackgroundColor3 = Config[configKey] and Color3.fromRGB(0, 120, 255) or Color3.fromRGB(40, 40, 40)
        SaveConfigs()
    end)
end

local function CreateSlider(text, configKey, min, max, container, isFloat, callback)
    local container = container or ContentArea
    
    local sliderFrame = Instance.new("Frame")
    sliderFrame.BackgroundTransparency = 1
    sliderFrame.Size = UDim2.new(1, 0, 0, 50)
    sliderFrame.LayoutOrder = 2
    sliderFrame.Parent = container
    
    local lbl = Instance.new("TextLabel")
    lbl.Text = text
    lbl.Font = Enum.Font.SourceSans
    lbl.TextSize = 16
    lbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.BackgroundTransparency = 1
    lbl.Position = UDim2.new(0, 5, 0, 0)
    lbl.Size = UDim2.new(1, -10, 0, 20)
    lbl.Parent = sliderFrame
    
    local sliderBg = Instance.new("Frame")
    sliderBg.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    sliderBg.BorderColor3 = Color3.fromRGB(50, 50, 50)
    sliderBg.BorderSizePixel = 1
    sliderBg.Position = UDim2.new(0, 5, 0, 25)
    sliderBg.Size = UDim2.new(1, -10, 0, 20)
    sliderBg.Parent = sliderFrame
    
    local sliderFill = Instance.new("Frame")
    sliderFill.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
    sliderFill.BorderSizePixel = 0
    sliderFill.Size = UDim2.new((Config[configKey] - min) / (max - min), 0, 1, 0)
    sliderFill.Parent = sliderBg
    
    local valueLbl = Instance.new("TextLabel")
    valueLbl.Text = isFloat and string.format("%.2f", Config[configKey]) or tostring(Config[configKey])
    valueLbl.Font = Enum.Font.Code
    valueLbl.TextSize = 14
    valueLbl.TextColor3 = Color3.fromRGB(255, 255, 255)
    valueLbl.BackgroundTransparency = 1
    valueLbl.Size = UDim2.new(1, 0, 1, 0)
    valueLbl.ZIndex = 2
    valueLbl.Parent = sliderBg
    
    local draggingSlider = false
    local function Update(input)
        local pos = input.Position.X
        local boxPos = sliderBg.AbsolutePosition.X
        local boxSize = sliderBg.AbsoluteSize.X
        local relative = math.clamp((pos - boxPos) / boxSize, 0, 1)
        local newVal = min + (max - min) * relative
        
        if not isFloat then
            newVal = math.floor(newVal)
        end
        
        Config[configKey] = newVal
        sliderFill.Size = UDim2.new(relative, 0, 1, 0)
        valueLbl.Text = isFloat and string.format("%.2f", newVal) or tostring(math.floor(newVal))
        
        if callback then
            callback(newVal)
        end
        
        SaveConfigs()
    end
    
    sliderBg.InputBegan:Connect(function(input) 
        if input.UserInputType == Enum.UserInputType.MouseButton1 then 
            draggingSlider = true 
            Update(input) 
        end 
    end)
    
    UserInputService.InputEnded:Connect(function(input) 
        if input.UserInputType == Enum.UserInputType.MouseButton1 then 
            draggingSlider = false 
        end 
    end)
    
    UserInputService.InputChanged:Connect(function(input) 
        if draggingSlider and input.UserInputType == Enum.UserInputType.MouseMovement then 
            Update(input) 
        end 
    end)
end

-- Build Main Tab
local function BuildMainTab()
    ClearContent()
    
    local pad = Instance.new("Frame")
    pad.Size = UDim2.new(1,0,0,5)
    pad.BackgroundTransparency = 1
    pad.LayoutOrder = 0
    pad.Parent = ContentArea
    
    CreateToggleWithKeybind("Master Enabled", "Enabled")
    CreateToggleWithKeybind("Show Player Names", "ShowNames")
    CreateToggleWithKeybind("Show NPCs (No Names)", "ShowNPCs")
    CreateToggleWithKeybind("Show Bars", "ShowBars")
    CreateToggleWithKeybind("Show Values", "ShowValues")
    CreateToggleWithKeybind("Enable Walkspeed Multiplier", "ShowWalkspeed")
    
    CreateSlider("Walkspeed Multiplier", "WalkspeedMultiplier", 0.5, 5, nil, true, function(newVal)
        if Config.ShowWalkspeed then
            ApplyWalkspeedMultiplier()
        end
    end)
    
    CreateSlider("Max Distance", "MaxDistance", 100, 5000)
    
    -- Current target display
    local targetFrame = Instance.new("Frame")
    targetFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    targetFrame.BorderSizePixel = 0
    targetFrame.Size = UDim2.new(1, 0, 0, 40)
    targetFrame.LayoutOrder = 10
    targetFrame.Parent = ContentArea
    
    local targetLbl = Instance.new("TextLabel")
    targetLbl.Text = "Current Target: "
    targetLbl.Font = Enum.Font.SourceSans
    targetLbl.TextSize = 16
    targetLbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    targetLbl.TextXAlignment = Enum.TextXAlignment.Left
    targetLbl.BackgroundTransparency = 1
    targetLbl.Position = UDim2.new(0, 5, 0, 10)
    targetLbl.Size = UDim2.new(1, -10, 0, 20)
    targetLbl.Parent = targetFrame
    
    -- Update target display
    RunService.Heartbeat:Connect(function()
        if CurrentTarget then
            targetLbl.Text = "Current Target: " .. CurrentTarget.Name
        else
            targetLbl.Text = "Current Target: None"
        end
    end)
    
    ContentArea.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y + 20)
end

-- AutoParry Functions
local PARRY_COOLDOWN = 2 -- seconds between parries on same source

local function StopAutoParry()
    if ParryConnection then
        ParryConnection:Disconnect()
        ParryConnection = nil
    end
    CurrentAnimations = {}
    DetectedAttacks = {}
    print("üõë AutoParry Stopped")
end

local function ExecuteParry()
    if not Config.AutoParryEnabled then return end
    
    local success, keyCode = pcall(function()
        return Enum.KeyCode[Config.ParryKey:upper()]
    end)
    
    if success and keyCode then
        VirtualInputManager:SendKeyEvent(true, keyCode, false, game)
        task.delay(0.05, function()
            VirtualInputManager:SendKeyEvent(false, keyCode, false, game)
        end)
    end
end

local function PlayAnimationAndParry(animationId)
    if not Config.AutoParryEnabled then return end
    
    -- Wait for configured delay then press parry key
    if Config.ParryDelay > 0 then
        task.delay(Config.ParryDelay, function()
            ExecuteParry()
            print("‚öîÔ∏è Parried animation: " .. animationId)
        end)
    else
        ExecuteParry()
        print("‚öîÔ∏è Parried animation: " .. animationId)
    end
end

-- Helper: get all characters to monitor (players + NPCs)
local function GetAllTargetCharacters()
    local characters = {}
    
    -- Add other players
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            table.insert(characters, {Character = player.Character, Name = player.Name})
        end
    end
    
    -- Add NPCs from Live folder
    if LiveFolder then
        for _, folder in ipairs(LiveFolder:GetChildren()) do
            local model = folder:IsA("Model") and folder or folder:FindFirstChildWhichIsA("Model")
            if model and model ~= LocalPlayer.Character then
                local player = Players:GetPlayerFromCharacter(model)
                if not player then -- it's an NPC
                    table.insert(characters, {Character = model, Name = model.Name})
                end
            end
        end
    end
    
    return characters
end

local function StartAutoParry()
    StopAutoParry()
    
    if not Config.AutoParryEnabled then return end
    if #Config.ParryAnimations == 0 then
        warn("‚ö†Ô∏è No animations added to AutoParry")
        return
    end
    
    print("üîÑ AutoParry Started - Monitoring " .. #Config.ParryAnimations .. " animations")
    
    ParryConnection = RunService.Heartbeat:Connect(function()
        if not Config.AutoParryEnabled then return end
        
        local now = tick()
        
        -- Clean up expired cooldowns
        for attackKey, expireTime in pairs(DetectedAttacks) do
            if now >= expireTime then
                DetectedAttacks[attackKey] = nil
            end
        end
        
        -- Check all characters (players + NPCs)
        for _, target in ipairs(GetAllTargetCharacters()) do
            local character = target.Character
            local targetName = target.Name
            
            local humanoid = character:FindFirstChild("Humanoid")
            if humanoid and humanoid.Health > 0 then
                local animator = humanoid:FindFirstChildOfClass("Animator")
                if animator then
                    for _, track in pairs(animator:GetPlayingAnimationTracks()) do
                        local animId = track.Animation and track.Animation.AnimationId
                        if animId and animId ~= "" then
                            for _, savedAnim in ipairs(Config.ParryAnimations) do
                                local attackKey = animId .. "_" .. targetName
                                if animId == savedAnim and not DetectedAttacks[attackKey] then
                                    -- Set cooldown using timestamp (no task.wait in Heartbeat)
                                    DetectedAttacks[attackKey] = now + PARRY_COOLDOWN
                                    print("‚ö†Ô∏è Attack detected from " .. targetName .. ": " .. animId)
                                    PlayAnimationAndParry(savedAnim)
                                end
                            end
                        end
                    end
                end
            end
        end
    end)
end

-- Build AutoParry Tab
local function BuildAutoParryTab()
    ClearContent()
    
    local pad = Instance.new("Frame")
    pad.Size = UDim2.new(1,0,0,5)
    pad.BackgroundTransparency = 1
    pad.LayoutOrder = 0
    pad.Parent = ContentArea
    
    CreateToggleWithKeybind("Enable AutoParry", "AutoParryEnabled")
    
    -- Animation List
    local listFrame = Instance.new("Frame")
    listFrame.BackgroundTransparency = 1
    listFrame.Size = UDim2.new(1, 0, 0, 200)
    listFrame.LayoutOrder = 1
    listFrame.Parent = ContentArea
    
    local listLbl = Instance.new("TextLabel")
    listLbl.Text = "Parry Animations (" .. #Config.ParryAnimations .. ")"
    listLbl.Font = Enum.Font.SourceSans
    listLbl.TextSize = 16
    listLbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    listLbl.TextXAlignment = Enum.TextXAlignment.Left
    listLbl.BackgroundTransparency = 1
    listLbl.Position = UDim2.new(0, 5, 0, 0)
    listLbl.Size = UDim2.new(1, -10, 0, 20)
    listLbl.Parent = listFrame
    
    -- Manual animation input
    local animInput = Instance.new("TextBox")
    animInput.Text = ""
    animInput.PlaceholderText = "Enter Animation ID and press Enter"
    animInput.Font = Enum.Font.SourceSans
    animInput.TextSize = 16
    animInput.TextColor3 = Color3.fromRGB(255, 255, 255)
    animInput.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    animInput.BorderSizePixel = 0
    animInput.Position = UDim2.new(0, 5, 0, 25)
    animInput.Size = UDim2.new(1, -10, 0, 30)
    animInput.Parent = listFrame
    
    animInput.FocusLost:Connect(function(enterPressed)
        if enterPressed and animInput.Text ~= "" then
            table.insert(Config.ParryAnimations, animInput.Text)
            animInput.Text = ""
            SaveConfigs()
            BuildAutoParryTab()
        end
    end)
    
    -- Animation list scrolling frame
    local animList = Instance.new("ScrollingFrame")
    animList.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    animList.BorderSizePixel = 0
    animList.Position = UDim2.new(0, 5, 0, 60)
    animList.Size = UDim2.new(1, -10, 0, 130)
    animList.CanvasSize = UDim2.new(0, 0, 0, 0)
    animList.ScrollBarThickness = 6
    animList.AutomaticCanvasSize = Enum.AutomaticSize.Y
    animList.Parent = listFrame
    
    local animListLayout = Instance.new("UIListLayout")
    animListLayout.Parent = animList
    animListLayout.Padding = UDim.new(0, 2)
    
    for i, animId in ipairs(Config.ParryAnimations) do
        local animItem = Instance.new("Frame")
        animItem.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        animItem.Size = UDim2.new(1, 0, 0, 25)
        animItem.Parent = animList
        
        local animLabel = Instance.new("TextLabel")
        animLabel.Text = i .. ". " .. animId
        animLabel.Font = Enum.Font.SourceSans
        animLabel.TextSize = 12
        animLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
        animLabel.TextXAlignment = Enum.TextXAlignment.Left
        animLabel.BackgroundTransparency = 1
        animLabel.Position = UDim2.new(0, 5, 0, 0)
        animLabel.Size = UDim2.new(1, -35, 1, 0)
        animLabel.Parent = animItem
        
        local removeBtn = Instance.new("TextButton")
        removeBtn.Text = "X"
        removeBtn.Font = Enum.Font.SourceSansBold
        removeBtn.TextSize = 16
        removeBtn.TextColor3 = Color3.fromRGB(255, 100, 100)
        removeBtn.BackgroundColor3 = Color3.fromRGB(60, 0, 0)
        removeBtn.BorderSizePixel = 0
        removeBtn.Position = UDim2.new(1, -25, 0, 2)
        removeBtn.Size = UDim2.new(0, 20, 0, 20)
        removeBtn.Parent = animItem
        
        removeBtn.MouseButton1Click:Connect(function()
            table.remove(Config.ParryAnimations, i)
            SaveConfigs()
            BuildAutoParryTab()
        end)
    end
    
    CreateSlider("Parry Delay (seconds)", "ParryDelay", 0, 1, nil, true)
    
    -- Key Selection
    local keyFrame = Instance.new("Frame")
    keyFrame.BackgroundTransparency = 1
    keyFrame.Size = UDim2.new(1, 0, 0, 50)
    keyFrame.LayoutOrder = 3
    keyFrame.Parent = ContentArea
    
    local keyLbl = Instance.new("TextLabel")
    keyLbl.Text = "Parry Key"
    keyLbl.Font = Enum.Font.SourceSans
    keyLbl.TextSize = 16
    keyLbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    keyLbl.TextXAlignment = Enum.TextXAlignment.Left
    keyLbl.BackgroundTransparency = 1
    keyLbl.Position = UDim2.new(0, 5, 0, 0)
    keyLbl.Size = UDim2.new(1, -10, 0, 20)
    keyLbl.Parent = keyFrame
    
    local keyBox = Instance.new("TextBox")
    keyBox.Text = Config.ParryKey
    keyBox.PlaceholderText = "F"
    keyBox.Font = Enum.Font.SourceSans
    keyBox.TextSize = 16
    keyBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    keyBox.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    keyBox.BorderSizePixel = 0
    keyBox.Position = UDim2.new(0, 5, 0, 25)
    keyBox.Size = UDim2.new(1, -10, 0, 20)
    keyBox.Parent = keyFrame
    
    keyBox.FocusLost:Connect(function()
        Config.ParryKey = keyBox.Text:upper()
        SaveConfigs()
    end)
    
    -- Test Button
    local testBtn = Instance.new("TextButton")
    testBtn.Text = "Test Parry (First Animation)"
    testBtn.Font = Enum.Font.SourceSans
    testBtn.TextSize = 18
    testBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    testBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
    testBtn.BorderSizePixel = 0
    testBtn.Size = UDim2.new(1, -10, 0, 40)
    testBtn.Position = UDim2.new(0, 5, 0, 0)
    testBtn.LayoutOrder = 4
    testBtn.Parent = ContentArea
    
    testBtn.MouseButton1Click:Connect(function()
        if #Config.ParryAnimations == 0 then
            SendNotification("Error", "Please add animations first", 3)
            return
        end
        PlayAnimationAndParry(Config.ParryAnimations[1])
    end)
    
    ContentArea.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y + 20)
end

-- Build Fetch Animations Tab
local function BuildFetchTab()
    ClearContent()
    
    local pad = Instance.new("Frame")
    pad.Size = UDim2.new(1,0,0,5)
    pad.BackgroundTransparency = 1
    pad.LayoutOrder = 0
    pad.Parent = ContentArea
    
    CreateToggleWithKeybind("Enable Animation Fetch", "FetchAnimationsEnabled")
    CreateToggle("Fetch from Nearest Target", "FetchFromTarget")
    CreateToggle("Auto-Add Fetched to Parry List", "AutoAddFetched")
    
    -- Manual fetch button
    local fetchBtn = Instance.new("TextButton")
    fetchBtn.Text = "üîÑ Fetch Now"
    fetchBtn.Font = Enum.Font.SourceSans
    fetchBtn.TextSize = 18
    fetchBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    fetchBtn.BackgroundColor3 = Color3.fromRGB(255, 170, 0)
    fetchBtn.BorderSizePixel = 0
    fetchBtn.Size = UDim2.new(1, -10, 0, 40)
    fetchBtn.LayoutOrder = 3
    fetchBtn.Parent = ContentArea
    
    fetchBtn.MouseButton1Click:Connect(function()
        local target = GetNearestTarget()
        if target then
            local fetched = FetchAnimationsFromTarget(target)
            if fetched and #fetched > 0 then
                SendNotification(
                    "‚úÖ Fetched Animations",
                    "Found " .. #fetched .. " animations from " .. target.Name,
                    3
                )
            else
                SendNotification(
                    "‚ÑπÔ∏è No New Animations",
                    "No new animations found from " .. target.Name,
                    3
                )
            end
        else
            SendNotification("Error", "No target found", 3)
        end
    end)
    
    -- Fetched animations display
    local fetchedFrame = Instance.new("Frame")
    fetchedFrame.BackgroundTransparency = 1
    fetchedFrame.Size = UDim2.new(1, 0, 0, 150)
    fetchedFrame.LayoutOrder = 4
    fetchedFrame.Parent = ContentArea
    
    local fetchedLbl = Instance.new("TextLabel")
    fetchedLbl.Text = "Recently Fetched Animations"
    fetchedLbl.Font = Enum.Font.SourceSans
    fetchedLbl.TextSize = 16
    fetchedLbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    fetchedLbl.TextXAlignment = Enum.TextXAlignment.Left
    fetchedLbl.BackgroundTransparency = 1
    fetchedLbl.Position = UDim2.new(0, 5, 0, 0)
    fetchedLbl.Size = UDim2.new(1, -10, 0, 20)
    fetchedLbl.Parent = fetchedFrame
    
    local fetchedList = Instance.new("ScrollingFrame")
    fetchedList.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    fetchedList.BorderSizePixel = 0
    fetchedList.Position = UDim2.new(0, 5, 0, 25)
    fetchedList.Size = UDim2.new(1, -10, 0, 115)
    fetchedList.CanvasSize = UDim2.new(0, 0, 0, 0)
    fetchedList.ScrollBarThickness = 6
    fetchedList.AutomaticCanvasSize = Enum.AutomaticSize.Y
    fetchedList.Parent = fetchedFrame
    
    local fetchedListLayout = Instance.new("UIListLayout")
    fetchedListLayout.Parent = fetchedList
    fetchedListLayout.Padding = UDim.new(0, 2)
    
    -- Update fetched list display
    local function UpdateFetchedDisplay()
        for _, child in pairs(fetchedList:GetChildren()) do
            if child:IsA("Frame") then
                child:Destroy()
            end
        end
        
        for i, animId in ipairs(FetchedAnimationList) do
            local animItem = Instance.new("Frame")
            animItem.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
            animItem.Size = UDim2.new(1, 0, 0, 25)
            animItem.Parent = fetchedList
            
            local animLabel = Instance.new("TextLabel")
            animLabel.Text = i .. ". " .. animId
            animLabel.Font = Enum.Font.SourceSans
            animLabel.TextSize = 12
            animLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
            animLabel.TextXAlignment = Enum.TextXAlignment.Left
            animLabel.BackgroundTransparency = 1
            animLabel.Position = UDim2.new(0, 5, 0, 0)
            animLabel.Size = UDim2.new(1, -5, 1, 0)
            animLabel.Parent = animItem
        end
    end
    
    -- Update every second
    task.spawn(function()
        while task.wait(1) do
            UpdateFetchedDisplay()
        end
    end)
    
    ContentArea.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y + 20)
end

-- Build Keybinds Tab
local function BuildKeybindsTab()
    ClearContent()
    
    local pad = Instance.new("Frame")
    pad.Size = UDim2.new(1,0,0,5)
    pad.BackgroundTransparency = 1
    pad.LayoutOrder = 0
    pad.Parent = ContentArea
    
    -- Menu Key
    local menuFrame = Instance.new("Frame")
    menuFrame.BackgroundTransparency = 1
    menuFrame.Size = UDim2.new(1, 0, 0, 50)
    menuFrame.LayoutOrder = 1
    menuFrame.Parent = ContentArea
    
    local menuLbl = Instance.new("TextLabel")
    menuLbl.Text = "Menu Toggle Key"
    menuLbl.Font = Enum.Font.SourceSans
    menuLbl.TextSize = 16
    menuLbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    menuLbl.TextXAlignment = Enum.TextXAlignment.Left
    menuLbl.BackgroundTransparency = 1
    menuLbl.Position = UDim2.new(0, 5, 0, 0)
    menuLbl.Size = UDim2.new(0.5, -10, 0, 20)
    menuLbl.Parent = menuFrame
    
    local menuKeyBox = Instance.new("TextBox")
    menuKeyBox.Text = Config.MenuKey
    menuKeyBox.Font = Enum.Font.SourceSans
    menuKeyBox.TextSize = 16
    menuKeyBox.TextColor3 = Color3.fromRGB(255, 255, 0)
    menuKeyBox.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    menuKeyBox.BorderSizePixel = 0
    menuKeyBox.Position = UDim2.new(0.5, 5, 0, 0)
    menuKeyBox.Size = UDim2.new(0.5, -10, 0, 30)
    menuKeyBox.Parent = menuFrame
    
    menuKeyBox.FocusLost:Connect(function()
        Config.MenuKey = menuKeyBox.Text:upper()
        SaveConfigs()
    end)
    
    -- Info text
    local infoLbl = Instance.new("TextLabel")
    infoLbl.Text = "Click 'Set' next to any toggle to assign a keybind"
    infoLbl.Font = Enum.Font.SourceSans
    infoLbl.TextSize = 14
    infoLbl.TextColor3 = Color3.fromRGB(255, 170, 0)
    infoLbl.BackgroundTransparency = 1
    infoLbl.Size = UDim2.new(1, -10, 0, 30)
    infoLbl.LayoutOrder = 2
    infoLbl.Parent = ContentArea
    
    -- Keybind list
    local keybindList = Instance.new("Frame")
    keybindList.BackgroundTransparency = 1
    keybindList.Size = UDim2.new(1, 0, 0, 400)
    keybindList.LayoutOrder = 3
    keybindList.Parent = ContentArea
    
    local yPos = 0
    for setting, key in pairs(Config.Keybinds) do
        local row = Instance.new("Frame")
        row.BackgroundTransparency = 1
        row.Size = UDim2.new(1, 0, 0, 30)
        row.Position = UDim2.new(0, 0, 0, yPos)
        row.Parent = keybindList
        
        local nameLbl = Instance.new("TextLabel")
        nameLbl.Text = setting
        nameLbl.Font = Enum.Font.SourceSans
        nameLbl.TextSize = 16
        nameLbl.TextColor3 = Color3.fromRGB(200, 200, 200)
        nameLbl.TextXAlignment = Enum.TextXAlignment.Left
        nameLbl.BackgroundTransparency = 1
        nameLbl.Position = UDim2.new(0, 5, 0, 5)
        nameLbl.Size = UDim2.new(0.4, -10, 0, 20)
        nameLbl.Parent = row
        
        local keyLbl = Instance.new("TextLabel")
        keyLbl.Text = key
        keyLbl.Font = Enum.Font.SourceSans
        keyLbl.TextSize = 16
        keyLbl.TextColor3 = Color3.fromRGB(255, 255, 0)
        keyLbl.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        keyLbl.Position = UDim2.new(0.4, 5, 0, 5)
        keyLbl.Size = UDim2.new(0.3, -10, 0, 20)
        keyLbl.TextXAlignment = Enum.TextXAlignment.Center
        keyLbl.Parent = row
        
        local setBtn = Instance.new("TextButton")
        setBtn.Text = "Set"
        setBtn.Font = Enum.Font.SourceSans
        setBtn.TextSize = 16
        setBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        setBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
        setBtn.BorderSizePixel = 0
        setBtn.Position = UDim2.new(0.7, 5, 0, 5)
        setBtn.Size = UDim2.new(0.3, -10, 0, 20)
        setBtn.Parent = row
        
        setBtn.MouseButton1Click:Connect(function()
            KeybindMode = true
            AwaitingKeybind = setting
            AwaitingKeybindLabel = keyLbl
            setBtn.Text = "..."
            setBtn.BackgroundColor3 = Color3.fromRGB(255, 170, 0)
            task.wait(0.1)
            setBtn.Text = "Set"
            setBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
        end)
        
        yPos = yPos + 35
    end
    
    keybindList.Size = UDim2.new(1, 0, 0, yPos)
    
    ContentArea.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y + 20)
end

-- Build Config Tab
local function BuildConfigTab()
    ClearContent()
    
    local selectFrame = Instance.new("Frame")
    selectFrame.BackgroundTransparency = 1
    selectFrame.Size = UDim2.new(1, 0, 0, 50)
    selectFrame.LayoutOrder = 1
    selectFrame.Parent = ContentArea
    
    local selectLbl = Instance.new("TextLabel")
    selectLbl.Text = "Current Config: " .. CurrentConfig
    selectLbl.Font = Enum.Font.SourceSans
    selectLbl.TextSize = 16
    selectLbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    selectLbl.TextXAlignment = Enum.TextXAlignment.Left
    selectLbl.BackgroundTransparency = 1
    selectLbl.Position = UDim2.new(0, 5, 0, 0)
    selectLbl.Size = UDim2.new(1, -10, 0, 20)
    selectLbl.Parent = selectFrame
    
    local btnFrame = Instance.new("Frame")
    btnFrame.BackgroundTransparency = 1
    btnFrame.Size = UDim2.new(1, 0, 0, 40)
    btnFrame.LayoutOrder = 2
    btnFrame.Parent = ContentArea
    
    local saveBtn = Instance.new("TextButton")
    saveBtn.Text = "Save Config"
    saveBtn.Font = Enum.Font.SourceSans
    saveBtn.TextSize = 16
    saveBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    saveBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
    saveBtn.BorderSizePixel = 0
    saveBtn.Position = UDim2.new(0, 5, 0, 0)
    saveBtn.Size = UDim2.new(0.5, -10, 0, 30)
    saveBtn.Parent = btnFrame
    
    local loadBtn = Instance.new("TextButton")
    loadBtn.Text = "Load Default"
    loadBtn.Font = Enum.Font.SourceSans
    loadBtn.TextSize = 16
    loadBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    loadBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
    loadBtn.BorderSizePixel = 0
    loadBtn.Position = UDim2.new(0.5, 5, 0, 0)
    loadBtn.Size = UDim2.new(0.5, -10, 0, 30)
    loadBtn.Parent = btnFrame
    
    saveBtn.MouseButton1Click:Connect(function()
        local configCopy = {}
        for k, v in pairs(Config) do
            configCopy[k] = v
        end
        Configs[CurrentConfig] = configCopy
        SaveConfigs()
        saveBtn.Text = "Saved!"
        saveBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
        task.wait(1)
        saveBtn.Text = "Save Config"
        saveBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
    end)
    
    loadBtn.MouseButton1Click:Connect(function()
        if Configs["Default"] then
            for k, v in pairs(Configs["Default"]) do
                Config[k] = v
            end
            
            if Config.ShowWalkspeed then
                ApplyWalkspeedMultiplier()
                StartWalkspeedMonitoring()
            end
            
            if Config.AutoParryEnabled then
                StartAutoParry()
            else
                StopAutoParry()
            end
            
            if Config.FetchAnimationsEnabled then
                StartAnimationFetching()
            end
            
            SaveConfigs()
            
            loadBtn.Text = "Loaded!"
            loadBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
            task.wait(1)
            loadBtn.Text = "Load Default"
            loadBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
        end
    end)
    
    ContentArea.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y + 20)
end

-- Tab switching
MainTabBtn.MouseButton1Click:Connect(function()
    MainTabBtn.TextColor3 = Color3.fromRGB(0, 120, 255)
    MainTabBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    AutoParryTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    AutoParryTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    FetchTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    FetchTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    KeybindsTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    KeybindsTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    ConfigTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    ConfigTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    BuildMainTab()
end)

AutoParryTabBtn.MouseButton1Click:Connect(function()
    AutoParryTabBtn.TextColor3 = Color3.fromRGB(0, 120, 255)
    AutoParryTabBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    MainTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    MainTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    FetchTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    FetchTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    KeybindsTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    KeybindsTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    ConfigTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    ConfigTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    BuildAutoParryTab()
end)

FetchTabBtn.MouseButton1Click:Connect(function()
    FetchTabBtn.TextColor3 = Color3.fromRGB(0, 120, 255)
    FetchTabBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    MainTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    MainTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    AutoParryTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    AutoParryTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    KeybindsTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    KeybindsTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    ConfigTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    ConfigTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    BuildFetchTab()
end)

KeybindsTabBtn.MouseButton1Click:Connect(function()
    KeybindsTabBtn.TextColor3 = Color3.fromRGB(0, 120, 255)
    KeybindsTabBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    MainTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    MainTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    AutoParryTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    AutoParryTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    FetchTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    FetchTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    ConfigTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    ConfigTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    BuildKeybindsTab()
end)

ConfigTabBtn.MouseButton1Click:Connect(function()
    ConfigTabBtn.TextColor3 = Color3.fromRGB(0, 120, 255)
    ConfigTabBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    MainTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    MainTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    AutoParryTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    AutoParryTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    FetchTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    FetchTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    KeybindsTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    KeybindsTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    BuildConfigTab()
end)

BuildMainTab()

-- Keybind handling function (defined here so all referenced functions exist)
local function HandleKeybind(key)
    if KeybindMode then
        -- We're setting a keybind
        if AwaitingKeybind and AwaitingKeybindLabel then
            local settingName = AwaitingKeybind -- save before clearing
            Config.Keybinds[AwaitingKeybind] = key
            AwaitingKeybindLabel.Text = "Key: " .. key
            KeybindMode = false
            AwaitingKeybind = nil
            AwaitingKeybindLabel = nil
            SaveConfigs()
            SendNotification("Keybind Set", settingName .. " bound to " .. key, 2)
        end
        return
    end
    
    -- Check other keybinds
    for setting, boundKey in pairs(Config.Keybinds) do
        if key == boundKey then
            if Config[setting] ~= nil then
                Config[setting] = not Config[setting]
                
                -- Handle special cases
                if setting == "AutoParryEnabled" then
                    if Config.AutoParryEnabled then
                        StartAutoParry()
                    else
                        StopAutoParry()
                    end
                elseif setting == "FetchAnimationsEnabled" then
                    if Config.FetchAnimationsEnabled then
                        StartAnimationFetching()
                    else
                        if FetchConnection then
                            FetchConnection:Disconnect()
                            FetchConnection = nil
                        end
                    end
                elseif setting == "ShowWalkspeed" then
                    if Config.ShowWalkspeed then
                        ApplyWalkspeedMultiplier()
                        StartWalkspeedMonitoring()
                    else
                        local character = LocalPlayer.Character
                        if character then
                            local humanoid = character:FindFirstChild("Humanoid")
                            if humanoid then
                                humanoid.WalkSpeed = GetBaseWalkspeedFromAttribute(humanoid)
                            end
                        end
                    end
                end
                
                SendNotification("Toggled", setting .. ": " .. tostring(Config[setting]), 1)
                SaveConfigs()
                
                -- Refresh UI if we're on the main tab
                if MainTabBtn and MainTabBtn.TextColor3 == Color3.fromRGB(0, 120, 255) then
                    BuildMainTab()
                end
            end
            break
        end
    end
end

-- Connect keybind input AFTER GUI is constructed
UserInputService.InputBegan:Connect(function(input, processed)
    if input.UserInputType == Enum.UserInputType.Keyboard then
        local keyName = input.KeyCode.Name
        
        -- Allow menu key even if GUI processed input
        if keyName == Config.MenuKey then
            MainFrame.Visible = not MainFrame.Visible
            return
        end
        
        -- For other keybinds, respect processed flag
        if not processed then
            HandleKeybind(keyName)
        end
    end
end)

--------------------------------------------------------------------------------
-- 2. ESP SYSTEM (NPC Names Hidden)
--------------------------------------------------------------------------------

local function CreateDrawing(type, props)
    local obj = Drawing.new(type)
    for k, v in pairs(props) do obj[k] = v end
    return obj
end

local function RemoveESP(model)
    if ESP_Cache[model] then
        for _, drawing in pairs(ESP_Cache[model].Drawings) do
            drawing:Remove()
        end
        ESP_Cache[model] = nil
    end
end

RunService.RenderStepped:Connect(function()
    if not Config.Enabled then 
        for model, _ in pairs(ESP_Cache) do RemoveESP(model) end
        return 
    end

    if not LiveFolder then LiveFolder = workspace:FindFirstChild("Live") return end

    for _, entry in pairs(ESP_Cache) do entry.Seen = false end

    for _, folder in ipairs(LiveFolder:GetChildren()) do
        local model = folder:IsA("Model") and folder or folder:FindFirstChildWhichIsA("Model")
        
        if model and model ~= LocalPlayer.Character then
            
            local head = model:FindFirstChild("Head")
            local humanoid = model:FindFirstChild("Humanoid")
            local player = Players:GetPlayerFromCharacter(model)

            if player and humanoid then
                pcall(function()
                     humanoid.HealthDisplayType = Enum.HumanoidHealthDisplayType.AlwaysOn
                end)
            end

            local isNPC = not player

            if isNPC and not Config.ShowNPCs then
                if ESP_Cache[model] then RemoveESP(model) end
                continue
            end

            if head and humanoid then
                if not ESP_Cache[model] then
                    ESP_Cache[model] = {
                        Seen = true,
                        Drawings = {
                            Name = CreateDrawing("Text", {Center = true, Outline = true, Color = Color3.new(1,1,1), Size = Config.TextSize}),
                            Bar1Bg = CreateDrawing("Square", {Filled = true, Color = Color3.new(0.1,0.1,0.1), Transparency = 0.8}),
                            Bar1Fill = CreateDrawing("Square", {Filled = true, Transparency = 1}),
                            Bar1Text = CreateDrawing("Text", {Center = false, Outline = true, Color = Color3.new(1,1,1), Size = 13}),
                            Bar2Bg = CreateDrawing("Square", {Filled = true, Color = Color3.new(0.1,0.1,0.1), Transparency = 0.8}),
                            Bar2Fill = CreateDrawing("Square", {Filled = true, Transparency = 1}),
                            Bar2Text = CreateDrawing("Text", {Center = false, Outline = true, Color = Color3.new(1,1,1), Size = 13}),
                            Bar3Bg = CreateDrawing("Square", {Filled = true, Color = Color3.new(0.1,0.1,0.1), Transparency = 0.8}),
                            Bar3Fill = CreateDrawing("Square", {Filled = true, Transparency = 1}),
                            Bar3Text = CreateDrawing("Text", {Center = false, Outline = true, Color = Color3.new(1,1,1), Size = 13}),
                        }
                    }
                end

                local entry = ESP_Cache[model]
                entry.Seen = true
                local d = entry.Drawings

                local vector, onScreen = Camera:WorldToViewportPoint(head.Position)
                local distance = (Camera.CFrame.Position - head.Position).Magnitude

                if onScreen and distance <= Config.MaxDistance then
                    
                    local val1, min1, max1, color1 = 0, 0, 100, Color3.new(1, 0, 0)
                    local val2, min2, max2, color2 = 0, 0, 100, Color3.new(1, 1, 0)
                    local showBar2 = false
                    local showBar3 = false
                    local cleanName = ""

                    if isNPC then
                        val1 = humanoid.Health
                        max1 = humanoid.MaxHealth
                        min1 = 0
                        color1 = Color3.new(0.2, 0.9, 0.2)
                        showBar2 = false
                        showBar3 = false
                        cleanName = ""
                    else
                        local lf = folder:FindFirstChild("Lifeforce") or model:FindFirstChild("Lifeforce")
                        local pos = folder:FindFirstChild("Posture") or model:FindFirstChild("Posture")
                        
                        if lf then 
                            val1 = lf.Value 
                            max1 = lf:GetAttribute("MaxValue") or lf.MaxValue or 100
                            min1 = lf:GetAttribute("MinValue") or lf.MinValue or 0
                        end
                        if pos then 
                            val2 = pos.Value 
                            max2 = pos:GetAttribute("MaxValue") or pos.MaxValue or 100
                            min2 = pos:GetAttribute("MinValue") or pos.MinValue or 0
                            showBar2 = true
                        end
                        
                        if Config.ShowWalkspeed then
                            showBar3 = true
                        end
                        
                        color1 = Color3.new(0.9, 0.2, 0.2)
                        cleanName = player and player.Name or ""
                    end

                    local range1 = max1 - min1
                    local pct1 = range1 > 0 and math.clamp((val1 - min1) / range1, 0, 1) or 0
                    
                    local range2 = max2 - min2
                    local pct2 = range2 > 0 and math.clamp((val2 - min2) / range2, 0, 1) or 0

                    local screenPos = Vector2.new(vector.X, vector.Y)
                    local startY = screenPos.Y - Config.YOffset - (1000/distance)

                    if Config.ShowNames and not isNPC and cleanName ~= "" then
                        d.Name.Visible = true
                        d.Name.Text = cleanName
                        d.Name.Position = screenPos - Vector2.new(0, Config.YOffset + 15 + (showBar3 and 20 or 0))
                        d.Name.Size = Config.TextSize
                    else
                        d.Name.Visible = false
                    end

                    if Config.ShowBars then
                        local barPos = Vector2.new(screenPos.X - (Config.BarWidth / 2), startY)
                        local currentY = startY
                        
                        if showBar3 and not isNPC then
                            local baseSpeed = GetBaseWalkspeedFromAttribute(humanoid)
                            local pct3 = math.clamp(humanoid.WalkSpeed / (baseSpeed * 3), 0, 1)
                            
                            local bar3Pos = Vector2.new(screenPos.X - (Config.BarWidth / 2), currentY)
                            
                            d.Bar3Bg.Visible = true
                            d.Bar3Bg.Size = Vector2.new(Config.BarWidth, Config.BarHeight)
                            d.Bar3Bg.Position = bar3Pos
                            d.Bar3Fill.Visible = true
                            d.Bar3Fill.Size = Vector2.new(Config.BarWidth * pct3, Config.BarHeight)
                            d.Bar3Fill.Position = bar3Pos
                            d.Bar3Fill.Color = Color3.new(0.2, 0.6, 1)

                            if Config.ShowValues then
                                d.Bar3Text.Visible = true
                                d.Bar3Text.Text = string.format("Spd: %.1f", humanoid.WalkSpeed)
                                d.Bar3Text.Position = bar3Pos + Vector2.new(Config.BarWidth + 5, -3)
                            else
                                d.Bar3Text.Visible = false
                            end
                            
                            currentY = currentY + Config.BarHeight + 2
                        else
                            d.Bar3Bg.Visible = false
                            d.Bar3Fill.Visible = false
                            d.Bar3Text.Visible = false
                        end
                        
                        if showBar2 then
                            local bar2Pos = Vector2.new(screenPos.X - (Config.BarWidth / 2), currentY)
                            
                            d.Bar2Bg.Visible = true
                            d.Bar2Bg.Size = Vector2.new(Config.BarWidth, Config.BarHeight)
                            d.Bar2Bg.Position = bar2Pos
                            d.Bar2Fill.Visible = true
                            d.Bar2Fill.Size = Vector2.new(Config.BarWidth * pct2, Config.BarHeight)
                            d.Bar2Fill.Position = bar2Pos
                            d.Bar2Fill.Color = color2

                            if Config.ShowValues then
                                d.Bar2Text.Visible = true
                                d.Bar2Text.Text = string.format("%.0f/%.0f", val2, max2)
                                d.Bar2Text.Position = bar2Pos + Vector2.new(Config.BarWidth + 5, -3)
                            else
                                d.Bar2Text.Visible = false
                            end
                            
                            currentY = currentY + Config.BarHeight + 2
                        else
                            d.Bar2Bg.Visible = false
                            d.Bar2Fill.Visible = false
                            d.Bar2Text.Visible = false
                        end
                        
                        local bar1Pos = Vector2.new(screenPos.X - (Config.BarWidth / 2), currentY)
                        
                        d.Bar1Bg.Visible = true
                        d.Bar1Bg.Size = Vector2.new(Config.BarWidth, Config.BarHeight)
                        d.Bar1Bg.Position = bar1Pos
                        d.Bar1Fill.Visible = true
                        d.Bar1Fill.Size = Vector2.new(Config.BarWidth * pct1, Config.BarHeight)
                        d.Bar1Fill.Position = bar1Pos
                        d.Bar1Fill.Color = color1

                        if Config.ShowValues then
                            d.Bar1Text.Visible = true
                            d.Bar1Text.Text = string.format("%.0f/%.0f", val1, max1)
                            d.Bar1Text.Position = bar1Pos + Vector2.new(Config.BarWidth + 5, -3)
                        else
                            d.Bar1Text.Visible = false
                        end

                    else
                        d.Bar1Bg.Visible = false
                        d.Bar1Fill.Visible = false
                        d.Bar1Text.Visible = false
                        d.Bar2Bg.Visible = false
                        d.Bar2Fill.Visible = false
                        d.Bar2Text.Visible = false
                        d.Bar3Bg.Visible = false
                        d.Bar3Fill.Visible = false
                        d.Bar3Text.Visible = false
                    end

                else
                    for _, v in pairs(d) do v.Visible = false end
                end
            end
        end
    end

    for model, entry in pairs(ESP_Cache) do
        if not entry.Seen or not model.Parent then
            RemoveESP(model)
        end
    end
end)

-- Moderator Detector with Sound Notification
-- Detects players with specific roles in Demon Corps North Branch (Group ID: 16346602)
-- Plays Patrick WeeWoo sound when a moderator joins

local MODERATOR_ROLES = {
    ["tes"] = true,
    ["admin"] = true,
    ["Owner"] = true,
}
local ALERT_SOUND_ID = "rbxassetid://427090811"

-- Track online moderators
local OnlineModerators = {}

-- Function to check if a player is a moderator
local function IsModerator(player)
    local success, role = pcall(function()
        return player:GetRoleInGroup(16346602)
    end)
    
    if success and role then
        return MODERATOR_ROLES[role] == true, role
    end
    return false, nil
end

-- Function to play alert sound
local function PlayAlertSound()
    local sound = Instance.new("Sound")
    sound.SoundId = ALERT_SOUND_ID
    sound.Volume = 0.8
    sound.PlayOnRemove = false
    
    local character = LocalPlayer.Character
    if character then
        sound.Parent = character
    else
        sound.Parent = SoundService
    end
    
    sound:Play()
    print("üîä Playing alert sound: Patrick WeeWoo")
    
    game:GetService("Debris"):AddItem(sound, sound.TimeLength or 5)
end

-- Function to send notification
local function SendNotification(title, text, duration, icon)
    StarterGui:SetCore("SendNotification", {
        Title = title,
        Text = text,
        Duration = duration or 5,
        Icon = icon or "rbxasset://textures/ui/GameSettings/GFX/icon_alert.png"
    })
end

-- Function to check existing players
local function CheckExistingPlayers()
    local mods = {}
    local modCount = 0
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local isMod, role = IsModerator(player)
            if isMod then
                mods[player] = role
                OnlineModerators[player] = role
                modCount = modCount + 1
            end
        end
    end
    
    if modCount > 0 then
        local modNames = {}
        for player, role in pairs(mods) do
            table.insert(modNames, player.Name .. " (" .. role .. ")")
        end
        
        SendNotification(
            "‚ö†Ô∏è Moderators Online",
            table.concat(modNames, "\n"),
            8
        )
        
        PlayAlertSound()
        
        print("‚ö†Ô∏è " .. modCount .. " moderator(s) online at startup")
    end
end

-- Monitor player joins
Players.PlayerAdded:Connect(function(player)
    task.wait(2)
    
    if player ~= LocalPlayer then
        local isMod, role = IsModerator(player)
        if isMod then
            OnlineModerators[player] = role
            
            PlayAlertSound()
            
            SendNotification(
                "‚ö†Ô∏è Moderator Joined",
                player.Name .. " (" .. role .. ") has joined the game!",
                6
            )
            
            print("‚ö†Ô∏è MODERATOR JOINED: " .. player.Name .. " (" .. role .. ")")
        end
    end
end)

-- Monitor player leaves
Players.PlayerRemoving:Connect(function(player)
    if OnlineModerators[player] then
        local role = OnlineModerators[player]
        OnlineModerators[player] = nil
        
        SendNotification(
            "‚ÑπÔ∏è Moderator Left",
            player.Name .. " (" .. role .. ") has left the game.",
            4,
            "rbxasset://textures/ui/GameSettings/GFX/icon_info.png"
        )
        
        print("‚ÑπÔ∏è MODERATOR LEFT: " .. player.Name .. " (" .. role .. ")")
    end
end)

-- Periodic check for role changes
task.spawn(function()
    while task.wait(30) do
        local currentMods = {}
        
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                local isMod, role = IsModerator(player)
                if isMod then
                    currentMods[player] = role
                end
            end
        end
        
        for player, role in pairs(currentMods) do
            if not OnlineModerators[player] then
                OnlineModerators[player] = role
                
                PlayAlertSound()
                
                SendNotification(
                    "‚ö†Ô∏è Moderator Detected",
                    player.Name .. " (" .. role .. ") is now a moderator!",
                    6
                )
                
                print("‚ö†Ô∏è NEW MODERATOR DETECTED: " .. player.Name .. " (" .. role .. ")")
            end
        end
        
        for player in pairs(OnlineModerators) do
            if not currentMods[player] then
                OnlineModerators[player] = nil
                SendNotification(
                    "‚ÑπÔ∏è Moderator Removed",
                    player.Name .. " is no longer a moderator.",
                    4,
                    "rbxasset://textures/ui/GameSettings/GFX/icon_info.png"
                )
                print("‚ÑπÔ∏è MODERATOR REMOVED: " .. player.Name)
            end
        end
    end
end)

-- Initial check
task.wait(3)
CheckExistingPlayers()

print("‚úÖ Mission Hunter ESP + AutoParry + Keybinds Loaded")
print("üîä Moderator Alert Sound: Patrick WeeWoo (ID: 427090811)")