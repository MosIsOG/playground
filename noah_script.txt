-- Universal ESP with Mission Hunter GUI + AutoParry (Multi-Animation) + No Stun
-- Logic: Players = Native Health Bar + Custom Red/Yellow Bars with Values + Walkspeed Multiplier
-- NPCs = Custom Green Bar (Toggleable) - Names hidden
-- No Stun: Prevents walkspeed from dropping below base speed
-- Keybind: F4 to Toggle Menu

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer
local VirtualInputManager = game:GetService("VirtualInputManager")
local StarterGui = game:GetService("StarterGui")
local SoundService = game:GetService("SoundService")

-- Configuration (Default Settings)
local Config = {
    Enabled = true,
    ShowNames = true,
    ShowBars = true,
    ShowNPCs = true,
    ShowValues = true,
    ShowWalkspeed = true,
    WalkspeedMultiplier = 1.0,
    MaxDistance = 1500,
    TextSize = 14,
    BarWidth = 150,
    BarHeight = 6,
    YOffset = 60,
    
    -- AutoParry Settings
    AutoParryEnabled = false,
    ParryAnimations = {},
    ParryDelay = 0.1,
    ParryKey = "F",
    
    -- No Stun Settings
    NoStunEnabled = false,
    MinWalkspeed = 16
}

-- State
local ESP_Cache = {}
local LiveFolder = workspace:FindFirstChild("Live")
local Configs = {}
local CurrentConfig = "Default"
local BaseWalkspeed = 16
local WalkspeedUpdateConnection = nil
local NoStunConnection = nil

-- AutoParry State
local ParryConnection = nil
local CurrentAnimations = {}
local DetectedAttacks = {}

-- Config file path
local ConfigFolder = "MissionHunterESP"
local ConfigFile = "configs.json"

-- Function to get the WalkSpeed attribute from humanoid
local function GetBaseWalkspeedFromAttribute(humanoid)
    local attrSpeed = humanoid:GetAttribute("WalkSpeed")
    if attrSpeed then
        return attrSpeed
    end
    return humanoid.WalkSpeed
end

-- Function to consistently apply walkspeed multiplier
local function ApplyWalkspeedMultiplier()
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return end
    
    if Config.ShowWalkspeed then
        local baseSpeed = GetBaseWalkspeedFromAttribute(humanoid)
        local targetSpeed = baseSpeed * Config.WalkspeedMultiplier
        
        if math.abs(humanoid.WalkSpeed - targetSpeed) > 0.1 then
            humanoid.WalkSpeed = targetSpeed
        end
    end
end

-- Start monitoring walkspeed changes
local function StartWalkspeedMonitoring()
    if WalkspeedUpdateConnection then
        WalkspeedUpdateConnection:Disconnect()
        WalkspeedUpdateConnection = nil
    end
    
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return end
    
    BaseWalkspeed = GetBaseWalkspeedFromAttribute(humanoid)
    
    local attributeConnection = humanoid:GetAttributeChangedSignal("WalkSpeed"):Connect(function()
        task.wait(0.1)
        BaseWalkspeed = GetBaseWalkspeedFromAttribute(humanoid)
        if Config.ShowWalkspeed then
            ApplyWalkspeedMultiplier()
        end
    end)
    
    WalkspeedUpdateConnection = RunService.RenderStepped:Connect(function()
        if not Config.Enabled then return end
        
        local currentChar = LocalPlayer.Character
        if not currentChar then return end
        
        local currentHumanoid = currentChar:FindFirstChild("Humanoid")
        if not currentHumanoid then return end
        
        local currentBase = GetBaseWalkspeedFromAttribute(currentHumanoid)
        
        if math.abs(currentBase - BaseWalkspeed) > 0.1 then
            BaseWalkspeed = currentBase
        end
        
        -- Apply walkspeed multiplier if enabled
        if Config.ShowWalkspeed then
            local targetSpeed = BaseWalkspeed * Config.WalkspeedMultiplier
            if math.abs(currentHumanoid.WalkSpeed - targetSpeed) > 0.1 then
                currentHumanoid.WalkSpeed = targetSpeed
            end
        end
        
        -- Apply No Stun if enabled (prevents going below min speed)
        if Config.NoStunEnabled then
            local minSpeed = Config.MinWalkspeed
            if Config.ShowWalkspeed then
                minSpeed = BaseWalkspeed * Config.WalkspeedMultiplier
            end
            
            if currentHumanoid.WalkSpeed < minSpeed - 0.1 then
                currentHumanoid.WalkSpeed = minSpeed
                print("âš¡ No Stun: Prevented speed drop to " .. currentHumanoid.WalkSpeed .. " (restored to " .. minSpeed .. ")")
            end
        end
    end)
    
    character.AncestryChanged:Connect(function()
        if not character.Parent then
            if attributeConnection then
                attributeConnection:Disconnect()
            end
        end
    end)
end

-- Handle character respawns
local function OnCharacterAdded(character)
    local humanoid = character:WaitForChild("Humanoid")
    
    task.wait(0.1)
    
    BaseWalkspeed = GetBaseWalkspeedFromAttribute(humanoid)
    
    if Config.ShowWalkspeed then
        humanoid.WalkSpeed = BaseWalkspeed * Config.WalkspeedMultiplier
    end
    
    StartWalkspeedMonitoring()
    
    humanoid.AncestryChanged:Connect(function()
        task.wait(0.1)
        if not humanoid.Parent then
            task.wait(0.5)
            OnCharacterAdded(character)
        end
    end)
end

-- Connect character events
LocalPlayer.CharacterAdded:Connect(OnCharacterAdded)

if LocalPlayer.Character then
    OnCharacterAdded(LocalPlayer.Character)
end

-- Function to save configs to file
local function SaveConfigs()
    local success, err = pcall(function()
        local data = {
            CurrentConfig = CurrentConfig,
            Configs = Configs
        }
        writefile(ConfigFolder .. "/" .. ConfigFile, HttpService:JSONEncode(data))
    end)
    if not success then
        warn("Failed to save configs: " .. tostring(err))
    end
end

-- Function to load configs from file
local function LoadConfigs()
    local success, err = pcall(function()
        if isfile(ConfigFolder .. "/" .. ConfigFile) then
            local data = HttpService:JSONDecode(readfile(ConfigFolder .. "/" .. ConfigFile))
            CurrentConfig = data.CurrentConfig or "Default"
            Configs = data.Configs or {}
            
            if Configs[CurrentConfig] then
                for k, v in pairs(Configs[CurrentConfig]) do
                    Config[k] = v
                end
            end
        else
            Configs["Default"] = {
                Enabled = true,
                ShowNames = true,
                ShowBars = true,
                ShowNPCs = true,
                ShowValues = true,
                ShowWalkspeed = true,
                WalkspeedMultiplier = 1.0,
                MaxDistance = 1500,
                TextSize = 14,
                BarWidth = 150,
                BarHeight = 6,
                YOffset = 60,
                AutoParryEnabled = false,
                ParryAnimations = {},
                ParryDelay = 0.1,
                ParryKey = "F",
                NoStunEnabled = false,
                MinWalkspeed = 16
            }
            CurrentConfig = "Default"
            SaveConfigs()
        end
    end)
    if not success then
        warn("Failed to load configs: " .. tostring(err))
    end
end

-- Load configs at startup and apply multiplier
LoadConfigs()
ApplyWalkspeedMultiplier()

--------------------------------------------------------------------------------
-- 1. GUI CONSTRUCTION
--------------------------------------------------------------------------------

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MissionHunterESP"
ScreenGui.ResetOnSpawn = false

if gethui then
    ScreenGui.Parent = gethui()
elseif game:GetService("RunService"):IsStudio() then
    ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
else
    pcall(function() ScreenGui.Parent = CoreGui end)
    if not ScreenGui.Parent then ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui") end
end

-- Main Container
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 450, 0, 650) -- Made taller for No Stun
MainFrame.Position = UDim2.new(0, 20, 0, 25)
MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
MainFrame.BorderSizePixel = 1
MainFrame.BorderColor3 = Color3.fromRGB(40, 40, 40)
MainFrame.Visible = true
MainFrame.Parent = ScreenGui

-- Header
local Header = Instance.new("Frame")
Header.Name = "Header"
Header.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
Header.BorderSizePixel = 0
Header.Size = UDim2.new(1, 0, 0, 30)
Header.Parent = MainFrame

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Text = "Mission Hunter ESP + AutoParry + No Stun"
TitleLabel.Font = Enum.Font.Code
TitleLabel.TextSize = 14
TitleLabel.TextColor3 = Color3.fromRGB(0, 120, 255)
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.BackgroundTransparency = 1
TitleLabel.Position = UDim2.new(0, 10, 0, 0)
TitleLabel.Size = UDim2.new(1, -20, 1, 0)
TitleLabel.Parent = Header

-- Drag Logic
local dragging, dragInput, dragStart, startPos
Header.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then dragging = false end
        end)
    end
end)
Header.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end
end)
UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- Tab Buttons
local TabButtons = Instance.new("Frame")
TabButtons.Name = "TabButtons"
TabButtons.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
TabButtons.BorderSizePixel = 0
TabButtons.Position = UDim2.new(0, 0, 0, 30)
TabButtons.Size = UDim2.new(1, 0, 0, 25)
TabButtons.Parent = MainFrame

local MainTabBtn = Instance.new("TextButton")
MainTabBtn.Text = "Main"
MainTabBtn.Font = Enum.Font.SourceSans
MainTabBtn.TextSize = 16
MainTabBtn.TextColor3 = Color3.fromRGB(0, 120, 255)
MainTabBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainTabBtn.BorderSizePixel = 0
MainTabBtn.Position = UDim2.new(0, 0, 0, 0)
MainTabBtn.Size = UDim2.new(0, 100, 1, 0)
MainTabBtn.Parent = TabButtons

local AutoParryTabBtn = Instance.new("TextButton")
AutoParryTabBtn.Text = "AutoParry"
AutoParryTabBtn.Font = Enum.Font.SourceSans
AutoParryTabBtn.TextSize = 16
AutoParryTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
AutoParryTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
AutoParryTabBtn.BorderSizePixel = 0
AutoParryTabBtn.Position = UDim2.new(0, 100, 0, 0)
AutoParryTabBtn.Size = UDim2.new(0, 100, 1, 0)
AutoParryTabBtn.Parent = TabButtons

local NoStunTabBtn = Instance.new("TextButton")
NoStunTabBtn.Text = "No Stun"
NoStunTabBtn.Font = Enum.Font.SourceSans
NoStunTabBtn.TextSize = 16
NoStunTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
NoStunTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
NoStunTabBtn.BorderSizePixel = 0
NoStunTabBtn.Position = UDim2.new(0, 200, 0, 0)
NoStunTabBtn.Size = UDim2.new(0, 100, 1, 0)
NoStunTabBtn.Parent = TabButtons

local ConfigTabBtn = Instance.new("TextButton")
ConfigTabBtn.Text = "Config"
ConfigTabBtn.Font = Enum.Font.SourceSans
ConfigTabBtn.TextSize = 16
ConfigTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
ConfigTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
ConfigTabBtn.BorderSizePixel = 0
ConfigTabBtn.Position = UDim2.new(0, 300, 0, 0)
ConfigTabBtn.Size = UDim2.new(0, 100, 1, 0)
ConfigTabBtn.Parent = TabButtons

-- Content Area
local ContentArea = Instance.new("ScrollingFrame")
ContentArea.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
ContentArea.BorderSizePixel = 0
ContentArea.Position = UDim2.new(0, 10, 0, 65)
ContentArea.Size = UDim2.new(1, -20, 1, -75)
ContentArea.CanvasSize = UDim2.new(0, 0, 0, 0)
ContentArea.ScrollBarThickness = 8
ContentArea.ScrollBarImageColor3 = Color3.fromRGB(0, 120, 255)
ContentArea.AutomaticCanvasSize = Enum.AutomaticSize.Y
ContentArea.Parent = MainFrame

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Parent = ContentArea
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0, 8)

-- Helper functions
local function ClearContent()
    for _, child in pairs(ContentArea:GetChildren()) do
        if child:IsA("Frame") or child:IsA("TextLabel") or child:IsA("TextBox") or child:IsA("TextButton") or child:IsA("ScrollingFrame") then
            child:Destroy()
        end
    end
end

local function CreateToggle(text, configKey, container)
    local container = container or ContentArea
    
    local toggleFrame = Instance.new("Frame")
    toggleFrame.BackgroundTransparency = 1
    toggleFrame.Size = UDim2.new(1, 0, 0, 24)
    toggleFrame.LayoutOrder = 1
    toggleFrame.Parent = container
    
    local btn = Instance.new("TextButton")
    btn.Text = ""
    btn.BackgroundColor3 = Config[configKey] and Color3.fromRGB(0, 120, 255) or Color3.fromRGB(40, 40, 40)
    btn.BorderSizePixel = 0
    btn.Position = UDim2.new(0, 5, 0, 4)
    btn.Size = UDim2.new(0, 16, 0, 16)
    btn.Parent = toggleFrame
    
    local lbl = Instance.new("TextLabel")
    lbl.Text = text
    lbl.Font = Enum.Font.SourceSans
    lbl.TextSize = 16
    lbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.BackgroundTransparency = 1
    lbl.Position = UDim2.new(0, 30, 0, 0)
    lbl.Size = UDim2.new(1, -30, 1, 0)
    lbl.Parent = toggleFrame
    
    btn.MouseButton1Click:Connect(function()
        Config[configKey] = not Config[configKey]
        btn.BackgroundColor3 = Config[configKey] and Color3.fromRGB(0, 120, 255) or Color3.fromRGB(40, 40, 40)
        
        -- Special handling for AutoParry toggle
        if configKey == "AutoParryEnabled" then
            if Config.AutoParryEnabled then
                StartAutoParry()
            else
                StopAutoParry()
            end
        end
        
        -- Special handling for walkspeed toggle
        if configKey == "ShowWalkspeed" then
            if Config.ShowWalkspeed then
                ApplyWalkspeedMultiplier()
                StartWalkspeedMonitoring()
            else
                local character = LocalPlayer.Character
                if character then
                    local humanoid = character:FindFirstChild("Humanoid")
                    if humanoid then
                        humanoid.WalkSpeed = GetBaseWalkspeedFromAttribute(humanoid)
                    end
                end
            end
        end
        
        SaveConfigs()
    end)
end

local function CreateSlider(text, configKey, min, max, container, isFloat, callback)
    local container = container or ContentArea
    
    local sliderFrame = Instance.new("Frame")
    sliderFrame.BackgroundTransparency = 1
    sliderFrame.Size = UDim2.new(1, 0, 0, 50)
    sliderFrame.LayoutOrder = 2
    sliderFrame.Parent = container
    
    local lbl = Instance.new("TextLabel")
    lbl.Text = text
    lbl.Font = Enum.Font.SourceSans
    lbl.TextSize = 16
    lbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.BackgroundTransparency = 1
    lbl.Position = UDim2.new(0, 5, 0, 0)
    lbl.Size = UDim2.new(1, -10, 0, 20)
    lbl.Parent = sliderFrame
    
    local sliderBg = Instance.new("Frame")
    sliderBg.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    sliderBg.BorderColor3 = Color3.fromRGB(50, 50, 50)
    sliderBg.BorderSizePixel = 1
    sliderBg.Position = UDim2.new(0, 5, 0, 25)
    sliderBg.Size = UDim2.new(1, -10, 0, 20)
    sliderBg.Parent = sliderFrame
    
    local sliderFill = Instance.new("Frame")
    sliderFill.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
    sliderFill.BorderSizePixel = 0
    sliderFill.Size = UDim2.new((Config[configKey] - min) / (max - min), 0, 1, 0)
    sliderFill.Parent = sliderBg
    
    local valueLbl = Instance.new("TextLabel")
    valueLbl.Text = isFloat and string.format("%.2f", Config[configKey]) or tostring(Config[configKey])
    valueLbl.Font = Enum.Font.Code
    valueLbl.TextSize = 14
    valueLbl.TextColor3 = Color3.fromRGB(255, 255, 255)
    valueLbl.BackgroundTransparency = 1
    valueLbl.Size = UDim2.new(1, 0, 1, 0)
    valueLbl.ZIndex = 2
    valueLbl.Parent = sliderBg
    
    local draggingSlider = false
    local function Update(input)
        local pos = input.Position.X
        local boxPos = sliderBg.AbsolutePosition.X
        local boxSize = sliderBg.AbsoluteSize.X
        local relative = math.clamp((pos - boxPos) / boxSize, 0, 1)
        local newVal = min + (max - min) * relative
        
        if not isFloat then
            newVal = math.floor(newVal)
        end
        
        Config[configKey] = newVal
        sliderFill.Size = UDim2.new(relative, 0, 1, 0)
        valueLbl.Text = isFloat and string.format("%.2f", newVal) or tostring(math.floor(newVal))
        
        if callback then
            callback(newVal)
        end
        
        SaveConfigs()
    end
    
    sliderBg.InputBegan:Connect(function(input) 
        if input.UserInputType == Enum.UserInputType.MouseButton1 then 
            draggingSlider = true 
            Update(input) 
        end 
    end)
    
    UserInputService.InputEnded:Connect(function(input) 
        if input.UserInputType == Enum.UserInputType.MouseButton1 then 
            draggingSlider = false 
        end 
    end)
    
    UserInputService.InputChanged:Connect(function(input) 
        if draggingSlider and input.UserInputType == Enum.UserInputType.MouseMovement then 
            Update(input) 
        end 
    end)
end

local function CreateTextBox(text, configKey, placeholder, container)
    local container = container or ContentArea
    
    local textFrame = Instance.new("Frame")
    textFrame.BackgroundTransparency = 1
    textFrame.Size = UDim2.new(1, 0, 0, 50)
    textFrame.LayoutOrder = 3
    textFrame.Parent = container
    
    local lbl = Instance.new("TextLabel")
    lbl.Text = text
    lbl.Font = Enum.Font.SourceSans
    lbl.TextSize = 16
    lbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.BackgroundTransparency = 1
    lbl.Position = UDim2.new(0, 5, 0, 0)
    lbl.Size = UDim2.new(1, -10, 0, 20)
    lbl.Parent = textFrame
    
    local box = Instance.new("TextBox")
    box.Text = Config[configKey] or ""
    box.PlaceholderText = placeholder
    box.Font = Enum.Font.SourceSans
    box.TextSize = 16
    box.TextColor3 = Color3.fromRGB(255, 255, 255)
    box.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    box.BorderSizePixel = 0
    box.Position = UDim2.new(0, 5, 0, 25)
    box.Size = UDim2.new(1, -10, 0, 20)
    box.Parent = textFrame
    
    box.FocusLost:Connect(function()
        Config[configKey] = box.Text
        SaveConfigs()
    end)
end

-- Build Main Tab
local function BuildMainTab()
    ClearContent()
    
    local pad = Instance.new("Frame")
    pad.Size = UDim2.new(1,0,0,5)
    pad.BackgroundTransparency = 1
    pad.LayoutOrder = 0
    pad.Parent = ContentArea
    
    CreateToggle("Master Enabled", "Enabled")
    CreateToggle("Show Player Names", "ShowNames")
    CreateToggle("Show NPCs (No Names)", "ShowNPCs")
    CreateToggle("Show Bars", "ShowBars")
    CreateToggle("Show Values", "ShowValues")
    CreateToggle("Enable Walkspeed Multiplier", "ShowWalkspeed")
    
    CreateSlider("Walkspeed Multiplier", "WalkspeedMultiplier", 0.5, 5, nil, true, function(newVal)
        if Config.ShowWalkspeed then
            ApplyWalkspeedMultiplier()
        end
    end)
    
    CreateSlider("Max Distance", "MaxDistance", 100, 5000)
    
    ContentArea.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y + 20)
end

-- AutoParry Functions
local function StopAutoParry()
    if ParryConnection then
        ParryConnection:Disconnect()
        ParryConnection = nil
    end
    CurrentAnimations = {}
    DetectedAttacks = {}
    print("ðŸ›‘ AutoParry Stopped")
end

local function PlayAnimationAndParry(animationId)
    if not Config.AutoParryEnabled then return end
    
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return end
    
    local animator = humanoid:FindFirstChildOfClass("Animator")
    if not animator then
        animator = Instance.new("Animator")
        animator.Parent = humanoid
    end
    
    local animation = Instance.new("Animation")
    animation.AnimationId = animationId
    
    local animTrack = animator:LoadAnimation(animation)
    animTrack:Play()
    
    table.insert(CurrentAnimations, animTrack)
    
    task.wait(Config.ParryDelay)
    
    local keyCode = Enum.KeyCode[Config.ParryKey:upper()]
    if keyCode then
        VirtualInputManager:SendKeyEvent(true, keyCode, false, game)
        task.wait(0.05)
        VirtualInputManager:SendKeyEvent(false, keyCode, false, game)
        print("âš”ï¸ Parried animation: " .. animationId)
    end
    
    task.wait(2)
    for i, track in ipairs(CurrentAnimations) do
        if track == animTrack then
            table.remove(CurrentAnimations, i)
            break
        end
    end
end

local function StartAutoParry()
    StopAutoParry()
    
    if not Config.AutoParryEnabled then return end
    if #Config.ParryAnimations == 0 then
        warn("âš ï¸ No animations added to AutoParry")
        return
    end
    
    print("ðŸ”„ AutoParry Started - Monitoring " .. #Config.ParryAnimations .. " animations")
    
    ParryConnection = RunService.Heartbeat:Connect(function()
        if not Config.AutoParryEnabled then return end
        
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                local character = player.Character
                if character then
                    local humanoid = character:FindFirstChild("Humanoid")
                    if humanoid then
                        local animator = humanoid:FindFirstChildOfClass("Animator")
                        if animator then
                            for _, track in pairs(animator:GetPlayingAnimationTracks()) do
                                local animId = track.Animation.AnimationId
                                
                                for _, savedAnim in ipairs(Config.ParryAnimations) do
                                    if animId == savedAnim and not DetectedAttacks[animId .. player.Name] then
                                        DetectedAttacks[animId .. player.Name] = true
                                        print("âš ï¸ Attack detected from " .. player.Name .. ": " .. animId)
                                        
                                        PlayAnimationAndParry(savedAnim)
                                        
                                        task.wait(2)
                                        DetectedAttacks[animId .. player.Name] = nil
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end)
end

-- Build AutoParry Tab
local function BuildAutoParryTab()
    ClearContent()
    
    local pad = Instance.new("Frame")
    pad.Size = UDim2.new(1,0,0,5)
    pad.BackgroundTransparency = 1
    pad.LayoutOrder = 0
    pad.Parent = ContentArea
    
    CreateToggle("Enable AutoParry", "AutoParryEnabled")
    
    -- Animation List (simplified for this example)
    local listFrame = Instance.new("Frame")
    listFrame.BackgroundTransparency = 1
    listFrame.Size = UDim2.new(1, 0, 0, 150)
    listFrame.LayoutOrder = 1
    listFrame.Parent = ContentArea
    
    local listLbl = Instance.new("TextLabel")
    listLbl.Text = "Animation List (" .. #Config.ParryAnimations .. ")"
    listLbl.Font = Enum.Font.SourceSans
    listLbl.TextSize = 16
    listLbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    listLbl.TextXAlignment = Enum.TextXAlignment.Left
    listLbl.BackgroundTransparency = 1
    listLbl.Position = UDim2.new(0, 5, 0, 0)
    listLbl.Size = UDim2.new(1, -10, 0, 20)
    listLbl.Parent = listFrame
    
    -- Simple animation input (in a real script, you'd have add/remove buttons)
    local animInput = Instance.new("TextBox")
    animInput.Text = ""
    animInput.PlaceholderText = "Enter Animation ID and press Enter"
    animInput.Font = Enum.Font.SourceSans
    animInput.TextSize = 16
    animInput.TextColor3 = Color3.fromRGB(255, 255, 255)
    animInput.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    animInput.BorderSizePixel = 0
    animInput.Position = UDim2.new(0, 5, 0, 25)
    animInput.Size = UDim2.new(1, -10, 0, 30)
    animInput.Parent = listFrame
    
    animInput.FocusLost:Connect(function(enterPressed)
        if enterPressed and animInput.Text ~= "" then
            table.insert(Config.ParryAnimations, animInput.Text)
            animInput.Text = ""
            SaveConfigs()
            BuildAutoParryTab() -- Refresh
        end
    end)
    
    -- Show current animations
    local animList = Instance.new("ScrollingFrame")
    animList.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    animList.BorderSizePixel = 0
    animList.Position = UDim2.new(0, 5, 0, 60)
    animList.Size = UDim2.new(1, -10, 0, 80)
    animList.CanvasSize = UDim2.new(0, 0, 0, 0)
    animList.ScrollBarThickness = 6
    animList.AutomaticCanvasSize = Enum.AutomaticSize.Y
    animList.Parent = listFrame
    
    local animListLayout = Instance.new("UIListLayout")
    animListLayout.Parent = animList
    animListLayout.Padding = UDim.new(0, 2)
    
    for i, animId in ipairs(Config.ParryAnimations) do
        local animItem = Instance.new("Frame")
        animItem.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        animItem.Size = UDim2.new(1, 0, 0, 25)
        animItem.Parent = animList
        
        local animLabel = Instance.new("TextLabel")
        animLabel.Text = i .. ". " .. animId
        animLabel.Font = Enum.Font.SourceSans
        animLabel.TextSize = 14
        animLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
        animLabel.TextXAlignment = Enum.TextXAlignment.Left
        animLabel.BackgroundTransparency = 1
        animLabel.Position = UDim2.new(0, 5, 0, 0)
        animLabel.Size = UDim2.new(1, -35, 1, 0)
        animLabel.Parent = animItem
        
        local removeBtn = Instance.new("TextButton")
        removeBtn.Text = "X"
        removeBtn.Font = Enum.Font.SourceSansBold
        removeBtn.TextSize = 16
        removeBtn.TextColor3 = Color3.fromRGB(255, 100, 100)
        removeBtn.BackgroundColor3 = Color3.fromRGB(60, 0, 0)
        removeBtn.BorderSizePixel = 0
        removeBtn.Position = UDim2.new(1, -25, 0, 2)
        removeBtn.Size = UDim2.new(0, 20, 0, 20)
        removeBtn.Parent = animItem
        
        removeBtn.MouseButton1Click:Connect(function()
            table.remove(Config.ParryAnimations, i)
            SaveConfigs()
            BuildAutoParryTab()
        end)
    end
    
    CreateSlider("Parry Delay (seconds)", "ParryDelay", 0, 1, nil, true)
    
    -- Key Selection
    local keyFrame = Instance.new("Frame")
    keyFrame.BackgroundTransparency = 1
    keyFrame.Size = UDim2.new(1, 0, 0, 50)
    keyFrame.LayoutOrder = 4
    keyFrame.Parent = ContentArea
    
    local keyLbl = Instance.new("TextLabel")
    keyLbl.Text = "Parry Key"
    keyLbl.Font = Enum.Font.SourceSans
    keyLbl.TextSize = 16
    keyLbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    keyLbl.TextXAlignment = Enum.TextXAlignment.Left
    keyLbl.BackgroundTransparency = 1
    keyLbl.Position = UDim2.new(0, 5, 0, 0)
    keyLbl.Size = UDim2.new(1, -10, 0, 20)
    keyLbl.Parent = keyFrame
    
    local keyBox = Instance.new("TextBox")
    keyBox.Text = Config.ParryKey
    keyBox.PlaceholderText = "F"
    keyBox.Font = Enum.Font.SourceSans
    keyBox.TextSize = 16
    keyBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    keyBox.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    keyBox.BorderSizePixel = 0
    keyBox.Position = UDim2.new(0, 5, 0, 25)
    keyBox.Size = UDim2.new(1, -10, 0, 20)
    keyBox.Parent = keyFrame
    
    keyBox.FocusLost:Connect(function()
        Config.ParryKey = keyBox.Text:upper()
        SaveConfigs()
    end)
    
    -- Test Button
    local testBtn = Instance.new("TextButton")
    testBtn.Text = "Test Parry"
    testBtn.Font = Enum.Font.SourceSans
    testBtn.TextSize = 18
    testBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    testBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
    testBtn.BorderSizePixel = 0
    testBtn.Size = UDim2.new(1, -10, 0, 40)
    testBtn.Position = UDim2.new(0, 5, 0, 0)
    testBtn.LayoutOrder = 5
    testBtn.Parent = ContentArea
    
    testBtn.MouseButton1Click:Connect(function()
        if #Config.ParryAnimations == 0 then
            SendNotification("Error", "Please add animations first", 3)
            return
        end
        PlayAnimationAndParry(Config.ParryAnimations[1])
    end)
    
    ContentArea.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y + 20)
end

-- Build No Stun Tab
local function BuildNoStunTab()
    ClearContent()
    
    local pad = Instance.new("Frame")
    pad.Size = UDim2.new(1,0,0,5)
    pad.BackgroundTransparency = 1
    pad.LayoutOrder = 0
    pad.Parent = ContentArea
    
    CreateToggle("Enable No Stun", "NoStunEnabled")
    
    -- Info text
    local infoFrame = Instance.new("Frame")
    infoFrame.BackgroundTransparency = 1
    infoFrame.Size = UDim2.new(1, 0, 0, 80)
    infoFrame.LayoutOrder = 1
    infoFrame.Parent = ContentArea
    
    local infoLbl1 = Instance.new("TextLabel")
    infoLbl1.Text = "âš¡ No Stun prevents your walkspeed"
    infoLbl1.Font = Enum.Font.SourceSans
    infoLbl1.TextSize = 16
    infoLbl1.TextColor3 = Color3.fromRGB(200, 200, 200)
    infoLbl1.TextXAlignment = Enum.TextXAlignment.Left
    infoLbl1.BackgroundTransparency = 1
    infoLbl1.Position = UDim2.new(0, 5, 0, 0)
    infoLbl1.Size = UDim2.new(1, -10, 0, 20)
    infoLbl1.Parent = infoFrame
    
    local infoLbl2 = Instance.new("TextLabel")
    infoLbl2.Text = "from dropping below the minimum speed."
    infoLbl2.Font = Enum.Font.SourceSans
    infoLbl2.TextSize = 16
    infoLbl2.TextColor3 = Color3.fromRGB(200, 200, 200)
    infoLbl2.TextXAlignment = Enum.TextXAlignment.Left
    infoLbl2.BackgroundTransparency = 1
    infoLbl2.Position = UDim2.new(0, 5, 0, 20)
    infoLbl2.Size = UDim2.new(1, -10, 0, 20)
    infoLbl2.Parent = infoFrame
    
    local infoLbl3 = Instance.new("TextLabel")
    infoLbl3.Text = "Works with Walkspeed Multiplier!"
    infoLbl3.Font = Enum.Font.SourceSans
    infoLbl3.TextSize = 16
    infoLbl3.TextColor3 = Color3.fromRGB(0, 200, 0)
    infoLbl3.TextXAlignment = Enum.TextXAlignment.Left
    infoLbl3.BackgroundTransparency = 1
    infoLbl3.Position = UDim2.new(0, 5, 0, 40)
    infoLbl3.Size = UDim2.new(1, -10, 0, 20)
    infoLbl3.Parent = infoFrame
    
    -- Minimum Speed Slider
    CreateSlider("Minimum Walkspeed", "MinWalkspeed", 1, 100, nil, true)
    
    -- Status display
    local statusFrame = Instance.new("Frame")
    statusFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    statusFrame.BorderSizePixel = 0
    statusFrame.Size = UDim2.new(1, 0, 0, 60)
    statusFrame.LayoutOrder = 3
    statusFrame.Parent = ContentArea
    
    local statusLbl = Instance.new("TextLabel")
    statusLbl.Text = "Current Status:"
    statusLbl.Font = Enum.Font.SourceSans
    statusLbl.TextSize = 16
    statusLbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    statusLbl.TextXAlignment = Enum.TextXAlignment.Left
    statusLbl.BackgroundTransparency = 1
    statusLbl.Position = UDim2.new(0, 5, 0, 5)
    statusLbl.Size = UDim2.new(1, -10, 0, 20)
    statusLbl.Parent = statusFrame
    
    local currentSpeedLbl = Instance.new("TextLabel")
    currentSpeedLbl.Text = "Current Speed: --"
    currentSpeedLbl.Font = Enum.Font.SourceSans
    currentSpeedLbl.TextSize = 14
    currentSpeedLbl.TextColor3 = Color3.fromRGB(150, 150, 150)
    currentSpeedLbl.TextXAlignment = Enum.TextXAlignment.Left
    currentSpeedLbl.BackgroundTransparency = 1
    currentSpeedLbl.Position = UDim2.new(0, 5, 0, 30)
    currentSpeedLbl.Size = UDim2.new(1, -10, 0, 20)
    currentSpeedLbl.Parent = statusFrame
    
    -- Update speed display
    local function UpdateSpeedDisplay()
        local character = LocalPlayer.Character
        if character then
            local humanoid = character:FindFirstChild("Humanoid")
            if humanoid then
                currentSpeedLbl.Text = string.format("Current Speed: %.1f | Min Speed: %.1f", 
                    humanoid.WalkSpeed, 
                    Config.MinWalkspeed)
            end
        end
    end
    
    RunService.Heartbeat:Connect(UpdateSpeedDisplay)
    
    ContentArea.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y + 20)
end

-- Build Config Tab
local function BuildConfigTab()
    ClearContent()
    
    -- Config Selection Frame (simplified for this example)
    local selectFrame = Instance.new("Frame")
    selectFrame.BackgroundTransparency = 1
    selectFrame.Size = UDim2.new(1, 0, 0, 50)
    selectFrame.LayoutOrder = 1
    selectFrame.Parent = ContentArea
    
    local selectLbl = Instance.new("TextLabel")
    selectLbl.Text = "Current Config: " .. CurrentConfig
    selectLbl.Font = Enum.Font.SourceSans
    selectLbl.TextSize = 16
    selectLbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    selectLbl.TextXAlignment = Enum.TextXAlignment.Left
    selectLbl.BackgroundTransparency = 1
    selectLbl.Position = UDim2.new(0, 5, 0, 0)
    selectLbl.Size = UDim2.new(1, -10, 0, 20)
    selectLbl.Parent = selectFrame
    
    -- Save/Load buttons
    local btnFrame = Instance.new("Frame")
    btnFrame.BackgroundTransparency = 1
    btnFrame.Size = UDim2.new(1, 0, 0, 40)
    btnFrame.LayoutOrder = 2
    btnFrame.Parent = ContentArea
    
    local saveBtn = Instance.new("TextButton")
    saveBtn.Text = "Save Config"
    saveBtn.Font = Enum.Font.SourceSans
    saveBtn.TextSize = 16
    saveBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    saveBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
    saveBtn.BorderSizePixel = 0
    saveBtn.Position = UDim2.new(0, 5, 0, 0)
    saveBtn.Size = UDim2.new(0.5, -10, 0, 30)
    saveBtn.Parent = btnFrame
    
    local loadBtn = Instance.new("TextButton")
    loadBtn.Text = "Load Default"
    loadBtn.Font = Enum.Font.SourceSans
    loadBtn.TextSize = 16
    loadBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    loadBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
    loadBtn.BorderSizePixel = 0
    loadBtn.Position = UDim2.new(0.5, 5, 0, 0)
    loadBtn.Size = UDim2.new(0.5, -10, 0, 30)
    loadBtn.Parent = btnFrame
    
    saveBtn.MouseButton1Click:Connect(function()
        local configCopy = {}
        for k, v in pairs(Config) do
            configCopy[k] = v
        end
        Configs[CurrentConfig] = configCopy
        SaveConfigs()
        
        saveBtn.Text = "Saved!"
        saveBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
        task.wait(1)
        saveBtn.Text = "Save Config"
        saveBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
    end)
    
    loadBtn.MouseButton1Click:Connect(function()
        if Configs["Default"] then
            for k, v in pairs(Configs["Default"]) do
                Config[k] = v
            end
            
            if Config.ShowWalkspeed then
                ApplyWalkspeedMultiplier()
                StartWalkspeedMonitoring()
            end
            
            if Config.AutoParryEnabled then
                StartAutoParry()
            else
                StopAutoParry()
            end
            
            SaveConfigs()
            
            loadBtn.Text = "Loaded!"
            loadBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
            task.wait(1)
            loadBtn.Text = "Load Default"
            loadBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
        end
    end)
    
    ContentArea.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y + 20)
end

-- Tab switching
MainTabBtn.MouseButton1Click:Connect(function()
    MainTabBtn.TextColor3 = Color3.fromRGB(0, 120, 255)
    MainTabBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    AutoParryTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    AutoParryTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    NoStunTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    NoStunTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    ConfigTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    ConfigTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    BuildMainTab()
end)

AutoParryTabBtn.MouseButton1Click:Connect(function()
    AutoParryTabBtn.TextColor3 = Color3.fromRGB(0, 120, 255)
    AutoParryTabBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    MainTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    MainTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    NoStunTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    NoStunTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    ConfigTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    ConfigTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    BuildAutoParryTab()
end)

NoStunTabBtn.MouseButton1Click:Connect(function()
    NoStunTabBtn.TextColor3 = Color3.fromRGB(0, 120, 255)
    NoStunTabBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    MainTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    MainTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    AutoParryTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    AutoParryTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    ConfigTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    ConfigTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    BuildNoStunTab()
end)

ConfigTabBtn.MouseButton1Click:Connect(function()
    ConfigTabBtn.TextColor3 = Color3.fromRGB(0, 120, 255)
    ConfigTabBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    MainTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    MainTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    AutoParryTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    AutoParryTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    NoStunTabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
    NoStunTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    BuildConfigTab()
end)

BuildMainTab()

--------------------------------------------------------------------------------
-- 2. ESP SYSTEM (NPC Names Hidden)
--------------------------------------------------------------------------------

local function CreateDrawing(type, props)
    local obj = Drawing.new(type)
    for k, v in pairs(props) do obj[k] = v end
    return obj
end

local function RemoveESP(model)
    if ESP_Cache[model] then
        for _, drawing in pairs(ESP_Cache[model].Drawings) do
            drawing:Remove()
        end
        ESP_Cache[model] = nil
    end
end

RunService.RenderStepped:Connect(function()
    if not Config.Enabled then 
        for model, _ in pairs(ESP_Cache) do RemoveESP(model) end
        return 
    end

    if not LiveFolder then LiveFolder = workspace:FindFirstChild("Live") return end

    for _, entry in pairs(ESP_Cache) do entry.Seen = false end

    for _, folder in ipairs(LiveFolder:GetChildren()) do
        local model = folder:IsA("Model") and folder or folder:FindFirstChildWhichIsA("Model")
        
        if model and model ~= LocalPlayer.Character then
            
            local head = model:FindFirstChild("Head")
            local humanoid = model:FindFirstChild("Humanoid")
            local player = Players:GetPlayerFromCharacter(model)

            if player and humanoid then
                pcall(function()
                     humanoid.HealthDisplayType = Enum.HumanoidHealthDisplayType.AlwaysOn
                end)
            end

            local isNPC = not player

            if isNPC and not Config.ShowNPCs then
                if ESP_Cache[model] then RemoveESP(model) end
                continue
            end

            if head and humanoid then
                if not ESP_Cache[model] then
                    ESP_Cache[model] = {
                        Seen = true,
                        Drawings = {
                            Name = CreateDrawing("Text", {Center = true, Outline = true, Color = Color3.new(1,1,1), Size = Config.TextSize}),
                            Bar1Bg = CreateDrawing("Square", {Filled = true, Color = Color3.new(0.1,0.1,0.1), Transparency = 0.8}),
                            Bar1Fill = CreateDrawing("Square", {Filled = true, Transparency = 1}),
                            Bar1Text = CreateDrawing("Text", {Center = false, Outline = true, Color = Color3.new(1,1,1), Size = 13}),
                            Bar2Bg = CreateDrawing("Square", {Filled = true, Color = Color3.new(0.1,0.1,0.1), Transparency = 0.8}),
                            Bar2Fill = CreateDrawing("Square", {Filled = true, Transparency = 1}),
                            Bar2Text = CreateDrawing("Text", {Center = false, Outline = true, Color = Color3.new(1,1,1), Size = 13}),
                            Bar3Bg = CreateDrawing("Square", {Filled = true, Color = Color3.new(0.1,0.1,0.1), Transparency = 0.8}),
                            Bar3Fill = CreateDrawing("Square", {Filled = true, Transparency = 1}),
                            Bar3Text = CreateDrawing("Text", {Center = false, Outline = true, Color = Color3.new(1,1,1), Size = 13}),
                        }
                    }
                end

                local entry = ESP_Cache[model]
                entry.Seen = true
                local d = entry.Drawings

                local vector, onScreen = Camera:WorldToViewportPoint(head.Position)
                local distance = (Camera.CFrame.Position - head.Position).Magnitude

                if onScreen and distance <= Config.MaxDistance then
                    
                    local val1, min1, max1, color1 = 0, 0, 100, Color3.new(1, 0, 0)
                    local val2, min2, max2, color2 = 0, 0, 100, Color3.new(1, 1, 0)
                    local showBar2 = false
                    local showBar3 = false
                    local cleanName = ""

                    if isNPC then
                        val1 = humanoid.Health
                        max1 = humanoid.MaxHealth
                        min1 = 0
                        color1 = Color3.new(0.2, 0.9, 0.2)
                        showBar2 = false
                        showBar3 = false
                        cleanName = ""
                    else
                        local lf = folder:FindFirstChild("Lifeforce") or model:FindFirstChild("Lifeforce")
                        local pos = folder:FindFirstChild("Posture") or model:FindFirstChild("Posture")
                        
                        if lf then 
                            val1 = lf.Value 
                            max1 = lf:GetAttribute("MaxValue") or lf.MaxValue or 100
                            min1 = lf:GetAttribute("MinValue") or lf.MinValue or 0
                        end
                        if pos then 
                            val2 = pos.Value 
                            max2 = pos:GetAttribute("MaxValue") or pos.MaxValue or 100
                            min2 = pos:GetAttribute("MinValue") or pos.MinValue or 0
                            showBar2 = true
                        end
                        
                        if Config.ShowWalkspeed then
                            showBar3 = true
                        end
                        
                        color1 = Color3.new(0.9, 0.2, 0.2)
                        cleanName = player and player.Name or ""
                    end

                    local range1 = max1 - min1
                    local pct1 = range1 > 0 and math.clamp((val1 - min1) / range1, 0, 1) or 0
                    
                    local range2 = max2 - min2
                    local pct2 = range2 > 0 and math.clamp((val2 - min2) / range2, 0, 1) or 0

                    local screenPos = Vector2.new(vector.X, vector.Y)
                    local startY = screenPos.Y - Config.YOffset - (1000/distance)

                    if Config.ShowNames and not isNPC and cleanName ~= "" then
                        d.Name.Visible = true
                        d.Name.Text = cleanName
                        d.Name.Position = screenPos - Vector2.new(0, Config.YOffset + 15 + (showBar3 and 20 or 0))
                        d.Name.Size = Config.TextSize
                    else
                        d.Name.Visible = false
                    end

                    if Config.ShowBars then
                        local barPos = Vector2.new(screenPos.X - (Config.BarWidth / 2), startY)
                        local currentY = startY
                        
                        if showBar3 and not isNPC then
                            local baseSpeed = GetBaseWalkspeedFromAttribute(humanoid)
                            local pct3 = math.clamp(humanoid.WalkSpeed / (baseSpeed * 3), 0, 1)
                            
                            local bar3Pos = Vector2.new(screenPos.X - (Config.BarWidth / 2), currentY)
                            
                            d.Bar3Bg.Visible = true
                            d.Bar3Bg.Size = Vector2.new(Config.BarWidth, Config.BarHeight)
                            d.Bar3Bg.Position = bar3Pos
                            d.Bar3Fill.Visible = true
                            d.Bar3Fill.Size = Vector2.new(Config.BarWidth * pct3, Config.BarHeight)
                            d.Bar3Fill.Position = bar3Pos
                            d.Bar3Fill.Color = Color3.new(0.2, 0.6, 1)

                            if Config.ShowValues then
                                d.Bar3Text.Visible = true
                                d.Bar3Text.Text = string.format("Spd: %.1f", humanoid.WalkSpeed)
                                d.Bar3Text.Position = bar3Pos + Vector2.new(Config.BarWidth + 5, -3)
                            else
                                d.Bar3Text.Visible = false
                            end
                            
                            currentY = currentY + Config.BarHeight + 2
                        else
                            d.Bar3Bg.Visible = false
                            d.Bar3Fill.Visible = false
                            d.Bar3Text.Visible = false
                        end
                        
                        if showBar2 then
                            local bar2Pos = Vector2.new(screenPos.X - (Config.BarWidth / 2), currentY)
                            
                            d.Bar2Bg.Visible = true
                            d.Bar2Bg.Size = Vector2.new(Config.BarWidth, Config.BarHeight)
                            d.Bar2Bg.Position = bar2Pos
                            d.Bar2Fill.Visible = true
                            d.Bar2Fill.Size = Vector2.new(Config.BarWidth * pct2, Config.BarHeight)
                            d.Bar2Fill.Position = bar2Pos
                            d.Bar2Fill.Color = color2

                            if Config.ShowValues then
                                d.Bar2Text.Visible = true
                                d.Bar2Text.Text = string.format("%.0f/%.0f", val2, max2)
                                d.Bar2Text.Position = bar2Pos + Vector2.new(Config.BarWidth + 5, -3)
                            else
                                d.Bar2Text.Visible = false
                            end
                            
                            currentY = currentY + Config.BarHeight + 2
                        else
                            d.Bar2Bg.Visible = false
                            d.Bar2Fill.Visible = false
                            d.Bar2Text.Visible = false
                        end
                        
                        local bar1Pos = Vector2.new(screenPos.X - (Config.BarWidth / 2), currentY)
                        
                        d.Bar1Bg.Visible = true
                        d.Bar1Bg.Size = Vector2.new(Config.BarWidth, Config.BarHeight)
                        d.Bar1Bg.Position = bar1Pos
                        d.Bar1Fill.Visible = true
                        d.Bar1Fill.Size = Vector2.new(Config.BarWidth * pct1, Config.BarHeight)
                        d.Bar1Fill.Position = bar1Pos
                        d.Bar1Fill.Color = color1

                        if Config.ShowValues then
                            d.Bar1Text.Visible = true
                            d.Bar1Text.Text = string.format("%.0f/%.0f", val1, max1)
                            d.Bar1Text.Position = bar1Pos + Vector2.new(Config.BarWidth + 5, -3)
                        else
                            d.Bar1Text.Visible = false
                        end

                    else
                        d.Bar1Bg.Visible = false
                        d.Bar1Fill.Visible = false
                        d.Bar1Text.Visible = false
                        d.Bar2Bg.Visible = false
                        d.Bar2Fill.Visible = false
                        d.Bar2Text.Visible = false
                        d.Bar3Bg.Visible = false
                        d.Bar3Fill.Visible = false
                        d.Bar3Text.Visible = false
                    end

                else
                    for _, v in pairs(d) do v.Visible = false end
                end
            end
        end
    end

    for model, entry in pairs(ESP_Cache) do
        if not entry.Seen or not model.Parent then
            RemoveESP(model)
        end
    end
end)

-- Moderator Detector with Sound Notification
-- Detects players with specific roles in Demon Corps North Branch (Group ID: 16346602)
-- Plays Patrick WeeWoo sound when a moderator joins

local MODERATOR_ROLES = {
    ["tes"] = true,
    ["admin"] = true,
    ["Owner"] = true,
}
local ALERT_SOUND_ID = "rbxassetid://427090811"  -- Patrick WeeWoo Loop

-- Track online moderators
local OnlineModerators = {}

-- Function to check if a player is a moderator
local function IsModerator(player)
    local success, role = pcall(function()
        return player:GetRoleInGroup(16346602)
    end)
    
    if success and role then
        return MODERATOR_ROLES[role] == true, role
    end
    return false, nil
end

-- Function to play alert sound
local function PlayAlertSound()
    local sound = Instance.new("Sound")
    sound.SoundId = ALERT_SOUND_ID
    sound.Volume = 0.8
    sound.PlayOnRemove = false
    
    local character = LocalPlayer.Character
    if character then
        sound.Parent = character
    else
        sound.Parent = SoundService
    end
    
    sound:Play()
    print("ðŸ”Š Playing alert sound: Patrick WeeWoo")
    
    game:GetService("Debris"):AddItem(sound, sound.TimeLength or 5)
end

-- Function to send notification
local function SendNotification(title, text, duration, icon)
    StarterGui:SetCore("SendNotification", {
        Title = title,
        Text = text,
        Duration = duration or 5,
        Icon = icon or "rbxasset://textures/ui/GameSettings/GFX/icon_alert.png"
    })
end

-- Function to check existing players
local function CheckExistingPlayers()
    local mods = {}
    local modCount = 0
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local isMod, role = IsModerator(player)
            if isMod then
                mods[player] = role
                OnlineModerators[player] = role
                modCount = modCount + 1
            end
        end
    end
    
    if modCount > 0 then
        local modNames = {}
        for player, role in pairs(mods) do
            table.insert(modNames, player.Name .. " (" .. role .. ")")
        end
        
        SendNotification(
            "âš ï¸ Moderators Online",
            table.concat(modNames, "\n"),
            8,
            "rbxasset://textures/ui/GameSettings/GFX/icon_alert.png"
        )
        
        PlayAlertSound()
        
        print("âš ï¸ " .. modCount .. " moderator(s) online at startup")
    end
end

-- Monitor player joins
Players.PlayerAdded:Connect(function(player)
    task.wait(2)
    
    if player ~= LocalPlayer then
        local isMod, role = IsModerator(player)
        if isMod then
            OnlineModerators[player] = role
            
            PlayAlertSound()
            
            SendNotification(
                "âš ï¸ Moderator Joined",
                player.Name .. " (" .. role .. ") has joined the game!",
                6,
                "rbxasset://textures/ui/GameSettings/GFX/icon_alert.png"
            )
            
            print("âš ï¸ MODERATOR JOINED: " .. player.Name .. " (" .. role .. ")")
        end
    end
end)

-- Monitor player leaves
Players.PlayerRemoving:Connect(function(player)
    if OnlineModerators[player] then
        local role = OnlineModerators[player]
        OnlineModerators[player] = nil
        
        SendNotification(
            "â„¹ï¸ Moderator Left",
            player.Name .. " (" .. role .. ") has left the game.",
            4,
            "rbxasset://textures/ui/GameSettings/GFX/icon_info.png"
        )
        
        print("â„¹ï¸ MODERATOR LEFT: " .. player.Name .. " (" .. role .. ")")
    end
end)

-- Periodic check for role changes
task.spawn(function()
    while task.wait(30) do
        local currentMods = {}
        
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                local isMod, role = IsModerator(player)
                if isMod then
                    currentMods[player] = role
                end
            end
        end
        
        for player, role in pairs(currentMods) do
            if not OnlineModerators[player] then
                OnlineModerators[player] = role
                
                PlayAlertSound()
                
                SendNotification(
                    "âš ï¸ Moderator Detected",
                    player.Name .. " (" .. role .. ") is now a moderator!",
                    6,
                    "rbxasset://textures/ui/GameSettings/GFX/icon_alert.png"
                )
                
                print("âš ï¸ NEW MODERATOR DETECTED: " .. player.Name .. " (" .. role .. ")")
            end
        end
        
        for player in pairs(OnlineModerators) do
            if not currentMods[player] then
                OnlineModerators[player] = nil
                SendNotification(
                    "â„¹ï¸ Moderator Removed",
                    player.Name .. " is no longer a moderator.",
                    4,
                    "rbxasset://textures/ui/GameSettings/GFX/icon_info.png"
                )
                print("â„¹ï¸ MODERATOR REMOVED: " .. player.Name)
            end
        end
    end
end)

-- Initial check
task.wait(3)
CheckExistingPlayers()

UserInputService.InputBegan:Connect(function(input, processed)
    if not processed and input.KeyCode == Enum.KeyCode.F4 then
        MainFrame.Visible = not MainFrame.Visible
    end
end)

print("âœ… Mission Hunter ESP + AutoParry + No Stun Loaded")
print("ðŸ”Š Moderator Alert Sound: Patrick WeeWoo (ID: 427090811)")
