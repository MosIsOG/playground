-- Settings
local Config = {
    Enabled = true,
    MaxDistance = 1000,
    TextSize = 14,
    BarWidth = 100, -- Made slightly smaller for cleaner look
    BarHeight = 6,
    YOffset = 60,   -- Height above head
    ToggleKey = Enum.KeyCode.F3
}

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera

-- State
local ESP_Cache = {}
local LiveFolder = workspace:FindFirstChild("Live")

-- Drawing Helper
local function CreateDrawing(type, props)
    local obj = Drawing.new(type)
    for k, v in pairs(props) do obj[k] = v end
    return obj
end

-- Cleanup Function
local function RemoveESP(model)
    if ESP_Cache[model] then
        for _, drawing in pairs(ESP_Cache[model].Drawings) do
            drawing:Remove()
        end
        ESP_Cache[model] = nil
    end
end

-- Main Update Loop
RunService.RenderStepped:Connect(function()
    if not Config.Enabled then 
        for model, _ in pairs(ESP_Cache) do RemoveESP(model) end
        return 
    end

    -- Validate Live folder exists
    if not LiveFolder then LiveFolder = workspace:FindFirstChild("Live") return end

    -- 1. Mark all current cached items as "not seen" to handle cleanup later
    for _, entry in pairs(ESP_Cache) do entry.Seen = false end

    -- 2. Scan Folder
    for _, folder in ipairs(LiveFolder:GetChildren()) do
        -- Find the actual character model (could be the folder itself or inside it)
        local model = folder:IsA("Model") and folder or folder:FindFirstChildWhichIsA("Model")
        
        if model then
            local head = model:FindFirstChild("Head")
            local humanoid = model:FindFirstChild("Humanoid") -- Just check existence here

            if head and humanoid then
                -- Initialize Cache for new models
                if not ESP_Cache[model] then
                    ESP_Cache[model] = {
                        Seen = true,
                        Drawings = {
                            Name = CreateDrawing("Text", {Center = true, Outline = true, Color = Color3.new(1,1,1), Size = Config.TextSize}),
                            
                            -- Bar Backgrounds
                            Bar1Bg = CreateDrawing("Square", {Filled = true, Color = Color3.new(0.1,0.1,0.1), Transparency = 0.8}),
                            Bar2Bg = CreateDrawing("Square", {Filled = true, Color = Color3.new(0.1,0.1,0.1), Transparency = 0.8}),
                            
                            -- Actual Bars
                            Bar1Fill = CreateDrawing("Square", {Filled = true, Transparency = 1}), -- Health/Lifeforce
                            Bar2Fill = CreateDrawing("Square", {Filled = true, Transparency = 1}), -- Posture (if applicable)
                        }
                    }
                end

                local entry = ESP_Cache[model]
                entry.Seen = true
                local d = entry.Drawings

                -- CALCULATION LOGIC ------------------------------------------
                local vector, onScreen = Camera:WorldToViewportPoint(head.Position)
                local distance = (Camera.CFrame.Position - head.Position).Magnitude

                if onScreen and distance <= Config.MaxDistance then
                    -- Identify Type
                    local isNPC = model.Name:match("^NPC_")
                    
                    local val1, max1, color1 = 0, 100, Color3.new(1, 0, 0) -- Default Red
                    local val2, max2, color2 = 0, 100, Color3.new(1, 1, 0) -- Default Yellow
                    local showBar2 = false

                    if isNPC then
                        -- NPC LOGIC: Green Bar, uses Humanoid Health
                        val1 = humanoid.Health
                        max1 = humanoid.MaxHealth
                        color1 = Color3.new(0.2, 0.9, 0.2) -- Green
                        showBar2 = false -- NPCs don't show posture in this specific view
                    else
                        -- PLAYER/OTHER LOGIC: Red Bar + Yellow Posture, uses custom values
                        -- Try to find Lifeforce/Posture in folder or model
                        local lf = folder:FindFirstChild("Lifeforce") or model:FindFirstChild("Lifeforce")
                        local pos = folder:FindFirstChild("Posture") or model:FindFirstChild("Posture")
                        
                        if lf then 
                            val1 = lf.Value 
                            max1 = lf:GetAttribute("MaxValue") or 100
                        end
                        if pos then 
                            val2 = pos.Value 
                            max2 = pos:GetAttribute("MaxValue") or 100
                            showBar2 = true
                        end
                        
                        color1 = Color3.new(0.9, 0.2, 0.2) -- Red
                    end

                    -- Clamping
                    local pct1 = math.clamp(val1 / max1, 0, 1)
                    local pct2 = math.clamp(val2 / max2, 0, 1)

                    -- VISUAL UPDATES ----------------------------------------
                    local screenPos = Vector2.new(vector.X, vector.Y)
                    local startY = screenPos.Y - Config.YOffset - (1000/distance) -- Scale height offset by distance

                    -- 1. Name
                    d.Name.Visible = true
                    d.Name.Text = isNPC and model.Name:gsub("^NPC_", "") or model.Name
                    d.Name.Position = screenPos - Vector2.new(0, Config.YOffset + 15)

                    -- 2. Health Bar (Green for NPC, Red for Player)
                    local barPos = Vector2.new(screenPos.X - (Config.BarWidth / 2), startY)
                    
                    d.Bar1Bg.Visible = true
                    d.Bar1Bg.Size = Vector2.new(Config.BarWidth, Config.BarHeight)
                    d.Bar1Bg.Position = barPos

                    d.Bar1Fill.Visible = true
                    d.Bar1Fill.Size = Vector2.new(Config.BarWidth * pct1, Config.BarHeight)
                    d.Bar1Fill.Position = barPos
                    d.Bar1Fill.Color = color1

                    -- 3. Posture Bar (Only for Players)
                    if showBar2 then
                        local bar2Pos = barPos - Vector2.new(0, Config.BarHeight + 2) -- Stack on top
                        
                        d.Bar2Bg.Visible = true
                        d.Bar2Bg.Size = Vector2.new(Config.BarWidth, Config.BarHeight)
                        d.Bar2Bg.Position = bar2Pos

                        d.Bar2Fill.Visible = true
                        d.Bar2Fill.Size = Vector2.new(Config.BarWidth * pct2, Config.BarHeight)
                        d.Bar2Fill.Position = bar2Pos
                        d.Bar2Fill.Color = color2
                    else
                        d.Bar2Bg.Visible = false
                        d.Bar2Fill.Visible = false
                    end

                else
                    -- Offscreen or too far
                    for _, v in pairs(d) do v.Visible = false end
                end
            end
        end
    end

    -- 3. Cleanup items that no longer exist or were not seen this frame
    for model, entry in pairs(ESP_Cache) do
        if not entry.Seen or not model.Parent then
            RemoveESP(model)
        end
    end
end)

-- Toggle Input
UserInputService.InputBegan:Connect(function(input, processed)
    if not processed and input.KeyCode == Config.ToggleKey then
        Config.Enabled = not Config.Enabled
    end
end)

print("ESP Loaded. Press F3 to toggle.")