-- Universal ESP with "Mission Hunter" Style GUI
-- Press [INSERT] to Toggle Menu

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

-- Configuration
local Config = {
    Enabled = true,
    Box = true,
    Name = true,
    Health = true,
    MaxDistance = 2000,
    TextSize = 14
}

-- State
local ESP_Cache = {}
local LiveFolder = workspace:FindFirstChild("Live")

--------------------------------------------------------------------------------
-- 1. GUI CONSTRUCTION (Mission Hunter Style)
--------------------------------------------------------------------------------

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MissionHunterESP"
-- Protect GUI from detection if possible, or put in PlayerGui
pcall(function() ScreenGui.Parent = CoreGui end)
if not ScreenGui.Parent then ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui") end

-- Main Window
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 450, 0, 350)
MainFrame.Position = UDim2.new(0.5, -225, 0.5, -175)
MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15) -- Very dark bg
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

-- Title Bar (Just text, no distinct bar background in reference)
local TitleLabel = Instance.new("TextLabel")
TitleLabel.Text = "Universal ESP"
TitleLabel.Font = Enum.Font.Code
TitleLabel.TextSize = 14
TitleLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.BackgroundTransparency = 1
TitleLabel.Position = UDim2.new(0, 10, 0, 5)
TitleLabel.Size = UDim2.new(1, -20, 0, 20)
TitleLabel.Parent = MainFrame

-- Tab Container
local TabFrame = Instance.new("Frame")
TabFrame.Position = UDim2.new(0, 10, 0, 30)
TabFrame.Size = UDim2.new(1, -20, 0, 25)
TabFrame.BackgroundTransparency = 1
TabFrame.Parent = MainFrame

local function CreateTabButton(text, xOffset, isActive)
    local btn = Instance.new("TextButton")
    btn.Text = text
    btn.Font = Enum.Font.SourceSansBold
    btn.TextSize = 14
    btn.TextColor3 = isActive and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(150, 150, 150)
    btn.BackgroundTransparency = 1
    btn.Size = UDim2.new(0, 80, 1, 0)
    btn.Position = UDim2.new(0, xOffset, 0, 0)
    btn.Parent = TabFrame
    
    -- Underline for active tab (Simulated)
    if isActive then
        local line = Instance.new("Frame")
        line.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        line.BorderSizePixel = 0
        line.Size = UDim2.new(1, 0, 0, 2)
        line.Position = UDim2.new(0, 0, 1, 0)
        line.Parent = btn
    end
    return btn
end

CreateTabButton("Visuals", 0, true)
CreateTabButton("Settings", 85, false)

-- Content Area (Darker container)
local ContentArea = Instance.new("Frame")
ContentArea.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
ContentArea.BorderSizePixel = 1
ContentArea.BorderColor3 = Color3.fromRGB(30, 30, 30)
ContentArea.Position = UDim2.new(0, 10, 0, 60)
ContentArea.Size = UDim2.new(0.5, -15, 0.8, 0) -- Left side
ContentArea.Parent = MainFrame

-- Section Header "Main"
local SectionHeader = Instance.new("TextLabel")
SectionHeader.Text = "Main"
SectionHeader.Font = Enum.Font.SourceSansBold
SectionHeader.TextSize = 14
SectionHeader.TextColor3 = Color3.fromRGB(200, 200, 200)
SectionHeader.TextXAlignment = Enum.TextXAlignment.Left
SectionHeader.BackgroundTransparency = 1
SectionHeader.Position = UDim2.new(0, 10, 0, 5)
SectionHeader.Size = UDim2.new(1, -20, 0, 20)
SectionHeader.Parent = ContentArea

local Separator = Instance.new("Frame")
Separator.BackgroundColor3 = Color3.fromRGB(0, 120, 255) -- Blue Accent Line
Separator.BorderSizePixel = 0
Separator.Size = UDim2.new(1, 0, 0, 1)
Separator.Position = UDim2.new(0, 0, 1, 0)
Separator.Parent = SectionHeader

-- UI Element Creators
local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Parent = ContentArea
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0, 5)

-- Padding for top
local Pad = Instance.new("Frame")
Pad.Size = UDim2.new(1,0,0,30)
Pad.BackgroundTransparency = 1
Pad.LayoutOrder = 0
Pad.Parent = ContentArea

local function CreateToggle(text, configKey)
    local container = Instance.new("Frame")
    container.BackgroundTransparency = 1
    container.Size = UDim2.new(1, 0, 0, 20)
    container.LayoutOrder = 1
    container.Parent = ContentArea
    
    local btn = Instance.new("TextButton")
    btn.Text = ""
    btn.BackgroundColor3 = Config[configKey] and Color3.fromRGB(0, 120, 255) or Color3.fromRGB(40, 40, 40)
    btn.BorderSizePixel = 0
    btn.Position = UDim2.new(0, 10, 0, 2)
    btn.Size = UDim2.new(0, 16, 0, 16)
    btn.Parent = container
    
    local lbl = Instance.new("TextLabel")
    lbl.Text = text
    lbl.Font = Enum.Font.Code
    lbl.TextSize = 13
    lbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.BackgroundTransparency = 1
    lbl.Position = UDim2.new(0, 35, 0, 0)
    lbl.Size = UDim2.new(1, -35, 1, 0)
    lbl.Parent = container
    
    btn.MouseButton1Click:Connect(function()
        Config[configKey] = not Config[configKey]
        btn.BackgroundColor3 = Config[configKey] and Color3.fromRGB(0, 120, 255) or Color3.fromRGB(40, 40, 40)
    end)
end

local function CreateSlider(text, configKey, min, max)
    local container = Instance.new("Frame")
    container.BackgroundTransparency = 1
    container.Size = UDim2.new(1, 0, 0, 45)
    container.LayoutOrder = 2
    container.Parent = ContentArea
    
    local lbl = Instance.new("TextLabel")
    lbl.Text = text
    lbl.Font = Enum.Font.Code
    lbl.TextSize = 13
    lbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.BackgroundTransparency = 1
    lbl.Position = UDim2.new(0, 10, 0, 0)
    lbl.Size = UDim2.new(1, -20, 0, 20)
    lbl.Parent = container
    
    local sliderBg = Instance.new("Frame")
    sliderBg.BackgroundColor3 = Color3.fromRGB(30, 30, 30) -- Dark track
    sliderBg.BorderSizePixel = 0
    sliderBg.Position = UDim2.new(0, 10, 0, 22)
    sliderBg.Size = UDim2.new(1, -20, 0, 18)
    sliderBg.Parent = container
    
    local sliderFill = Instance.new("Frame")
    sliderFill.BackgroundColor3 = Color3.fromRGB(0, 120, 255) -- Blue Fill
    sliderFill.BorderSizePixel = 0
    sliderFill.Size = UDim2.new((Config[configKey] - min) / (max - min), 0, 1, 0)
    sliderFill.Parent = sliderBg
    
    local valueLbl = Instance.new("TextLabel")
    valueLbl.Text = tostring(Config[configKey])
    valueLbl.Font = Enum.Font.Code
    valueLbl.TextSize = 13
    valueLbl.TextColor3 = Color3.fromRGB(255, 255, 255)
    valueLbl.BackgroundTransparency = 1
    valueLbl.Size = UDim2.new(1, 0, 1, 0)
    valueLbl.Parent = sliderBg
    
    local dragging = false
    
    local function Update(input)
        local pos = input.Position.X
        local boxPos = sliderBg.AbsolutePosition.X
        local boxSize = sliderBg.AbsoluteSize.X
        local relative = math.clamp((pos - boxPos) / boxSize, 0, 1)
        
        local newVal = math.floor(min + (max - min) * relative)
        Config[configKey] = newVal
        
        sliderFill.Size = UDim2.new(relative, 0, 1, 0)
        valueLbl.Text = tostring(newVal)
    end
    
    sliderBg.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            Update(input)
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            Update(input)
        end
    end)
end

-- Add Widgets
CreateToggle("Enabled", "Enabled")
CreateToggle("Show Boxes", "Box")
CreateToggle("Show Names", "Name")
CreateToggle("Show Health", "Health")

-- Add a spacer/divider style for Slider section
local Spacer = Instance.new("Frame")
Spacer.BackgroundTransparency = 1
Spacer.Size = UDim2.new(1,0,0,10)
Spacer.LayoutOrder = 2
Spacer.Parent = ContentArea

CreateSlider("Max Distance", "MaxDistance", 100, 5000)

--------------------------------------------------------------------------------
-- 2. ESP LOGIC (Integrated with UI Config)
--------------------------------------------------------------------------------

local function CreateDrawing(type, props)
    local obj = Drawing.new(type)
    for k, v in pairs(props) do obj[k] = v end
    return obj
end

local function RemoveESP(model)
    if ESP_Cache[model] then
        for _, drawing in pairs(ESP_Cache[model].Drawings) do
            drawing:Remove()
        end
        ESP_Cache[model] = nil
    end
end

RunService.RenderStepped:Connect(function()
    if not Config.Enabled then 
        for model, _ in pairs(ESP_Cache) do RemoveESP(model) end
        return 
    end

    if not LiveFolder then LiveFolder = workspace:FindFirstChild("Live") return end

    -- Reset seen status
    for _, entry in pairs(ESP_Cache) do entry.Seen = false end

    for _, folder in ipairs(LiveFolder:GetChildren()) do
        local model = folder:IsA("Model") and folder or folder:FindFirstChildWhichIsA("Model")
        
        -- Ignore LocalPlayer
        if model and model ~= LocalPlayer.Character then
            
            local head = model:FindFirstChild("Head")
            local humanoid = model:FindFirstChild("Humanoid")

            if head and humanoid then
                if not ESP_Cache[model] then
                    ESP_Cache[model] = {
                        Seen = true,
                        Drawings = {
                            Name = CreateDrawing("Text", {Center = true, Outline = true, Color = Color3.new(1,1,1), Size = Config.TextSize}),
                            Box = CreateDrawing("Square", {Thickness = 1, Filled = false, Color = Color3.new(1,0,0)}),
                            HealthBar = CreateDrawing("Square", {Filled = true}),
                            HealthBarBg = CreateDrawing("Square", {Filled = true, Color = Color3.new(0,0,0), Transparency = 0.5})
                        }
                    }
                end

                local entry = ESP_Cache[model]
                entry.Seen = true
                local d = entry.Drawings

                local vector, onScreen = Camera:WorldToViewportPoint(head.Position)
                local distance = (Camera.CFrame.Position - head.Position).Magnitude

                if onScreen and distance <= Config.MaxDistance then
                    local isNPC = model.Name:match("^NPC_")
                    local rootPart = model:FindFirstChild("HumanoidRootPart") or model.PrimaryPart
                    
                    if rootPart then
                        local RootPos, _ = Camera:WorldToViewportPoint(rootPart.Position)
                        local HeadPos = Vector2.new(vector.X, vector.Y)
                        local LegPos = Vector2.new(RootPos.X, RootPos.Y + (vector.Y - RootPos.Y) * -1.5) -- Estimation
                        
                        local BoxHeight = math.abs(HeadPos.Y - LegPos.Y)
                        local BoxWidth = BoxHeight * 0.6
                        local BoxPos = Vector2.new(HeadPos.X - BoxWidth/2, HeadPos.Y - BoxHeight/5) -- Adjust slightly up
                        
                        -- Color Logic
                        local color = isNPC and Color3.new(0.2, 1, 0.2) or Color3.new(1, 0.2, 0.2)

                        -- 1. BOX
                        if Config.Box then
                            d.Box.Visible = true
                            d.Box.Size = Vector2.new(BoxWidth, BoxHeight)
                            d.Box.Position = BoxPos
                            d.Box.Color = color
                        else
                            d.Box.Visible = false
                        end

                        -- 2. NAME
                        if Config.Name then
                            d.Name.Visible = true
                            d.Name.Text = (isNPC and model.Name:gsub("^NPC_", "") or model.Name) .. string.format(" [%.0f]", distance)
                            d.Name.Position = Vector2.new(HeadPos.X, BoxPos.Y - 15)
                            d.Name.Color = color
                        else
                            d.Name.Visible = false
                        end

                        -- 3. HEALTH (Simplified Left Bar)
                        if Config.Health then
                            local hp = humanoid.Health
                            local maxhp = humanoid.MaxHealth
                            local hpPct = math.clamp(hp/maxhp, 0, 1)
                            
                            d.HealthBarBg.Visible = true
                            d.HealthBarBg.Size = Vector2.new(2, BoxHeight)
                            d.HealthBarBg.Position = Vector2.new(BoxPos.X - 5, BoxPos.Y)
                            
                            d.HealthBar.Visible = true
                            d.HealthBar.Size = Vector2.new(2, BoxHeight * hpPct)
                            d.HealthBar.Position = Vector2.new(BoxPos.X - 5, BoxPos.Y + (BoxHeight * (1-hpPct)))
                            d.HealthBar.Color = Color3.fromHSV(hpPct * 0.3, 1, 1) -- Red to Green
                        else
                            d.HealthBarBg.Visible = false
                            d.HealthBar.Visible = false
                        end
                    end
                else
                    for _, v in pairs(d) do v.Visible = false end
                end
            end
        end
    end

    -- Cleanup
    for model, entry in pairs(ESP_Cache) do
        if not entry.Seen or not model.Parent then
            RemoveESP(model)
        end
    end
end)

-- Toggle Menu Input
UserInputService.InputBegan:Connect(function(input, processed)
    if not processed and input.KeyCode == Enum.KeyCode.Insert then
        MainFrame.Visible = not MainFrame.Visible
    end
end)

print("ESP Loaded. Press INSERT to toggle Menu.")