-- Smooth Health Bar System with Posture Display
-- Fixed-length bars with separate damage counters

assert(Drawing, 'Exploit not supported - Drawing API required')

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local CoreGui = game:GetService("CoreGui")

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()
local V2New = Vector2.new
local V3New = Vector3.new
local WorldToViewport = function(...) return Camera.WorldToViewportPoint(Camera, ...) end

-- Configuration
local CONFIG = {
    BarWidth = 180,
    BarHeight = 8,
    Spacing = 10,
    FontSize = 16,
    UpdateRate = 1,
    MaxDistance = 1000,
    ToggleKey = Enum.KeyCode.F3,
    Position = V2New(10, 10)
}

-- Module state
local HealthSystem = {
    Enabled = false,
    MenuOpen = false,
    Instances = {},
    PlayerBars = {},
    Connections = {},
    Dragging = false,
    DragOffset = V2New()
}

-- Drawing manager
local Drawings = {
    __Objects = {}
}

function Drawings:New(type, props)
    local obj = Drawing.new(type)
    if props then
        for k, v in pairs(props) do
            pcall(function() obj[k] = v end)
        end
    end
    table.insert(self.__Objects, obj)
    return obj
end

function Drawings:Clear()
    for _, obj in pairs(self.__Objects) do
        pcall(function() obj:Remove() end)
    end
    self.__Objects = {}
end

-- Main GUI
local function CreateMenu()
    local menu = {
        Elements = {},
        Size = V2New(240, 160),
        Position = CONFIG.Position
    }
    
    -- Main background
    menu.Main = Drawings:New("Square", {
        Size = menu.Size,
        Position = menu.Position,
        Color = Color3.fromRGB(25, 25, 25),
        Filled = true,
        Transparency = 0.9,
        Thickness = 2,
        Visible = false
    })
    
    -- Title bar
    menu.TitleBar = Drawings:New("Square", {
        Size = V2New(menu.Size.X, 30),
        Position = menu.Position,
        Color = Color3.fromRGB(15, 15, 15),
        Filled = true,
        Transparency = 1,
        Visible = false
    })
    
    menu.TitleText = Drawings:New("Text", {
        Text = "Health & Posture Bars",
        Position = menu.Position + V2New(10, 5),
        Size = 18,
        Color = Color3.fromRGB(255, 255, 255),
        Outline = true,
        OutlineOpacity = 0.5,
        Visible = false
    })
    
    -- Toggle button
    menu.ToggleBg = Drawings:New("Square", {
        Size = V2New(menu.Size.X - 20, 35),
        Position = menu.Position + V2New(10, 40),
        Color = Color3.fromRGB(50, 50, 50),
        Filled = true,
        Transparency = 1,
        Visible = false
    })
    
    menu.ToggleText = Drawings:New("Text", {
        Text = "ENABLE BARS",
        Position = menu.Position + V2New(menu.Size.X/2, 57),
        Size = 16,
        Color = Color3.fromRGB(255, 255, 255),
        Center = true,
        Outline = true,
        OutlineOpacity = 0.5,
        Visible = false
    })
    
    -- Status indicator
    menu.StatusDot = Drawings:New("Circle", {
        Position = menu.Position + V2New(15, 95),
        Radius = 5,
        Color = Color3.fromRGB(255, 0, 0),
        Filled = true,
        NumSides = 20,
        Visible = false
    })
    
    menu.StatusText = Drawings:New("Text", {
        Text = "Status: Disabled",
        Position = menu.Position + V2New(30, 87),
        Size = 14,
        Color = Color3.fromRGB(200, 200, 200),
        Visible = false
    })
    
    menu.StatsText = Drawings:New("Text", {
        Text = "Players: 0",
        Position = menu.Position + V2New(10, 115),
        Size = 13,
        Color = Color3.fromRGB(150, 150, 150),
        Visible = false
    })
    
    menu.DamageText = Drawings:New("Text", {
        Text = "Damage indicators: ON",
        Position = menu.Position + V2New(10, 135),
        Size = 12,
        Color = Color3.fromRGB(200, 200, 100),
        Visible = false
    })
    
    return menu
end

-- Health bar creation for a player
local function CreatePlayerBars(player)
    if player == LocalPlayer then return end
    
    local id = player.UserId
    if HealthSystem.PlayerBars[id] then
        -- Clean up old bars
        for _, obj in pairs(HealthSystem.PlayerBars[id].Objects) do
            pcall(function() obj:Remove() end)
        end
    end
    
    local bars = {
        Player = player,
        LastCharacter = nil,  -- Track character for damage reset
        CurrentHealth = 100,
        CurrentPosture = 100,
        TargetHealth = 100,
        TargetPosture = 100,
        
        -- Damage tracking - updated to match reference
        HealthDamage = 0,
        PostureDamage = 0,
        HealthDamageTimer = nil,  -- nil when not active
        PostureDamageTimer = nil, -- nil when not active
        
        Objects = {},
        Visible = true
    }
    
    -- Fixed length bars - backgrounds are full width, fill bars show percentage
    bars.Container = {
        -- Player name
        NameText = Drawings:New("Text", {
            Color = Color3.fromRGB(255, 255, 255),
            Size = 14,
            Center = true,
            Outline = true,
            OutlineOpacity = 0.5,
            Visible = false
        }),
        
        -- Posture bar (top - yellow)
        PostureBarBg = Drawings:New("Square", {
            Color = Color3.fromRGB(30, 30, 30),
            Filled = true,
            Transparency = 0.8,
            Visible = false
        }),
        PostureBar = Drawings:New("Square", {
            Color = Color3.fromRGB(255, 255, 70),
            Filled = true,
            Transparency = 0.9,
            Visible = false
        }),
        PostureText = Drawings:New("Text", {
            Color = Color3.fromRGB(255, 255, 70),
            Size = 12,
            Outline = true,
            OutlineOpacity = 0.5,
            Visible = false
        }),
        
        -- Posture damage indicator (yellow damage numbers)
        PostureDamageText = Drawings:New("Text", {
            Color = Color3.fromRGB(255, 200, 0),
            Size = 22,
            Center = true,
            Outline = true,
            OutlineOpacity = 0.8,
            Visible = false,
            Transparency = 1
        }),
        
        -- Health bar (bottom - red)
        HealthBarBg = Drawings:New("Square", {
            Color = Color3.fromRGB(30, 30, 30),
            Filled = true,
            Transparency = 0.8,
            Visible = false
        }),
        HealthBar = Drawings:New("Square", {
            Color = Color3.fromRGB(255, 70, 70),
            Filled = true,
            Transparency = 0.9,
            Visible = false
        }),
        HealthText = Drawings:New("Text", {
            Color = Color3.fromRGB(255, 255, 255),
            Size = 12,
            Outline = true,
            OutlineOpacity = 0.5,
            Visible = false
        }),
        
        -- Health damage indicator (red damage numbers)
        HealthDamageText = Drawings:New("Text", {
            Color = Color3.fromRGB(255, 100, 100),
            Size = 22,
            Center = true,
            Outline = true,
            OutlineOpacity = 0.8,
            Visible = false,
            Transparency = 1
        })
    }
    
    -- Store objects for easy cleanup
    for _, obj in pairs(bars.Container) do
        table.insert(bars.Objects, obj)
    end
    
    HealthSystem.PlayerBars[id] = bars
    return bars
end

-- Update health bar positions and values
local function UpdateBars()
    if not HealthSystem.Enabled then return end
    
    local viewportSize = Camera.ViewportSize
    local activePlayers = 0
    
    for id, bars in pairs(HealthSystem.PlayerBars) do
        local player = bars.Player
        if not player then 
            HealthSystem.PlayerBars[id] = nil
            continue 
        end
        
        -- Get character and required parts
        local basePath = workspace:FindFirstChild("Live")
        if not basePath then continue end
        
        local playerFolder = basePath:FindFirstChild(player.Name)
        if not playerFolder then continue end
        
        local humanoid = playerFolder:FindFirstChild("Humanoid")
        local lifeforce = playerFolder:FindFirstChild("Lifeforce")
        local posture = playerFolder:FindFirstChild("Posture")
        local character = player.Character
        local head = character and character:FindFirstChild("Head")
        
        if not (humanoid and lifeforce and posture and head) then
            -- Hide bars if missing components
            for _, obj in pairs(bars.Container) do
                obj.Visible = false
            end
            continue
        end
        
        -- Check if this is a different character than before (reset damage)
        if bars.LastCharacter ~= character then
            bars.LastCharacter = character
            bars.HealthDamage = 0
            bars.PostureDamage = 0
            bars.HealthDamageTimer = nil
            bars.PostureDamageTimer = nil
        end
        
        -- Check distance
        local headPos = head.Position
        local distance = (Camera.CFrame.Position - headPos).Magnitude
        if distance > CONFIG.MaxDistance then
            for _, obj in pairs(bars.Container) do
                obj.Visible = false
            end
            continue
        end
        
        -- Get screen position
        local screenPos, visible = WorldToViewport(headPos)
        if not visible or screenPos.Z < 0 then
            for _, obj in pairs(bars.Container) do
                obj.Visible = false
            end
            continue
        end
        
        activePlayers = activePlayers + 1
        
        -- Update target values
        local oldHealth = bars.TargetHealth
        local oldPosture = bars.TargetPosture
        
        bars.TargetHealth = lifeforce.Value
        bars.TargetPosture = posture.Value
        
        -- Track damage taken
        local healthDamage = oldHealth - bars.TargetHealth
        if healthDamage > 0 then
            bars.HealthDamage = bars.HealthDamage + math.floor(healthDamage)
            bars.HealthDamageTimer = 3 -- Show for 3 seconds
        end
        
        local postureDamage = oldPosture - bars.TargetPosture
        if postureDamage > 0 then
            bars.PostureDamage = bars.PostureDamage + math.floor(postureDamage)
            bars.PostureDamageTimer = 3 -- Show for 3 seconds
        end
        
        -- Smooth interpolation
        bars.CurrentHealth = bars.CurrentHealth + (bars.TargetHealth - bars.CurrentHealth) * 0.3
        bars.CurrentPosture = bars.CurrentPosture + (bars.TargetPosture - bars.CurrentPosture) * 0.3
        
        -- Clamp values
        bars.CurrentHealth = math.clamp(bars.CurrentHealth, 0, 100)
        bars.CurrentPosture = math.clamp(bars.CurrentPosture, 0, 100)
        
        -- Position bars above head - FIXED WIDTH
        local baseX = screenPos.X - CONFIG.BarWidth / 2
        local baseY = screenPos.Y - 85 - (distance / 100)
        
        -- Player name
        local nameText = bars.Container.NameText
        nameText.Text = player.Name
        nameText.Position = V2New(screenPos.X, baseY - 20)
        nameText.Visible = true
        nameText.Transparency = math.clamp(1 - (500 / distance), 0.5, 1)
        
        -- POSTURE BAR (Top - Yellow)
        local postureBg = bars.Container.PostureBarBg
        postureBg.Position = V2New(baseX, baseY)
        postureBg.Size = V2New(CONFIG.BarWidth, CONFIG.BarHeight)
        postureBg.Visible = true
        postureBg.Transparency = math.clamp(distance / 1000, 0.5, 0.9)
        
        local postureFill = bars.Container.PostureBar
        postureFill.Position = V2New(baseX, baseY)
        postureFill.Size = V2New(CONFIG.BarWidth * (bars.CurrentPosture / 100), CONFIG.BarHeight)
        postureFill.Visible = true
        postureFill.Transparency = math.clamp(distance / 1000, 0.5, 0.9)
        postureFill.Color = Color3.fromRGB(255, 255, 70)
        
        -- Posture text
        local postureText = bars.Container.PostureText
        postureText.Text = string.format("Posture: %d", math.floor(bars.CurrentPosture))
        postureText.Position = V2New(baseX + CONFIG.BarWidth + 5, baseY - 2)
        postureText.Visible = true
        postureText.Transparency = math.clamp(distance / 1000, 0.5, 0.9)
        
        -- HEALTH BAR (Bottom - Red)
        local healthBg = bars.Container.HealthBarBg
        healthBg.Position = V2New(baseX, baseY + CONFIG.Spacing)
        healthBg.Size = V2New(CONFIG.BarWidth, CONFIG.BarHeight)
        healthBg.Visible = true
        healthBg.Transparency = math.clamp(distance / 1000, 0.5, 0.9)
        
        local healthFill = bars.Container.HealthBar
        healthFill.Position = V2New(baseX, baseY + CONFIG.Spacing)
        healthFill.Size = V2New(CONFIG.BarWidth * (bars.CurrentHealth / 100), CONFIG.BarHeight)
        healthFill.Visible = true
        healthFill.Transparency = math.clamp(distance / 1000, 0.5, 0.9)
        healthFill.Color = Color3.fromRGB(255, 70, 70)
        
        -- Health text
        local healthText = bars.Container.HealthText
        healthText.Text = string.format("HP: %d", math.floor(bars.CurrentHealth))
        healthText.Position = V2New(baseX + CONFIG.BarWidth + 5, baseY + CONFIG.Spacing - 2)
        healthText.Visible = true
        healthText.Transparency = math.clamp(distance / 1000, 0.5, 0.9)
        
        -- POSTURE DAMAGE INDICATOR (Yellow damage numbers)
        if bars.PostureDamageTimer then
            bars.PostureDamageTimer = bars.PostureDamageTimer - 0.016
            
            if bars.PostureDamageTimer < 0 then
                bars.PostureDamageTimer = nil
                bars.PostureDamage = 0
                bars.Container.PostureDamageText.Visible = false
                bars.Container.PostureDamageText.Transparency = 1
            else
                local postureDamageText = bars.Container.PostureDamageText
                postureDamageText.Text = "-" .. bars.PostureDamage
                postureDamageText.Position = V2New(screenPos.X, baseY - 45)
                postureDamageText.Visible = true
                postureDamageText.Transparency = 0
                
                -- Float up effect
                local floatOffset = (3 - bars.PostureDamageTimer) * 8
                postureDamageText.Position = V2New(screenPos.X, baseY - 45 - floatOffset)
            end
        else
            bars.Container.PostureDamageText.Visible = false
            bars.Container.PostureDamageText.Transparency = 1
        end
        
        -- HEALTH DAMAGE INDICATOR (Red damage numbers)
        if bars.HealthDamageTimer then
            bars.HealthDamageTimer = bars.HealthDamageTimer - 0.016
            
            if bars.HealthDamageTimer < 0 then
                bars.HealthDamageTimer = nil
                bars.HealthDamage = 0
                bars.Container.HealthDamageText.Visible = false
                bars.Container.HealthDamageText.Transparency = 1
            else
                local healthDamageText = bars.Container.HealthDamageText
                healthDamageText.Text = "-" .. bars.HealthDamage
                healthDamageText.Position = V2New(screenPos.X, baseY - 15)
                healthDamageText.Visible = true
                healthDamageText.Transparency = 0
                
                -- Float up effect
                local floatOffset = (3 - bars.HealthDamageTimer) * 8
                healthDamageText.Position = V2New(screenPos.X, baseY - 15 - floatOffset)
            end
        else
            bars.Container.HealthDamageText.Visible = false
            bars.Container.HealthDamageText.Transparency = 1
        end
        
        -- Set humanoid display type to AlwaysOn
        humanoid.HealthDisplayType = Enum.HumanoidHealthDisplayType.AlwaysOn
        
        -- Track damage from HealthChanged for lifeforce
        if not bars.HealthConnection then
            bars.HealthConnection = humanoid.HealthChanged:Connect(function(newHealth)
                local oldHealth = humanoid.Health
                local damage = oldHealth - newHealth
                if damage > 0 then
                    bars.HealthDamage = bars.HealthDamage + math.floor(damage)
                    bars.HealthDamageTimer = 3  -- Show for 3 seconds
                end
            end)
            table.insert(HealthSystem.Connections, bars.HealthConnection)
        end
        
        -- Track posture damage
        if not bars.PostureConnection and posture then
            bars.PostureConnection = posture.Changed:Connect(function(newValue)
                local oldValue = bars.TargetPosture
                local damage = oldValue - newValue
                if damage > 0 then
                    bars.PostureDamage = bars.PostureDamage + math.floor(damage)
                    bars.PostureDamageTimer = 3  -- Show for 3 seconds
                end
                bars.TargetPosture = newValue
            end)
            table.insert(HealthSystem.Connections, bars.PostureConnection)
        end
    end
    
    -- Update menu stats
    if HealthSystem.MenuOpen and HealthSystem.Menu then
        HealthSystem.Menu.StatsText.Text = string.format("Players: %d | Distance: %dm", activePlayers, CONFIG.MaxDistance)
    end
end

-- Toggle system
local function ToggleSystem()
    HealthSystem.Enabled = not HealthSystem.Enabled
    
    if HealthSystem.Menu then
        if HealthSystem.Enabled then
            HealthSystem.Menu.ToggleText.Text = "DISABLE BARS"
            HealthSystem.Menu.ToggleBg.Color = Color3.fromRGB(200, 50, 50)
            HealthSystem.Menu.StatusDot.Color = Color3.fromRGB(0, 255, 0)
            HealthSystem.Menu.StatusText.Text = "Status: Enabled"
            HealthSystem.Menu.DamageText.Visible = true
        else
            HealthSystem.Menu.ToggleText.Text = "ENABLE BARS"
            HealthSystem.Menu.ToggleBg.Color = Color3.fromRGB(50, 150, 50)
            HealthSystem.Menu.StatusDot.Color = Color3.fromRGB(255, 0, 0)
            HealthSystem.Menu.StatusText.Text = "Status: Disabled"
            HealthSystem.Menu.DamageText.Visible = false
            
            -- Hide all bars
            for _, bars in pairs(HealthSystem.PlayerBars) do
                for _, obj in pairs(bars.Container) do
                    obj.Visible = false
                end
            end
        end
    end
    
    print("[HealthSystem] " .. (HealthSystem.Enabled and "Enabled" or "Disabled"))
end

-- Toggle menu
local function ToggleMenu()
    HealthSystem.MenuOpen = not HealthSystem.MenuOpen
    
    if HealthSystem.Menu then
        for _, element in pairs(HealthSystem.Menu) do
            if type(element) == "table" and element.Visible ~= nil then
                element.Visible = HealthSystem.MenuOpen
            end
        end
    end
end

-- Initialize
local function Initialize()
    -- Create menu
    HealthSystem.Menu = CreateMenu()
    
    -- Setup input handling
    local inputBegan = UserInputService.InputBegan:Connect(function(input, processed)
        if processed then return end
        
        if input.KeyCode == CONFIG.ToggleKey then
            ToggleSystem()
        elseif input.KeyCode == Enum.KeyCode.F4 then
            ToggleMenu()
        elseif input.UserInputType == Enum.UserInputType.MouseButton1 and HealthSystem.MenuOpen then
            -- Check if dragging menu
            local mousePos = UserInputService:GetMouseLocation()
            local titleBar = HealthSystem.Menu.TitleBar
            if mousePos.X >= titleBar.Position.X and mousePos.X <= titleBar.Position.X + titleBar.Size.X and
               mousePos.Y >= titleBar.Position.Y and mousePos.Y <= titleBar.Position.Y + titleBar.Size.Y then
                HealthSystem.Dragging = true
                HealthSystem.DragOffset = titleBar.Position - mousePos
            end
            
            -- Check toggle button
            local toggle = HealthSystem.Menu.ToggleBg
            if mousePos.X >= toggle.Position.X and mousePos.X <= toggle.Position.X + toggle.Size.X and
               mousePos.Y >= toggle.Position.Y and mousePos.Y <= toggle.Position.Y + toggle.Size.Y then
                ToggleSystem()
            end
        end
    end)
    table.insert(HealthSystem.Connections, inputBegan)
    
    local inputEnded = UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            HealthSystem.Dragging = false
        end
    end)
    table.insert(HealthSystem.Connections, inputEnded)
    
    local inputChanged = UserInputService.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement and HealthSystem.Dragging and HealthSystem.Menu then
            local mousePos = UserInputService:GetMouseLocation()
            local newPos = mousePos + HealthSystem.DragOffset
            
            -- Clamp to screen
            newPos = V2New(
                math.clamp(newPos.X, 0, Camera.ViewportSize.X - HealthSystem.Menu.Size.X),
                math.clamp(newPos.Y, 0, Camera.ViewportSize.Y - HealthSystem.Menu.Size.Y)
            )
            
            -- Update menu position
            HealthSystem.Menu.Main.Position = newPos
            HealthSystem.Menu.TitleBar.Position = newPos
            HealthSystem.Menu.TitleText.Position = newPos + V2New(10, 5)
            HealthSystem.Menu.ToggleBg.Position = newPos + V2New(10, 40)
            HealthSystem.Menu.ToggleText.Position = newPos + V2New(HealthSystem.Menu.Size.X/2, 57)
            HealthSystem.Menu.StatusDot.Position = newPos + V2New(15, 95)
            HealthSystem.Menu.StatusText.Position = newPos + V2New(30, 87)
            HealthSystem.Menu.StatsText.Position = newPos + V2New(10, 115)
            HealthSystem.Menu.DamageText.Position = newPos + V2New(10, 135)
        end
    end)
    table.insert(HealthSystem.Connections, inputChanged)
    
    -- Player added handler
    local playerAdded = Players.PlayerAdded:Connect(function(player)
        if player == LocalPlayer then return end
        
        -- Create bars when character loads
        local function onCharacterAdded(character)
            task.wait(0.5)
            CreatePlayerBars(player)
        end
        
        if player.Character then
            onCharacterAdded(player.Character)
        end
        
        player.CharacterAdded:Connect(onCharacterAdded)
    end)
    table.insert(HealthSystem.Connections, playerAdded)
    
    -- Handle existing players
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            CreatePlayerBars(player)
        end
    end
    
    -- Render loop
    RunService.RenderStepped:Connect(UpdateBars)
    
    -- Camera change handler
    local cameraChanged = workspace:GetPropertyChangedSignal("CurrentCamera"):Connect(function()
        Camera = workspace.CurrentCamera
        WorldToViewport = function(...) return Camera.WorldToViewportPoint(Camera, ...) end
    end)
    table.insert(HealthSystem.Connections, cameraChanged)
    
    print("[HealthSystem] Initialized successfully")
    print("[HealthSystem] Press F3 to toggle bars, F4 to toggle menu")
    print("[HealthSystem] Damage indicators: Health (red) | Posture (yellow)")
    print("[HealthSystem] Damage accumulates for 3 seconds and resets on new target")
end

-- Start the system
local success, err = pcall(Initialize)
if not success then
    warn("[HealthSystem] Failed to initialize: " .. tostring(err))
else
    -- Initial menu state
    HealthSystem.MenuOpen = true
    ToggleMenu()
end

-- Cleanup on script unload
game:GetService("CoreGui").ChildRemoved:Connect(function(child)
    if child.Name == "HealthBarController" then
        Drawings:Clear()
        for _, conn in pairs(HealthSystem.Connections) do
            pcall(function() conn:Disconnect() end)
        end
    end
end)
