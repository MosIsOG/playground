-- Smooth Health Bar System - NPC Only
-- Shows health bars for any NPC with naming convention "NPC_XXXXXXXXXX"

assert(Drawing, 'Exploit not supported - Drawing API required')

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local CoreGui = game:GetService("CoreGui")

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()
local V2New = Vector2.new
local V3New = Vector3.new
local WorldToViewport = function(...) return Camera.WorldToViewportPoint(Camera, ...) end

-- Configuration
local CONFIG = {
    BarWidth = 160,
    BarHeight = 6,
    Spacing = 10,
    FontSize = 14,
    UpdateRate = 1,
    MaxDistance = 1000,
    ToggleKey = Enum.KeyCode.F3,
    Position = V2New(10, 10)
}

-- Module state
local HealthSystem = {
    Enabled = false,
    MenuOpen = false,
    Instances = {},
    NPCBars = {},
    Connections = {},
    Dragging = false,
    DragOffset = V2New()
}

-- Drawing manager
local Drawings = {
    __Objects = {}
}

function Drawings:New(type, props)
    local obj = Drawing.new(type)
    if props then
        for k, v in pairs(props) do
            pcall(function() obj[k] = v end)
        end
    end
    table.insert(self.__Objects, obj)
    return obj
end

function Drawings:Clear()
    for _, obj in pairs(self.__Objects) do
        pcall(function() obj:Remove() end)
    end
    self.__Objects = {}
end

-- Check if a model is an NPC (starts with "NPC_")
local function IsNPC(model)
    if not model then return false end
    return string.sub(model.Name, 1, 4) == "NPC_"
end

-- Main GUI
local function CreateMenu()
    local menu = {
        Elements = {},
        Size = V2New(240, 160),
        Position = CONFIG.Position
    }
    
    -- Main background
    menu.Main = Drawings:New("Square", {
        Size = menu.Size,
        Position = menu.Position,
        Color = Color3.fromRGB(25, 25, 25),
        Filled = true,
        Transparency = 0.9,
        Thickness = 2,
        Visible = false
    })
    
    -- Title bar
    menu.TitleBar = Drawings:New("Square", {
        Size = V2New(menu.Size.X, 30),
        Position = menu.Position,
        Color = Color3.fromRGB(15, 15, 15),
        Filled = true,
        Transparency = 1,
        Visible = false
    })
    
    menu.TitleText = Drawings:New("Text", {
        Text = "NPC Health Bars",
        Position = menu.Position + V2New(10, 5),
        Size = 18,
        Color = Color3.fromRGB(255, 255, 255),
        Outline = true,
        OutlineOpacity = 0.5,
        Visible = false
    })
    
    -- Toggle button
    menu.ToggleBg = Drawings:New("Square", {
        Size = V2New(menu.Size.X - 20, 35),
        Position = menu.Position + V2New(10, 40),
        Color = Color3.fromRGB(50, 50, 50),
        Filled = true,
        Transparency = 1,
        Visible = false
    })
    
    menu.ToggleText = Drawings:New("Text", {
        Text = "ENABLE BARS",
        Position = menu.Position + V2New(menu.Size.X/2, 57),
        Size = 16,
        Color = Color3.fromRGB(255, 255, 255),
        Center = true,
        Outline = true,
        OutlineOpacity = 0.5,
        Visible = false
    })
    
    -- Status indicator
    menu.StatusDot = Drawings:New("Circle", {
        Position = menu.Position + V2New(15, 95),
        Radius = 5,
        Color = Color3.fromRGB(255, 0, 0),
        Filled = true,
        NumSides = 20,
        Visible = false
    })
    
    menu.StatusText = Drawings:New("Text", {
        Text = "Status: Disabled",
        Position = menu.Position + V2New(30, 87),
        Size = 14,
        Color = Color3.fromRGB(200, 200, 200),
        Visible = false
    })
    
    menu.StatsText = Drawings:New("Text", {
        Text = "NPCs: 0",
        Position = menu.Position + V2New(10, 115),
        Size = 13,
        Color = Color3.fromRGB(150, 150, 150),
        Visible = false
    })
    
    menu.DamageText = Drawings:New("Text", {
        Text = "NPC Mode: ON",
        Position = menu.Position + V2New(10, 135),
        Size = 12,
        Color = Color3.fromRGB(100, 200, 255),
        Visible = false
    })
    
    return menu
end

-- Health bar creation for an NPC
local function CreateNPCBar(npcModel)
    local id = npcModel.Name .. tostring(npcModel:GetHashCode())
    
    if HealthSystem.NPCBars[id] then
        -- Clean up old bars
        for _, obj in pairs(HealthSystem.NPCBars[id].Objects) do
            pcall(function() obj:Remove() end)
        end
    end
    
    local bars = {
        NPC = npcModel,
        LastHumanoid = nil,
        CurrentHealth = 100,
        TargetHealth = 100,
        MaxHealth = 100,
        
        Objects = {},
        Visible = true
    }
    
    -- Simple health bar only
    bars.Container = {
        -- NPC name (truncated if too long)
        NameText = Drawings:New("Text", {
            Color = Color3.fromRGB(255, 255, 255),
            Size = 13,
            Center = true,
            Outline = true,
            OutlineOpacity = 0.5,
            Visible = false
        }),
        
        -- Health bar
        HealthBarBg = Drawings:New("Square", {
            Color = Color3.fromRGB(30, 30, 30),
            Filled = true,
            Transparency = 0.8,
            Visible = false
        }),
        HealthBar = Drawings:New("Square", {
            Color = Color3.fromRGB(255, 70, 70),
            Filled = true,
            Transparency = 0.9,
            Visible = false
        }),
        HealthText = Drawings:New("Text", {
            Color = Color3.fromRGB(255, 255, 255),
            Size = 11,
            Outline = true,
            OutlineOpacity = 0.5,
            Visible = false
        })
    }
    
    -- Store objects for easy cleanup
    for _, obj in pairs(bars.Container) do
        table.insert(bars.Objects, obj)
    end
    
    HealthSystem.NPCBars[id] = bars
    return bars
end

-- Update health bar positions and values
local function UpdateBars()
    if not HealthSystem.Enabled then return end
    
    local activeNPCs = 0
    
    for id, bars in pairs(HealthSystem.NPCBars) do
        local npc = bars.NPC
        if not npc or not npc.Parent then 
            -- Clean up if NPC no longer exists
            for _, obj in pairs(bars.Objects) do
                pcall(function() obj:Remove() end)
            end
            HealthSystem.NPCBars[id] = nil
            continue 
        end
        
        -- Get humanoid and head
        local humanoid = npc:FindFirstChild("Humanoid")
        local head = npc:FindFirstChild("Head")
        
        if not (humanoid and head) then
            -- Hide bars if missing components
            for _, obj in pairs(bars.Container) do
                obj.Visible = false
            end
            continue
        end
        
        -- Check if this is a different humanoid than before
        if bars.LastHumanoid ~= humanoid then
            bars.LastHumanoid = humanoid
            bars.MaxHealth = humanoid.MaxHealth
        end
        
        -- Update max health if it changed
        if humanoid.MaxHealth ~= bars.MaxHealth then
            bars.MaxHealth = humanoid.MaxHealth
        end
        
        -- Check distance
        local headPos = head.Position
        local distance = (Camera.CFrame.Position - headPos).Magnitude
        if distance > CONFIG.MaxDistance then
            for _, obj in pairs(bars.Container) do
                obj.Visible = false
            end
            continue
        end
        
        -- Get screen position
        local screenPos, visible = WorldToViewport(headPos)
        if not visible or screenPos.Z < 0 then
            for _, obj in pairs(bars.Container) do
                obj.Visible = false
            end
            continue
        end
        
        activeNPCs = activeNPCs + 1
        
        -- Update target health
        bars.TargetHealth = humanoid.Health
        
        -- Smooth interpolation
        bars.CurrentHealth = bars.CurrentHealth + (bars.TargetHealth - bars.CurrentHealth) * 0.3
        
        -- Clamp value
        bars.CurrentHealth = math.clamp(bars.CurrentHealth, 0, bars.MaxHealth)
        
        -- Calculate fill percentage
        local healthFillPercent = bars.CurrentHealth / bars.MaxHealth
        
        -- Position bar above head
        local baseX = screenPos.X - CONFIG.BarWidth / 2
        local baseY = screenPos.Y - 65 - (distance / 100)
        
        -- NPC name (clean up the name - remove NPC_ prefix and truncate UUID)
        local displayName = npc.Name
        if string.sub(displayName, 1, 4) == "NPC_" then
            displayName = string.sub(displayName, 5)
        end
        -- Truncate long UUIDs
        if #displayName > 12 then
            displayName = string.sub(displayName, 1, 8) .. "..."
        end
        
        local nameText = bars.Container.NameText
        nameText.Text = displayName
        nameText.Position = V2New(screenPos.X, baseY - 20)
        nameText.Visible = true
        nameText.Transparency = math.clamp(1 - (500 / distance), 0.5, 1)
        
        -- HEALTH BAR
        local healthBg = bars.Container.HealthBarBg
        healthBg.Position = V2New(baseX, baseY)
        healthBg.Size = V2New(CONFIG.BarWidth, CONFIG.BarHeight)
        healthBg.Visible = true
        healthBg.Transparency = math.clamp(distance / 1000, 0.5, 0.9)
        
        local healthFill = bars.Container.HealthBar
        healthFill.Position = V2New(baseX, baseY)
        healthFill.Size = V2New(CONFIG.BarWidth * healthFillPercent, CONFIG.BarHeight)
        healthFill.Visible = true
        healthFill.Transparency = math.clamp(distance / 1000, 0.5, 0.9)
        
        -- Health text with current/max format
        local healthText = bars.Container.HealthText
        healthText.Text = string.format("%.0f/%.0f", bars.CurrentHealth, bars.MaxHealth)
        healthText.Position = V2New(baseX + CONFIG.BarWidth + 5, baseY - 2)
        healthText.Visible = true
        healthText.Transparency = math.clamp(distance / 1000, 0.5, 0.9)
        
        -- Set humanoid display type to AlwaysOn
        humanoid.HealthDisplayType = Enum.HumanoidHealthDisplayType.AlwaysOn
    end
    
    -- Update menu stats
    if HealthSystem.MenuOpen and HealthSystem.Menu then
        HealthSystem.Menu.StatsText.Text = string.format("NPCs: %d | Distance: %dm", activeNPCs, CONFIG.MaxDistance)
    end
end

-- Scan workspace for NPCs
local function ScanForNPCs()
    local liveFolder = workspace:FindFirstChild("Live")
    if not liveFolder then return end
    
    for _, child in pairs(liveFolder:GetChildren()) do
        if IsNPC(child) and child:FindFirstChild("Humanoid") then
            CreateNPCBar(child)
        end
    end
end

-- Toggle system
local function ToggleSystem()
    HealthSystem.Enabled = not HealthSystem.Enabled
    
    if HealthSystem.Menu then
        if HealthSystem.Enabled then
            HealthSystem.Menu.ToggleText.Text = "DISABLE BARS"
            HealthSystem.Menu.ToggleBg.Color = Color3.fromRGB(200, 50, 50)
            HealthSystem.Menu.StatusDot.Color = Color3.fromRGB(0, 255, 0)
            HealthSystem.Menu.StatusText.Text = "Status: Enabled"
            HealthSystem.Menu.DamageText.Visible = true
            
            -- Rescan for NPCs when enabling
            ScanForNPCs()
        else
            HealthSystem.Menu.ToggleText.Text = "ENABLE BARS"
            HealthSystem.Menu.ToggleBg.Color = Color3.fromRGB(50, 150, 50)
            HealthSystem.Menu.StatusDot.Color = Color3.fromRGB(255, 0, 0)
            HealthSystem.Menu.StatusText.Text = "Status: Disabled"
            HealthSystem.Menu.DamageText.Visible = false
            
            -- Hide all bars
            for _, bars in pairs(HealthSystem.NPCBars) do
                for _, obj in pairs(bars.Container) do
                    obj.Visible = false
                end
            end
        end
    end
    
    print("[HealthSystem] " .. (HealthSystem.Enabled and "Enabled" or "Disabled"))
end

-- Toggle menu
local function ToggleMenu()
    HealthSystem.MenuOpen = not HealthSystem.MenuOpen
    
    if HealthSystem.Menu then
        for _, element in pairs(HealthSystem.Menu) do
            if type(element) == "table" and element.Visible ~= nil then
                element.Visible = HealthSystem.MenuOpen
            end
        end
    end
end

-- Initialize
local function Initialize()
    -- Create menu
    HealthSystem.Menu = CreateMenu()
    
    -- Setup input handling
    local inputBegan = UserInputService.InputBegan:Connect(function(input, processed)
        if processed then return end
        
        if input.KeyCode == CONFIG.ToggleKey then
            ToggleSystem()
        elseif input.KeyCode == Enum.KeyCode.F4 then
            ToggleMenu()
        elseif input.UserInputType == Enum.UserInputType.MouseButton1 and HealthSystem.MenuOpen then
            -- Check if dragging menu
            local mousePos = UserInputService:GetMouseLocation()
            local titleBar = HealthSystem.Menu.TitleBar
            if mousePos.X >= titleBar.Position.X and mousePos.X <= titleBar.Position.X + titleBar.Size.X and
               mousePos.Y >= titleBar.Position.Y and mousePos.Y <= titleBar.Position.Y + titleBar.Size.Y then
                HealthSystem.Dragging = true
                HealthSystem.DragOffset = titleBar.Position - mousePos
            end
            
            -- Check toggle button
            local toggle = HealthSystem.Menu.ToggleBg
            if mousePos.X >= toggle.Position.X and mousePos.X <= toggle.Position.X + toggle.Size.X and
               mousePos.Y >= toggle.Position.Y and mousePos.Y <= toggle.Position.Y + toggle.Size.Y then
                ToggleSystem()
            end
        end
    end)
    table.insert(HealthSystem.Connections, inputBegan)
    
    local inputEnded = UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            HealthSystem.Dragging = false
        end
    end)
    table.insert(HealthSystem.Connections, inputEnded)
    
    local inputChanged = UserInputService.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement and HealthSystem.Dragging and HealthSystem.Menu then
            local mousePos = UserInputService:GetMouseLocation()
            local newPos = mousePos + HealthSystem.DragOffset
            
            -- Clamp to screen
            newPos = V2New(
                math.clamp(newPos.X, 0, Camera.ViewportSize.X - HealthSystem.Menu.Size.X),
                math.clamp(newPos.Y, 0, Camera.ViewportSize.Y - HealthSystem.Menu.Size.Y)
            )
            
            -- Update menu position
            HealthSystem.Menu.Main.Position = newPos
            HealthSystem.Menu.TitleBar.Position = newPos
            HealthSystem.Menu.TitleText.Position = newPos + V2New(10, 5)
            HealthSystem.Menu.ToggleBg.Position = newPos + V2New(10, 40)
            HealthSystem.Menu.ToggleText.Position = newPos + V2New(HealthSystem.Menu.Size.X/2, 57)
            HealthSystem.Menu.StatusDot.Position = newPos + V2New(15, 95)
            HealthSystem.Menu.StatusText.Position = newPos + V2New(30, 87)
            HealthSystem.Menu.StatsText.Position = newPos + V2New(10, 115)
            HealthSystem.Menu.DamageText.Position = newPos + V2New(10, 135)
        end
    end)
    table.insert(HealthSystem.Connections, inputChanged)
    
    -- Watch for new NPCs in Live folder
    local liveFolder = workspace:FindFirstChild("Live")
    if liveFolder then
        local childAdded = liveFolder.ChildAdded:Connect(function(child)
            if IsNPC(child) then
                task.wait(0.5) -- Wait for humanoid to load
                CreateNPCBar(child)
            end
        end)
        table.insert(HealthSystem.Connections, childAdded)
        
        local childRemoved = liveFolder.ChildRemoved:Connect(function(child)
            -- Clean up when NPC is removed
            for id, bars in pairs(HealthSystem.NPCBars) do
                if bars.NPC == child then
                    for _, obj in pairs(bars.Objects) do
                        pcall(function() obj:Remove() end)
                    end
                    HealthSystem.NPCBars[id] = nil
                    break
                end
            end
        end)
        table.insert(HealthSystem.Connections, childRemoved)
    end
    
    -- Initial scan for existing NPCs
    ScanForNPCs()
    
    -- Render loop
    RunService.RenderStepped:Connect(UpdateBars)
    
    -- Camera change handler
    local cameraChanged = workspace:GetPropertyChangedSignal("CurrentCamera"):Connect(function()
        Camera = workspace.CurrentCamera
        WorldToViewport = function(...) return Camera.WorldToViewportPoint(Camera, ...) end
    end)
    table.insert(HealthSystem.Connections, cameraChanged)
    
    print("[HealthSystem] Initialized successfully")
    print("[HealthSystem] Press F3 to toggle bars, F4 to toggle menu")
    print("[HealthSystem] NPC Mode: Shows health bars for NPC_ prefixed models")
    print("[HealthSystem] Using Humanoid.HealthDisplayType = AlwaysOn")
end

-- Start the system
local success, err = pcall(Initialize)
if not success then
    warn("[HealthSystem] Failed to initialize: " .. tostring(err))
else
    -- Initial menu state
    HealthSystem.MenuOpen = true
    ToggleMenu()
end

-- Cleanup on script unload
game:GetService("CoreGui").ChildRemoved:Connect(function(child)
    if child.Name == "HealthBarController" then
        Drawings:Clear()
        for _, conn in pairs(HealthSystem.Connections) do
            pcall(function() conn:Disconnect() end)
        end
    end
end)
