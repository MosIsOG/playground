-- Smooth Health Bar System with Posture Display
-- Inspired by Unnamed ESP's clean UI style

assert(Drawing, 'Exploit not supported - Drawing API required')

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local CoreGui = game:GetService("CoreGui")

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()
local V2New = Vector2.new
local V3New = Vector3.new
local WorldToViewport = function(...) return Camera.WorldToViewportPoint(Camera, ...) end

-- Configuration
local CONFIG = {
    BarWidth = 180,
    BarHeight = 8,
    Spacing = 10,
    FontSize = 16,
    UpdateRate = 1, -- ms
    MaxDistance = 1000,
    ToggleKey = Enum.KeyCode.F3,
    Position = V2New(10, 10)
}

-- Module state
local HealthSystem = {
    Enabled = false,
    MenuOpen = false,
    Instances = {},
    PlayerBars = {},
    Connections = {},
    Dragging = false,
    DragOffset = V2New()
}

-- Smooth value interpolation
local SmoothValue = {}
SmoothValue.__index = SmoothValue

function SmoothValue.new(initial)
    local self = setmetatable({
        Current = initial or 0,
        Target = initial or 0,
        Velocity = 0,
        SmoothTime = 0.15
    }, SmoothValue)
    return self
end

function SmoothValue:Update(dt)
    local smoothness = 8
    self.Current = self.Current + (self.Target - self.Current) * math.min(1, dt * smoothness)
    return self.Current
end

function SmoothValue:Set(target)
    self.Target = target
end

-- Drawing manager
local Drawings = {
    __Objects = {}
}

function Drawings:New(type, props)
    local obj = Drawing.new(type)
    if props then
        for k, v in pairs(props) do
            pcall(function() obj[k] = v end)
        end
    end
    table.insert(self.__Objects, obj)
    return obj
end

function Drawings:Clear()
    for _, obj in pairs(self.__Objects) do
        pcall(function() obj:Remove() end)
    end
    self.__Objects = {}
end

-- Main GUI
local function CreateMenu()
    local menu = {
        Elements = {},
        Size = V2New(220, 140),
        Position = CONFIG.Position
    }
    
    -- Main background
    menu.Main = Drawings:New("Square", {
        Size = menu.Size,
        Position = menu.Position,
        Color = Color3.fromRGB(25, 25, 25),
        Filled = true,
        Transparency = 0.9,
        Thickness = 2,
        Visible = false
    })
    
    -- Title bar
    menu.TitleBar = Drawings:New("Square", {
        Size = V2New(menu.Size.X, 30),
        Position = menu.Position,
        Color = Color3.fromRGB(15, 15, 15),
        Filled = true,
        Transparency = 1,
        Visible = false
    })
    
    menu.TitleText = Drawings:New("Text", {
        Text = "Health Bar Controller",
        Position = menu.Position + V2New(10, 5),
        Size = 18,
        Color = Color3.fromRGB(255, 255, 255),
        Outline = true,
        OutlineOpacity = 0.5,
        Visible = false
    })
    
    -- Toggle button
    menu.ToggleBg = Drawings:New("Square", {
        Size = V2New(menu.Size.X - 20, 35),
        Position = menu.Position + V2New(10, 40),
        Color = Color3.fromRGB(50, 50, 50),
        Filled = true,
        Transparency = 1,
        Visible = false
    })
    
    menu.ToggleText = Drawings:New("Text", {
        Text = "ENABLE HEALTH BARS",
        Position = menu.Position + V2New(menu.Size.X/2, 57),
        Size = 16,
        Color = Color3.fromRGB(255, 255, 255),
        Center = true,
        Outline = true,
        OutlineOpacity = 0.5,
        Visible = false
    })
    
    -- Status indicator
    menu.StatusDot = Drawings:New("Circle", {
        Position = menu.Position + V2New(15, 95),
        Radius = 5,
        Color = Color3.fromRGB(255, 0, 0),
        Filled = true,
        NumSides = 20,
        Visible = false
    })
    
    menu.StatusText = Drawings:New("Text", {
        Text = "Status: Disabled",
        Position = menu.Position + V2New(30, 87),
        Size = 14,
        Color = Color3.fromRGB(200, 200, 200),
        Visible = false
    })
    
    menu.StatsText = Drawings:New("Text", {
        Text = "Players: 0",
        Position = menu.Position + V2New(10, 115),
        Size = 13,
        Color = Color3.fromRGB(150, 150, 150),
        Visible = false
    })
    
    return menu
end

-- Health bar creation for a player
local function CreatePlayerBars(player)
    if player == LocalPlayer then return end
    
    local id = player.UserId
    if HealthSystem.PlayerBars[id] then
        -- Clean up old bars
        for _, obj in pairs(HealthSystem.PlayerBars[id].Objects) do
            pcall(function() obj:Remove() end)
        end
    end
    
    local bars = {
        Player = player,
        SmoothHealth = SmoothValue.new(100),
        SmoothPosture = SmoothValue.new(100),
        HitCounter = 0,
        HitTimer = 0,
        Objects = {},
        Visible = true
    }
    
    -- Billboard GUI container (using Drawing objects for performance)
    bars.Container = {
        HealthBarBg = Drawings:New("Square", {
            Color = Color3.fromRGB(20, 20, 20),
            Filled = true,
            Transparency = 0.8,
            Visible = false
        }),
        HealthBar = Drawings:New("Square", {
            Color = Color3.fromRGB(255, 70, 70),
            Filled = true,
            Transparency = 0.9,
            Visible = false
        }),
        PostureBarBg = Drawings:New("Square", {
            Color = Color3.fromRGB(20, 20, 20),
            Filled = true,
            Transparency = 0.8,
            Visible = false
        }),
        PostureBar = Drawings:New("Square", {
            Color = Color3.fromRGB(255, 255, 70),
            Filled = true,
            Transparency = 0.9,
            Visible = false
        }),
        DamageText = Drawings:New("Text", {
            Color = Color3.fromRGB(255, 100, 100),
            Size = 20,
            Center = true,
            Outline = true,
            OutlineOpacity = 0.7,
            Visible = false
        })
    }
    
    -- Store objects for easy cleanup
    for _, obj in pairs(bars.Container) do
        table.insert(bars.Objects, obj)
    end
    
    HealthSystem.PlayerBars[id] = bars
    return bars
end

-- Update health bar positions and values
local function UpdateBars(dt)
    if not HealthSystem.Enabled then return end
    
    local viewportSize = Camera.ViewportSize
    local activePlayers = 0
    
    for id, bars in pairs(HealthSystem.PlayerBars) do
        local player = bars.Player
        if not player then 
            HealthSystem.PlayerBars[id] = nil
            continue 
        end
        
        -- Get character and required parts
        local basePath = workspace:FindFirstChild("Live")
        if not basePath then continue end
        
        local playerFolder = basePath:FindFirstChild(player.Name)
        if not playerFolder then continue end
        
        local humanoid = playerFolder:FindFirstChild("Humanoid")
        local lifeforce = playerFolder:FindFirstChild("Lifeforce")
        local posture = playerFolder:FindFirstChild("Posture")
        local character = player.Character
        local head = character and character:FindFirstChild("Head")
        
        if not (humanoid and lifeforce and posture and head) then
            -- Hide bars if missing components
            for _, obj in pairs(bars.Container) do
                obj.Visible = false
            end
            continue
        end
        
        -- Check distance
        local headPos = head.Position
        local distance = (Camera.CFrame.Position - headPos).Magnitude
        if distance > CONFIG.MaxDistance then
            for _, obj in pairs(bars.Container) do
                obj.Visible = false
            end
            continue
        end
        
        -- Get screen position
        local screenPos, visible = WorldToViewport(headPos)
        if not visible or screenPos.Z < 0 then
            for _, obj in pairs(bars.Container) do
                obj.Visible = false
            end
            continue
        end
        
        activePlayers = activePlayers + 1
        
        -- Update smooth values
        bars.SmoothHealth:Set(lifeforce.Value)
        bars.SmoothPosture:Set(posture.Value)
        local smoothHealth = bars.SmoothHealth:Update(dt)
        local smoothPosture = bars.SmoothPosture:Update(dt)
        
        -- Position bars above head
        local baseX = screenPos.X - CONFIG.BarWidth / 2
        local baseY = screenPos.Y - 50 - (distance / 50)
        
        -- Posture bar (top - yellow)
        local postureBar = bars.Container.PostureBarBg
        postureBar.Position = V2New(baseX, baseY)
        postureBar.Size = V2New(CONFIG.BarWidth, CONFIG.BarHeight)
        postureBar.Visible = true
        
        local postureFill = bars.Container.PostureBar
        postureFill.Position = V2New(baseX, baseY)
        postureFill.Size = V2New(CONFIG.BarWidth * (smoothPosture / 100), CONFIG.BarHeight)
        postureFill.Visible = true
        postureFill.Color = Color3.fromRGB(255, 255, 70)
        
        -- Health bar (bottom - red)
        local healthBar = bars.Container.HealthBarBg
        healthBar.Position = V2New(baseX, baseY + CONFIG.Spacing)
        healthBar.Size = V2New(CONFIG.BarWidth, CONFIG.BarHeight)
        healthBar.Visible = true
        
        local healthFill = bars.Container.HealthBar
        healthFill.Position = V2New(baseX, baseY + CONFIG.Spacing)
        healthFill.Size = V2New(CONFIG.BarWidth * (smoothHealth / 100), CONFIG.BarHeight)
        healthFill.Visible = true
        healthFill.Color = Color3.fromRGB(255, 70, 70)
        
        -- Damage counter with fade effect
        bars.HitTimer = bars.HitTimer - dt
        if bars.HitTimer > 0 then
            local damageText = bars.Container.DamageText
            damageText.Position = V2New(screenPos.X, baseY - 25)
            damageText.Text = "-" .. bars.HitCounter
            damageText.Visible = true
            damageText.Transparency = math.min(1, bars.HitTimer / 2) -- Fade out
        else
            bars.Container.DamageText.Visible = false
            bars.HitCounter = 0
        end
        
        -- Track damage from HealthChanged
        if not bars.HealthConnection then
            bars.HealthConnection = humanoid.HealthChanged:Connect(function(newHealth)
                local oldHealth = humanoid.Health
                local damage = oldHealth - newHealth
                if damage > 0 then
                    bars.HitCounter = bars.HitCounter + math.floor(damage)
                    bars.HitTimer = 2 -- Show for 2 seconds
                end
            end)
            table.insert(HealthSystem.Connections, bars.HealthConnection)
        end
        
        -- Set humanoid display type
        humanoid.HealthDisplayType = Enum.HumanoidHealthDisplayType.AlwaysOn
    end
    
    -- Update menu stats
    if HealthSystem.MenuOpen and HealthSystem.Menu then
        HealthSystem.Menu.StatsText.Text = string.format("Players: %d | Distance: %dm", activePlayers, CONFIG.MaxDistance)
    end
end

-- Toggle system
local function ToggleSystem()
    HealthSystem.Enabled = not HealthSystem.Enabled
    
    if HealthSystem.Menu then
        if HealthSystem.Enabled then
            HealthSystem.Menu.ToggleText.Text = "DISABLE HEALTH BARS"
            HealthSystem.Menu.ToggleBg.Color = Color3.fromRGB(200, 50, 50)
            HealthSystem.Menu.StatusDot.Color = Color3.fromRGB(0, 255, 0)
            HealthSystem.Menu.StatusText.Text = "Status: Enabled"
        else
            HealthSystem.Menu.ToggleText.Text = "ENABLE HEALTH BARS"
            HealthSystem.Menu.ToggleBg.Color = Color3.fromRGB(50, 150, 50)
            HealthSystem.Menu.StatusDot.Color = Color3.fromRGB(255, 0, 0)
            HealthSystem.Menu.StatusText.Text = "Status: Disabled"
            
            -- Hide all bars
            for _, bars in pairs(HealthSystem.PlayerBars) do
                for _, obj in pairs(bars.Container) do
                    obj.Visible = false
                end
            end
        end
    end
    
    print(string.format("[HealthSystem] %s", HealthSystem.Enabled and "Enabled" or "Disabled"))
end

-- Toggle menu
local function ToggleMenu()
    HealthSystem.MenuOpen = not HealthSystem.MenuOpen
    
    if HealthSystem.Menu then
        for _, element in pairs(HealthSystem.Menu) do
            if type(element) == "table" and element.Visible ~= nil then
                element.Visible = HealthSystem.MenuOpen
            end
        end
    end
end

-- Initialize
local function Initialize()
    -- Create menu
    HealthSystem.Menu = CreateMenu()
    
    -- Setup input handling
    local inputBegan = UserInputService.InputBegan:Connect(function(input, processed)
        if processed then return end
        
        if input.KeyCode == CONFIG.ToggleKey then
            ToggleSystem()
        elseif input.KeyCode == Enum.KeyCode.F4 then
            ToggleMenu()
        elseif input.UserInputType == Enum.UserInputType.MouseButton1 and HealthSystem.MenuOpen then
            -- Check if dragging menu
            local mousePos = UserInputService:GetMouseLocation()
            local titleBar = HealthSystem.Menu.TitleBar
            if mousePos.X >= titleBar.Position.X and mousePos.X <= titleBar.Position.X + titleBar.Size.X and
               mousePos.Y >= titleBar.Position.Y and mousePos.Y <= titleBar.Position.Y + titleBar.Size.Y then
                HealthSystem.Dragging = true
                HealthSystem.DragOffset = titleBar.Position - mousePos
            end
            
            -- Check toggle button
            local toggle = HealthSystem.Menu.ToggleBg
            if mousePos.X >= toggle.Position.X and mousePos.X <= toggle.Position.X + toggle.Size.X and
               mousePos.Y >= toggle.Position.Y and mousePos.Y <= toggle.Position.Y + toggle.Size.Y then
                ToggleSystem()
            end
        end
    end)
    table.insert(HealthSystem.Connections, inputBegan)
    
    local inputEnded = UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            HealthSystem.Dragging = false
        end
    end)
    table.insert(HealthSystem.Connections, inputEnded)
    
    local inputChanged = UserInputService.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement and HealthSystem.Dragging and HealthSystem.Menu then
            local mousePos = UserInputService:GetMouseLocation()
            local newPos = mousePos + HealthSystem.DragOffset
            
            -- Clamp to screen
            newPos = V2New(
                math.clamp(newPos.X, 0, Camera.ViewportSize.X - HealthSystem.Menu.Size.X),
                math.clamp(newPos.Y, 0, Camera.ViewportSize.Y - HealthSystem.Menu.Size.Y)
            )
            
            -- Update menu position
            HealthSystem.Menu.Main.Position = newPos
            HealthSystem.Menu.TitleBar.Position = newPos
            HealthSystem.Menu.TitleText.Position = newPos + V2New(10, 5)
            HealthSystem.Menu.ToggleBg.Position = newPos + V2New(10, 40)
            HealthSystem.Menu.ToggleText.Position = newPos + V2New(HealthSystem.Menu.Size.X/2, 57)
            HealthSystem.Menu.StatusDot.Position = newPos + V2New(15, 95)
            HealthSystem.Menu.StatusText.Position = newPos + V2New(30, 87)
            HealthSystem.Menu.StatsText.Position = newPos + V2New(10, 115)
        end
    end)
    table.insert(HealthSystem.Connections, inputChanged)
    
    -- Player added handler
    local playerAdded = Players.PlayerAdded:Connect(function(player)
        if player == LocalPlayer then return end
        
        -- Create bars when character loads
        local function onCharacterAdded(character)
            wait(0.5) -- Wait for character to fully load
            CreatePlayerBars(player)
        end
        
        if player.Character then
            onCharacterAdded(player.Character)
        end
        
        player.CharacterAdded:Connect(onCharacterAdded)
    end)
    table.insert(HealthSystem.Connections, playerAdded)
    
    -- Handle existing players
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            CreatePlayerBars(player)
        end
    end
    
    -- Render loop
    local lastTime = tick()
    RunService.RenderStepped:Connect(function()
        local currentTime = tick()
        local dt = currentTime - lastTime
        lastTime = currentTime
        
        UpdateBars(dt)
    end)
    
    -- Camera change handler
    local cameraChanged = workspace:GetPropertyChangedSignal("CurrentCamera"):Connect(function()
        Camera = workspace.CurrentCamera
        WorldToViewport = function(...) return Camera.WorldToViewportPoint(Camera, ...) end
    end)
    table.insert(HealthSystem.Connections, cameraChanged)
    
    print("[HealthSystem] Initialized successfully")
    print("[HealthSystem] Press F3 to toggle bars, F4 to toggle menu")
end

-- Start the system
local success, err = pcall(Initialize)
if not success then
    warn("[HealthSystem] Failed to initialize: " .. tostring(err))
else
    -- Initial menu state
    HealthSystem.MenuOpen = true
    ToggleMenu() -- Show menu on startup
end

-- Cleanup on script unload
game:GetService("CoreGui").ChildRemoved:Connect(function(child)
    if child.Name == "HealthBarController" then
        Drawings:Clear()
        for _, conn in pairs(HealthSystem.Connections) do
            pcall(function() conn:Disconnect() end)
        end
    end
end)
